<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
      v.7.0 - Adicionado Status "Dispon√≠vel para Retirada"
      - (REQ 6.1) Adicionado novo status 'retirada' entre 'separacao' e 'entregue'.
      - (REQ 6.2) Aba Materiais: Bot√£o "Dispon√≠vel para Retirada" atualiza status para 'retirada'.
      - (REQ 6.3) Aba Materiais: Bot√£o "Entregue" s√≥ aparece se status for 'retirada'.
      - (REQ 6.4) Dashboard (Geral): Adicionado card de contagem "Dispon√≠vel p/ Retirada".
      - (REQ 6.5) Dashboard (Geral): Colunas de Materiais Pendentes mostram 'separacao' e 'retirada' (com destaque verde).
      - (REQ 6.6) Dashboard (Materiais): Lista agora mostra ambos os status pendentes.
    -->
    <title>CONTROLE DE ALMOXARIFADO - SEMCAS (v.7.0 - Status Retirada)</title>
    
    <!-- Scripts e Links -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
    <!-- jsPDF para Relat√≥rios PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js" defer></script>
    <!-- Icones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos -->
    <style>
        :root {
            --primary-blue: #1e40af; /* Azul SEMCAS principal */
            --secondary-blue: #3b82f6; /* Azul SEMCAS secund√°rio */
            --light-blue: #60a5fa; /* Azul SEMCAS claro */
            --success: #10b981; /* Verde sucesso */
            --warning: #f59e0b; /* Amarelo aviso */
            --error: #ef4444; /* Vermelho erro */
            --info: #3b82f6; /* Azul info */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; /* bg-slate-100 */ }
        .header-banner { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 50%, var(--light-blue) 100%); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); color: white; }
        .logo-container { display: flex; align-items: center; gap: 1rem; padding: 1rem; }
        .logo-img { height: 60px; width: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: white; padding: 4px; }
        .main-title { font-size: 1.5rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); line-height: 1.2; margin: 0; }
        .sub-title { font-size: 0.9rem; opacity: 0.9; }
        
        /* Navega√ß√£o */
        .nav-btn { padding: 0.75rem 1rem; border: none; background: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.2s ease; font-weight: 600; color: #475569; white-space: nowrap; }
        .nav-btn:hover { background-color: #f8fafc; }
        .nav-btn.active { color: var(--secondary-blue); border-bottom-color: var(--secondary-blue); }
        .main-nav-container { overflow-x: auto; white-space: nowrap; }
        
        /* Sub-navega√ß√£o interna (√Ågua/G√°s) */
        .sub-nav-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; background: white; cursor: pointer; transition: all 0.2s ease; font-weight: 500; color: #475569; font-size: 0.875rem; }
        .sub-nav-btn:hover { background-color: #f8fafc; }
        .sub-nav-btn.active { background-color: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        
        /* Dashboard Sub-nav */
        .dashboard-nav-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; background: white; cursor: pointer; transition: all 0.2s ease; font-weight: 500; color: #475569; }
        .dashboard-nav-btn:hover { background-color: #f8fafc; }
        .dashboard-nav-btn.active { background-color: var(--primary-blue); color: white; border-color: var(--primary-blue); }

        /* Cards */
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        /* Formul√°rios */
        .form-label { display: block; font-size: 0.875rem; /* text-sm */ font-medium: 600; color: #475569; margin-bottom: 0.25rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; background: white; transition: all 0.2s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--secondary-blue); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .form-textarea { min-height: 80px; }
        .form-input-sm { padding: 0.5rem 0.75rem; /* Ajuste para inputs menores, como filtros */ }
        
        /* Abas dos Formul√°rios de Entrada/Sa√≠da */
        .form-tab-btn { flex: 1; padding: 0.75rem 0.5rem; border: none; background: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.2s ease; font-weight: 600; color: #64748b; font-size: 0.875rem; text-align: center; }
        .form-tab-btn.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }

        /* Bot√µes */
        .btn { padding: 0.75rem 1.5rem; font-weight: 600; border-radius: 0.5rem; transition: all 0.2s ease; cursor: pointer; border: none; }
        .btn-primary { background-color: var(--primary-blue); color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-primary:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; padding: 0.5rem 1rem; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-success { background-color: var(--success); color: white; padding: 0.5rem 1rem; }
        .btn-success:hover { background-color: #059669; }
        .btn-info { background-color: var(--info); color: white; padding: 0.5rem 1rem; } /* (REQ 6.1) Bot√£o Info */
        .btn-info:hover { background-color: #2563eb; }
        .btn-danger { background-color: transparent; color: var(--error); padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-danger:hover { background-color: #fee2e2; }
        .btn-sm { padding: 0.3rem 0.8rem; font-size: 0.8rem; } /* Bot√£o pequeno */
        .btn-icon { background: none; border: none; padding: 0.25rem; color: #64748b; cursor: pointer; line-height: 1; } /* Bot√£o √çcone */
        .btn-icon:hover { color: var(--primary-blue); }
        .btn-icon svg { width: 1em; height: 1em; vertical-align: middle; }
        
        /* Alertas */
        .alert { padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border: 1px solid; display: none; }
        .alert-error { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .alert-success { background: #d1fae5; color: #166534; border-color: #a7f3d0; }
        .alert-warning { background: #fef3c7; color: #92400e; border-color: #fde68a; }
        .alert-info { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        
        /* Tabelas */
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .table th { background: #f9fafb; font-weight: 600; color: #374151; font-size: 0.75rem; text-transform: uppercase; }
        .table tbody tr:hover { background: #f9fafb; }
        .table .form-toggle { height: 1.5rem; width: 1.5rem; cursor: pointer; accent-color: var(--primary-blue); }
        .table .edit-input { padding: 0.25rem 0.5rem; border: 1px solid var(--secondary-blue); border-radius: 0.25rem; font-size: 0.875rem; }
        
        /* Badges */
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge-green { background: #d1fae5; color: #059669; }
        .badge-yellow { background: #fef3c7; color: #d97706; }
        .badge-blue { background: #dbeafe; color: #1e40af; } /* Badge Azul para tipo 'inicial' */
        .badge-red { background: #fee2e2; color: #dc2626; } /* Badge Vermelho para saldo negativo */
        .badge-gray { background: #e5e7eb; color: #4b5563; } /* (REQ 6.1) Badge Cinza para 'entregue' */
        
        /* Loaders */
        .loading-spinner { border: 5px solid #e5e7eb; border-top: 5px solid var(--secondary-blue); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: auto; }
        .loading-spinner-small { border: 3px solid #e5e7eb; border-top: 3px solid var(--secondary-blue); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Gr√°ficos e Listas Dashboard */
        .dashboard-list { max-height: 400px; overflow-y: auto; }
        .chart-container { position: relative; width: 100%; height: 400px; } 
        
        /* Estilos espec√≠ficos para TV (fontes maiores no dashboard) */
        .dashboard-tv-view { /* Classe pai para visualiza√ß√µes do dashboard */ }
        .dashboard-tv-view h3 { font-size: 1.5rem; /* text-2xl */ margin-bottom: 1rem; }
        .dashboard-tv-view .card-value { font-size: 2.5rem; /* text-4xl */ font-weight: 700; line-height: 1; }
        .dashboard-tv-view .card-label { font-size: 1rem; /* text-base */ color: #64748b; }
        .dashboard-tv-view .materiais-prontos-col { background-color: #f8fafc; border-radius: 0.5rem; padding: 1rem; }
        .dashboard-tv-view .materiais-prontos-col h4 { font-size: 1.25rem; font-weight: 600; color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 0.5rem; margin-bottom: 0.75rem; text-align: center; }
        /* (REQ 6.5) Ajustes na lista do dashboard */
        .dashboard-tv-view .materiais-prontos-col h5 { font-size: 0.875rem; font-weight: 600; color: #475569; margin-top: 1rem; margin-bottom: 0.5rem; text-transform: uppercase; text-align: center; }
        .dashboard-tv-view .materiais-prontos-col li { font-size: 1rem; margin-bottom: 0.5rem; line-height: 1.4; padding-bottom: 0.5rem; border-bottom: 1px dashed #e2e8f0; }
        .dashboard-tv-view .materiais-prontos-col li:last-child { border-bottom: none; }
        .dashboard-tv-view .materiais-prontos-col li strong { font-weight: 600; color: #1e293b; }
        .dashboard-tv-view .materiais-prontos-col li span { font-size: 0.875rem; color: #475569; }
        /* (REQ 6.5) Estilo para item "Dispon√≠vel p/ Retirada" no dashboard */
        .dashboard-tv-view .materiais-prontos-col li.item-retirada { border-left: 4px solid var(--success); padding-left: 0.75rem; background-color: #f0fdf4; }
        .dashboard-tv-view .materiais-prontos-col li.item-retirada strong { color: #065f46; }
        .dashboard-tv-view .materiais-prontos-col li.item-retirada .lucide-check-circle { width: 1em; height: 1em; color: var(--success); vertical-align: middle; margin-right: 0.25rem; }


        @media (max-width: 768px) {
            .logo-container { flex-direction: column; text-align: center; gap: 0.75rem; }
            .main-title { font-size: 1.25rem; text-align: center; }
            .logo-img { height: 50px; }
            .sub-header-controls { flex-direction: column; gap: 0.5rem; align-items: stretch; }
            .sub-header-info { text-align: center; }
            .nav-btn { font-size: 0.875rem; padding: 0.75rem 0.5rem; }
            .dashboard-nav-btn { font-size: 0.875rem; padding: 0.5rem; }
            .sub-nav-btn { padding: 0.5rem; }
            /* (REQ 6.4) Ajuste no grid de cards para mobile */
            #dashboard-view-geral .grid-cols-1.md\:grid-cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); } /* 2 colunas no mobile */
            @media (min-width: 768px) { /* Volta a 4 colunas em telas md+ */
                #dashboard-view-geral .grid-cols-1.md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
            }
        }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeInModal 0.3s ease-out; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 0.75rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideInModal 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: #1e293b; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; line-height: 1; padding: 0.5rem; }
        .modal-close:hover { color: #1e293b; }
        .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .modal-footer { border-top: 1px solid #e2e8f0; padding-top: 1rem; margin-top: 1rem; text-align: right; }
        @keyframes fadeInModal { from { background-color: rgba(0,0,0,0); } to { background-color: rgba(0,0,0,0.6); } }
        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-table { font-size: 0.875rem; }
        .modal-table th, .modal-table td { padding: 0.5rem 0.75rem; }
        .lucide-trash-2, .lucide-pencil, .lucide-save, .lucide-x-circle, .lucide-check-circle, .lucide-package-check, .lucide-package { width: 1em; height: 1em; vertical-align: middle; }

        /* ================================================ */
        /* === IN√çCIO: CSS PREVIS√ÉO INTELIGENTE (DO TXT) === */
        /* ================================================ */
        .previsao-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .previsao-option-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .previsao-option-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .previsao-option-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .previsao-resultado-item {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
        }

        .previsao-alerta {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .exclusao-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #fee2e2;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            margin: 0.25rem;
            font-size: 0.875rem;
        }

        .exclusao-item button {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* ============================================== */
        /* === FIM: CSS PREVIS√ÉO INTELIGENTE (DO TXT) === */
        /* ============================================== */
    </style>
</head>
<body class="text-slate-700 antialiased">

    <!-- 1. Header Institucional -->
    <header class="header-banner sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="logo-container">
                <!-- [Imagem do Logo Prefeitura de S√£o Lu√≠s] -->
                <img src="https://www.saoluis.ma.gov.br/img/logo_mobile.png" alt="Logo Prefeitura de S√£o Lu√≠s" class="logo-img" onerror="this.src='https://placehold.co/150x60/ffffff/1e40af?text=SEMCAS'; this.onerror=null;">
                <div class="title-container">
                    <h1 class="main-title">CONTROLE DE ALMOXARIFADO</h1>
                    <p class="sub-title">SEMCAS - Secretaria Municipal da Crian√ßa e Assist√™ncia Social</p>
                </div>
            </div>
        </div>
    </header>

    <!-- 2. Sub-Header de Controles -->
    <div class="bg-white shadow-sm border-b border-slate-200">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center flex-wrap sub-header-controls">
                <div class="flex items-center space-x-4 sub-header-info">
                    <div class="bg-blue-500 text-white p-3 rounded-lg hidden sm:block">
                         <!-- [√çcone de Almoxarifado] -->
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><path d="M19 16h-3m0 0 3-3 3 3m-3 7v-7"/><path d="M18 5V3"/><path d="M7 5V3"/><path d="M12 5V3"/></svg>
                    </div>
                    <div>
                        <h2 class="font-bold text-lg text-slate-800">Sistema de Almoxarifado</h2>
                        <p class="text-sm text-slate-500">v.1.0 by Jurandy Santana</p> <!-- Vers√£o Atualizada -->
                    </div>
                </div>
                <div class="flex items-center space-x-4 text-sm">
                    <!-- Status da Conex√£o com Firebase -->
                    <div id="connectionStatus" class="flex items-center gap-2"></div>
                    <!-- Hor√°rio da √öltima Atualiza√ß√£o -->
                    <p id="last-update-time" class="text-slate-500"></p> 
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Sistema de Navega√ß√£o -->
    <nav class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky z-40 top-[92px] md:top-[88px]">
        <div class="container mx-auto px-4">
            <div class="flex space-x-1 overflow-x-auto main-nav-container">
                <button class="nav-btn active" data-tab="dashboard">üìä Dashboard</button>
                <button class="nav-btn" data-tab="agua">üíß Controle de √Ågua</button>
                <button class="nav-btn" data-tab="gas">üî• Controle de G√°s</button>
                <button class="nav-btn" data-tab="materiais">üöö Entrega de Materiais</button>
                <button class="nav-btn" data-tab="gestao">‚öôÔ∏è Gest√£o de Unidades</button>
                <button class="nav-btn" data-tab="relatorio">üìÑ Gerar Relat√≥rio</button> 
            </div>
        </div>
    </nav>

    <!-- 4. Conte√∫do Principal -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Conte√∫do do Dashboard -->
        <div id="content-dashboard" class="fade-in">
            <!-- Header do Dashboard com Navega√ß√£o -->
            <div class="flex justify-between items-start mb-6 flex-wrap gap-4">
                 <div>
                    <h3 class="text-2xl font-bold text-slate-800">Vis√£o Geral do Almoxarifado</h3>
                    <p class="text-sm text-slate-500 mt-1">A p√°gina atualiza automaticamente a cada 2 minutos.</p>
                 </div>
                 <!-- Navega√ß√£o interna do Dashboard -->
                 <div class="flex flex-wrap gap-2" id="dashboard-nav-controls">
                     <button class="dashboard-nav-btn active" data-view="geral">Vis√£o Geral</button>
                     <button class="dashboard-nav-btn" data-view="agua">üíß √Ågua</button>
                     <button class="dashboard-nav-btn" data-view="gas">üî• G√°s</button>
                     <button class="dashboard-nav-btn" data-view="materiais">üöö Materiais</button>
                 </div>
            </div>
           
            <!-- Container das visualiza√ß√µes do Dashboard -->
            <div class="dashboard-tv-view">
                
                <!-- VIS√ÉO GERAL (NOVA) -->
                <div id="dashboard-view-geral" class="fade-in">
                    
                    <!-- (REQ 6.4) Cards de Estoque - Grid de 3 para 4 colunas -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">üíß Estoque de √Ågua</h3>
                            <p id="dashboard-estoque-agua" class="card-value text-blue-600">0</p>
                            <p class="card-label">Gal√µes Dispon√≠veis</p>
                        </div>
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">üî• Estoque de G√°s</h3>
                            <p id="dashboard-estoque-gas" class="card-value text-orange-600">0</p>
                            <p class="card-label">Botij√µes Dispon√≠veis</p>
                        </div>
                        <!-- (REQ 1) Card "Vazios Pendentes" alterado para "Materiais em Separa√ß√£o" -->
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Em Separa√ß√£o</h3>
                            <p id="dashboard-materiais-separacao-count" class="card-value text-yellow-600">0</p>
                            <p class="card-label">Registros pendentes</p>
                        </div>
                        <!-- (REQ 6.4) Card "Dispon√≠vel para Retirada" -->
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Dispon√≠vel p/ Retirada</h3>
                            <p id="dashboard-materiais-retirada-count" class="card-value text-green-600">0</p>
                            <p class="card-label">Registros prontos</p>
                        </div>
                    </div>

                    <!-- (REQ 6.5) Card de Materiais Pendentes (novo t√≠tulo) -->
                    <div class="card">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Materiais Pendentes</h3>
                        <div id="dashboard-materiais-prontos" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
                            <!-- Colunas (CT, SEDE, CRAS, CREAS, ABRIGO) ser√£o geradas pelo JS -->
                            <div class="text-center p-10 col-span-full" id="loading-materiais-prontos">
                                <div class="loading-spinner-small mx-auto mb-2"></div>
                                <p class="text-sm text-slate-500">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIS√ÉO √ÅGUA -->
                <div id="dashboard-view-agua" class="hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Cards de Resumo √Ågua -->
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Total Pendente (Saldo)</h3>
                            <p id="summary-agua-pendente" class="card-value text-red-600">0</p>
                            <p class="card-label">Gal√µes com as unidades</p>
                        </div>
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Entregues (√öltimos 30 dias)</h3>
                            <p id="summary-agua-entregue" class="card-value text-blue-600">0</p>
                            <p class="card-label">Gal√µes cheios</p>
                        </div>
                         <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Recebidos (√öltimos 30 dias)</h3>
                            <p id="summary-agua-recebido" class="card-value text-green-600">0</p>
                            <p class="card-label">Gal√µes vazios</p>
                        </div>
                    </div>
                    <!-- Gr√°fico de √Ågua -->
                    <div class="card mt-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Controle de √Ågua (√öltimos 30 dias)</h3>
                        <div class="chart-container">
                            <canvas id="dashboardAguaChart"></canvas>
                        </div>
                        <p class="text-xs text-slate-400 mt-2 text-center">Entregues vs Recebidos</p>
                    </div>
                </div>
                
                <!-- VIS√ÉO G√ÅS -->
                <div id="dashboard-view-gas" class="hidden fade-in">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Cards de Resumo G√°s -->
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Total Pendente (Saldo)</h3>
                            <p id="summary-gas-pendente" class="card-value text-red-600">0</p>
                            <p class="card-label">Botij√µes com as unidades</p>
                        </div>
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Entregues (√öltimos 30 dias)</h3>
                            <p id="summary-gas-entregue" class="card-value text-blue-600">0</p>
                            <p class="card-label">Botij√µes cheios</p>
                        </div>
                         <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Recebidos (√öltimos 30 dias)</h3>
                            <p id="summary-gas-recebido" class="card-value text-green-600">0</p>
                            <p class="card-label">Botij√µes vazios</p>
                        </div>
                    </div>
                    <!-- Gr√°fico de G√°s -->
                    <div class="card mt-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Controle de G√°s (√öltimos 30 dias)</h3>
                        <div class="chart-container">
                            <canvas id="dashboardGasChart"></canvas>
                        </div>
                        <p class="text-xs text-slate-400 mt-2 text-center">Entregues vs Recebidos</p>
                    </div>
                </div>
                
                <!-- VIS√ÉO MATERIAIS -->
                <div id="dashboard-view-materiais" class="hidden fade-in">
                    <!-- (REQ 6.6) Lista de Materiais -->
                    <div class="card">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Materiais Pendentes</h3>
                        <div id="dashboard-materiais-list" class="space-y-3 dashboard-list">
                             <div class="text-center p-10" id="loading-materiais-dashboard">
                                <div class="loading-spinner-small mx-auto mb-2"></div>
                                <p class="text-sm text-slate-500">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conte√∫do Controle de √Ågua -->
        <div id="content-agua" class="hidden fade-in">
            <!-- (REQ 4) Sub-navega√ß√£o -->
             <div class="flex flex-wrap gap-2 mb-6" id="sub-nav-agua">
                 <button class="sub-nav-btn active" data-subview="movimentacao-agua">Lan√ßamentos / Status</button>
                 <button class="sub-nav-btn" data-subview="previsao-agua">Previs√£o</button>
             </div>

            <!-- (REQ 4) Subview Movimenta√ß√£o -->
            <div id="subview-movimentacao-agua">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    
                    <!-- Card: Resumo do Estoque -->
                    <div class="lg:col-span-1 card bg-blue-50">
                        <h2 class="text-xl font-bold text-blue-800 mb-4">Estoque de √Ågua</h2>
                        
                        <!-- Form Estoque Inicial (Condicional) -->
                        <div id="form-inicial-agua-container" class="hidden bg-white p-4 rounded-md border border-blue-200 mb-4">
                            <h3 class="text-sm font-semibold mb-2 text-blue-700">Ponta-p√© Inicial</h3>
                            <p class="text-xs text-slate-500 mb-3">Informe a quantidade inicial para come√ßar.</p>
                            <form id="form-inicial-agua">
                                <div class="mb-2">
                                    <label for="input-inicial-qtd-agua" class="form-label text-xs">Qtd. Inicial</label>
                                    <input type="number" id="input-inicial-qtd-agua" class="form-input form-input-sm py-1 px-2 text-sm" min="0" value="0" required>
                                </div>
                                <div class="mb-3">
                                     <label for="input-inicial-responsavel-agua" class="form-label text-xs">Respons√°vel</label>
                                     <input type="text" id="input-inicial-responsavel-agua" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Seu nome" required>
                                </div>
                                <button type="submit" id="btn-submit-inicial-agua" class="btn btn-primary btn-sm w-full">Salvar Inicial</button>
                            </form>
                            <div id="alert-inicial-agua" class="alert mt-3 text-xs p-2"></div>
                        </div>

                        <!-- Bot√£o para abrir form inicial (Condicional) -->
                        <button id="btn-abrir-inicial-agua" class="btn btn-secondary btn-sm w-full mb-4 hidden">Definir Estoque Inicial</button>

                        <!-- Resumo Normal -->
                        <ul id="resumo-estoque-agua" class="space-y-3 text-sm hidden">
                            <li class="flex justify-between items-center">
                                <span class="text-slate-600">Estoque Inicial:</span>
                                <strong id="estoque-agua-inicial" class="text-lg">0</strong>
                            </li>
                            <li class="flex justify-between items-center">
                                <span class="text-slate-600">Total de Entradas:</span>
                                <strong id="estoque-agua-entradas" class="text-lg text-green-600">+0</strong>
                            </li>
                            <li class="flex justify-between items-center">
                                <span class="text-slate-600">Total de Sa√≠das:</span>
                                <strong id="estoque-agua-saidas" class="text-lg text-red-600">-0</strong>
                            </li>
                            <li class="flex justify-between items-center text-lg font-bold border-t pt-2 mt-2 border-blue-200">
                                <span class="text-blue-900">Dispon√≠vel:</span>
                                <strong id="estoque-agua-atual" class="text-2xl text-blue-900">0</strong>
                            </li>
                        </ul>
                        <div id="loading-estoque-agua" class="text-center py-4">
                            <div class="loading-spinner-small mx-auto"></div>
                        </div>
                    </div>

                    <!-- Coluna de Lan√ßamento (com abas) -->
                    <div class="lg:col-span-1 card">
                        <!-- Abas de Sa√≠da/Entrada -->
                        <div class="flex border-b mb-4 -mx-6 px-2">
                            <button class="form-tab-btn active" data-form="saida-agua">üíß Sa√≠da (Unidades)</button>
                            <button class="form-tab-btn" data-form="entrada-agua">üì• Entrada (Estoque)</button>
                        </div>

                        <!-- Form 1: Sa√≠da (Movimenta√ß√£o Unidades) -->
                        <form id="form-agua" class="">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Lan√ßar Movimenta√ß√£o (√Ågua)</h2>
                            <div class="mb-4">
                                <label for="select-unidade-agua" class="form-label">Unidade (Apenas habilitadas)</label>
                                <select id="select-unidade-agua" class="form-select" required></select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="select-tipo-agua" class="form-label">Tipo de Movimenta√ß√£o</label>
                                <select id="select-tipo-agua" class="form-select" required>
                                    <option value="troca">Troca (Entregar Cheio / Receber Vazio)</option>
                                    <option value="entrega">Apenas Sa√≠da (Entregar Cheio)</option>
                                    <option value="retorno">Apenas Retorno (Receber Vazio)</option>
                                </select>
                            </div>
                            
                            <div class="mb-4" id="form-group-qtd-entregue-agua">
                                <label for="input-qtd-entregue-agua" class="form-label">Qtd. Entregue (Cheio)</label>
                                <input type="number" id="input-qtd-entregue-agua" class="form-input" min="0" value="0" required>
                            </div>

                            <div class="mb-4 hidden" id="form-group-qtd-retorno-agua">
                                <label for="input-qtd-retorno-agua" class="form-label">Qtd. Recebida (Vazio)</label>
                                <input type="number" id="input-qtd-retorno-agua" class="form-input" min="0" value="0" required>
                            </div>

                            <div class="mb-4">
                                <label for="input-data-agua" class="form-label">Data</label>
                                <input type="date" id="input-data-agua" class="form-input" required>
                            </div>
                            <div class="mb-4">
                                 <label for="input-responsavel-agua" class="form-label">Respons√°vel (Unidade)</label>
                                 <input type="text" id="input-responsavel-agua" class="form-input" placeholder="Nome de quem recebeu/entregou" required>
                            </div>
                            <button type="submit" id="btn-submit-agua" class="btn btn-primary w-full">Salvar Movimenta√ß√£o</button>
                        </form>

                        <!-- Form 2: Entrada (Estoque) -->
                        <form id="form-entrada-agua" class="hidden">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Dar Entrada no Estoque (√Ågua)</h2>
                            <div class="mb-4">
                                <label for="input-qtd-entrada-agua" class="form-label">Quantidade</label>
                                <input type="number" id="input-qtd-entrada-agua" class="form-input" min="1" value="1" required>
                            </div>
                            <div class="mb-4">
                                <label for="input-data-entrada-agua" class="form-label">Data da Entrada</label>
                                <input type="date" id="input-data-entrada-agua" class="form-input" required>
                            </div>
                            <div class="mb-4">
                                 <label for="input-responsavel-entrada-agua" class="form-label">Recebido por (Almoxarifado)</label>
                                 <input type="text" id="input-responsavel-entrada-agua" class="form-input" placeholder="Nome de quem recebeu" required>
                            </div>
                             <div class="mb-4">
                                 <label for="input-nf-entrada-agua" class="form-label">Nota Fiscal (Opcional)</label>
                                 <input type="text" id="input-nf-entrada-agua" class="form-input" placeholder="N¬∫ da Nota Fiscal">
                            </div>
                            <button type="submit" id="btn-submit-entrada-agua" class="btn btn-primary w-full">Salvar Entrada</button>
                        </form>

                        <div id="alert-agua" class="alert mt-4"></div>
                    </div>
                    
                    <!-- Coluna de Status e Hist√≥rico -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Card Status (Pendentes) -->
                        <div class="card">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Status de Gal√µes (Saldo nas Unidades)</h2>
                            <p class="text-sm text-slate-500 mb-2">Lista de unidades e saldo de gal√µes. Passe o mouse na linha para ver o √∫ltimo respons√°vel.</p>
                            <div id="alert-agua-lista" class="alert mb-4"></div>
                            
                            <div class="mb-4">
                                <label for="filtro-status-agua" class="form-label text-xs">Buscar Unidade:</label>
                                <input type="text" id="filtro-status-agua" data-table="table-status-agua" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Digite o nome da unidade...">
                            </div>

                            <div class="overflow-x-auto">
                                <table class="table w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th>Unidade</th>
                                            <th>Tipo</th>
                                            <th>Entregues</th>
                                            <th>Recebidos</th>
                                            <th>Saldo (Vazios)</th> 
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-status-agua">
                                        <tr><td colspan="6" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Card: Hist√≥rico de Entradas -->
                         <div class="card">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Hist√≥rico de Entradas no Estoque (√Ågua)</h2>
                            <div id="alert-historico-agua" class="alert mb-4"></div>
                            
                            <div class="mb-4">
                                <label for="filtro-historico-agua" class="form-label text-xs">Buscar no Hist√≥rico:</label>
                                <input type="text" id="filtro-historico-agua" data-table="table-historico-agua" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Buscar por data, respons√°vel, NF...">
                            </div>

                            <div class="overflow-x-auto max-h-96">
                                <table class="table w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Tipo</th>
                                            <th>Qtd.</th>
                                            <th>Respons√°vel</th>
                                            <th>NF</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-historico-agua">
                                        <tr><td colspan="6" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div> <!-- Fim Subview Movimenta√ß√£o √Ågua -->

            <!-- (REQ 4) Subview Previs√£o √Ågua -->
            <!-- ======================================================== -->
            <!-- === IN√çCIO: HTML PREVIS√ÉO √ÅGUA SUBSTITU√çDO (DO TXT) === -->
            <!-- ======================================================== -->
            <div id="subview-previsao-agua" class="hidden">
                <div class="card max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">
                        üîÆ Previs√£o Inteligente de Consumo - √Ågua
                    </h2>
                    <p class="text-sm text-slate-500 mb-6">
                        Calcule previs√µes precisas baseadas no hist√≥rico de consumo para planejar compras e garantir abastecimento suficiente.
                    </p>

                    <!-- ETAPA 1: Selecionar Modo -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-slate-700 mb-3">1. Selecione o modo de previs√£o:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="previsao-option-card" data-modo="unidade-especifica" onclick="selecionarModoPrevisao('agua', 'unidade-especifica')">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="bg-blue-100 p-2 rounded-full">
                                        <i data-lucide="building" class="text-blue-600"></i>
                                    </div>
                                    <h4 class="font-bold text-slate-800">Unidade Espec√≠fica</h4>
                                </div>
                                <p class="text-sm text-slate-600">Previs√£o detalhada para uma unidade individual</p>
                            </div>

                            <div class="previsao-option-card" data-modo="por-tipo" onclick="selecionarModoPrevisao('agua', 'por-tipo')">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="bg-green-100 p-2 rounded-full">
                                        <i data-lucide="layers" class="text-green-600"></i>
                                    </div>
                                    <h4 class="font-bold text-slate-800">Por Tipo</h4>
                                </div>
                                <p class="text-sm text-slate-600">Previs√£o para todas as unidades de um tipo</p>
                            </div>

                            <div class="previsao-option-card" data-modo="completo" onclick="selecionarModoPrevisao('agua', 'completo')">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="bg-purple-100 p-2 rounded-full">
                                        <i data-lucide="globe" class="text-purple-600"></i>
                                    </div>
                                    <h4 class="font-bold text-slate-800">Completo</h4>
                                </div>
                                <p class="text-sm text-slate-600">Previs√£o total para todas as unidades</p>
                            </div>
                        </div>
                    </div>

                    <!-- ETAPA 2: Configura√ß√µes -->
                    <div id="config-previsao-agua" class="hidden mb-6">
                        <h3 class="font-semibold text-slate-700 mb-3">2. Configure sua previs√£o:</h3>

                        <div id="select-unidade-container-agua" class="hidden mb-4">
                            <label for="select-previsao-unidade-agua-v2" class="form-label">Selecione a Unidade:</label>
                            <select id="select-previsao-unidade-agua-v2" class="form-select"></select>
                        </div>

                        <!-- (REQ 5.1) Select de tipo agora √© din√¢mico -->
                        <div id="select-tipo-container-agua" class="hidden mb-4">
                            <label for="select-previsao-tipo-agua" class="form-label">Selecione o Tipo:</label>
                            <select id="select-previsao-tipo-agua" class="form-select">
                                <option value="">-- Carregando tipos... --</option> 
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="dias-previsao-agua" class="form-label">Per√≠odo da Previs√£o (dias):</label>
                                <input type="number" id="dias-previsao-agua" class="form-input" min="1" value="7">
                            </div>
                            <div>
                                <label for="margem-seguranca-agua" class="form-label">Margem de Seguran√ßa (%):</label>
                                <input type="number" id="margem-seguranca-agua" class="form-input" min="0" max="100" value="15">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Excluir Unidades do C√°lculo (opcional)</label>
                            <div id="exclusao-container-agua" class="mb-2">
                                <select id="select-exclusao-agua" class="form-select mb-2">
                                    <option value="">-- Selecione para excluir --</option>
                                </select>
                                <button type="button" onclick="adicionarExclusao('agua')" class="btn btn-secondary btn-sm">
                                    + Adicionar Exclus√£o
                                </button>
                            </div>
                            <div id="lista-exclusoes-agua" class="flex flex-wrap gap-2 mt-2"></div>
                        </div>
                    </div>

                    <!-- ETAPA 3: Calcular -->
                    <div class="text-center mb-6">
                        <button id="btn-calcular-previsao-agua-v2" class="btn btn-primary btn-lg px-8" onclick="calcularPrevisaoInteligente('agua')">
                            <i data-lucide="calculator"></i>
                            Calcular Previs√£o
                        </button>
                    </div>

                    <!-- RESULTADOS -->
                    <div id="resultado-previsao-agua-v2" class="hidden">
                        <div class="previsao-card mb-6">
                            <h3 class="text-xl font-bold mb-4">üìä Resultados da Previs√£o</h3>
                            <div id="resultado-content-agua"></div>
                        </div>

                        <div class="card mt-4">
                            <h4 class="font-semibold text-slate-700 mb-3">üìà Tend√™ncia de Consumo</h4>
                            <canvas id="grafico-previsao-agua" style="height: 200px;"></canvas>
                        </div>

                        <div id="alertas-previsao-agua" class="mt-4"></div>
                    </div>
                </div>
            </div>
            <!-- ====================================================== -->
            <!-- === FIM: HTML PREVIS√ÉO √ÅGUA SUBSTITU√çDO (DO TXT) === -->
            <!-- ====================================================== -->
            <!-- Fim Subview Previs√£o √Ågua -->

        </div> <!-- Fim Content √Ågua -->

        <!-- Conte√∫do Controle de G√°s -->
        <div id="content-gas" class="hidden fade-in">
             <!-- (REQ 4) Sub-navega√ß√£o -->
             <div class="flex flex-wrap gap-2 mb-6" id="sub-nav-gas">
                 <button class="sub-nav-btn active" data-subview="movimentacao-gas">Lan√ßamentos / Status</button>
                 <button class="sub-nav-btn" data-subview="previsao-gas">Previs√£o</button>
             </div>

            <!-- (REQ 4) Subview Movimenta√ß√£o G√°s -->
            <div id="subview-movimentacao-gas">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    
                    <!-- Card: Resumo do Estoque G√°s -->
                    <div class="lg:col-span-1 card bg-orange-50">
                        <h2 class="text-xl font-bold text-orange-800 mb-4">Estoque de G√°s</h2>
                         
                        <!-- Form Estoque Inicial (Condicional) -->
                        <div id="form-inicial-gas-container" class="hidden bg-white p-4 rounded-md border border-orange-200 mb-4">
                            <h3 class="text-sm font-semibold mb-2 text-orange-700">Ponta-p√© Inicial</h3>
                            <p class="text-xs text-slate-500 mb-3">Informe a quantidade inicial para come√ßar.</p>
                            <form id="form-inicial-gas">
                                <div class="mb-2">
                                    <label for="input-inicial-qtd-gas" class="form-label text-xs">Qtd. Inicial</label>
                                    <input type="number" id="input-inicial-qtd-gas" class="form-input form-input-sm py-1 px-2 text-sm" min="0" value="0" required>
                                </div>
                                <div class="mb-3">
                                     <label for="input-inicial-responsavel-gas" class="form-label text-xs">Respons√°vel</label>
                                     <input type="text" id="input-inicial-responsavel-gas" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Seu nome" required>
                                </div>
                                <button type="submit" id="btn-submit-inicial-gas" class="btn btn-primary btn-sm w-full">Salvar Inicial</button>
                            </form>
                             <div id="alert-inicial-gas" class="alert mt-3 text-xs p-2"></div>
                        </div>

                        <!-- Bot√£o para abrir form inicial (Condicional) -->
                        <button id="btn-abrir-inicial-gas" class="btn btn-secondary btn-sm w-full mb-4 hidden">Definir Estoque Inicial</button>
                         
                        <!-- Resumo Normal -->
                        <ul id="resumo-estoque-gas" class="space-y-3 text-sm hidden">
                            <li class="flex justify-between items-center">
                                <span class="text-slate-600">Estoque Inicial:</span>
                                <strong id="estoque-gas-inicial" class="text-lg">0</strong>
                            </li>
                            <li class="flex justify-between items-center">
                                <span class="text-slate-600">Total de Entradas:</span>
                                <strong id="estoque-gas-entradas" class="text-lg text-green-600">+0</strong>
                            </li>
                            <li class="flex justify-between items-center">
                                <span class="text-slate-600">Total de Sa√≠das:</span>
                                <strong id="estoque-gas-saidas" class="text-lg text-red-600">-0</strong>
                            </li>
                            <li class="flex justify-between items-center text-lg font-bold border-t pt-2 mt-2 border-orange-200">
                                <span class="text-orange-900">Dispon√≠vel:</span>
                                <strong id="estoque-gas-atual" class="text-2xl text-orange-900">0</strong>
                            </li>
                        </ul>
                        <div id="loading-estoque-gas" class="text-center py-4">
                            <div class="loading-spinner-small mx-auto"></div>
                        </div>
                    </div>

                    <!-- Coluna de Lan√ßamento (com abas) -->
                    <div class="lg:col-span-1 card">
                        <!-- Abas de Sa√≠da/Entrada -->
                        <div class="flex border-b mb-4 -mx-6 px-2">
                            <button class="form-tab-btn active" data-form="saida-gas">üî• Sa√≠da (Unidades)</button>
                            <button class="form-tab-btn" data-form="entrada-gas">üì• Entrada (Estoque)</button>
                        </div>

                        <!-- Form 1: Sa√≠da (Movimenta√ß√£o Unidades) -->
                        <form id="form-gas" class="">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Lan√ßar Movimenta√ß√£o (G√°s)</h2>
                            <div class="mb-4">
                                <label for="select-unidade-gas" class="form-label">Unidade (Apenas habilitadas)</label>
                                <select id="select-unidade-gas" class="form-select" required></select>
                            </div>
                            
                            <div class="mb-4">
                                <label for="select-tipo-gas" class="form-label">Tipo de Movimenta√ß√£o</label>
                                <select id="select-tipo-gas" class="form-select" required>
                                    <option value="troca">Troca (Entregar Cheio / Receber Vazio)</option>
                                    <option value="entrega">Apenas Sa√≠da (Entregar Cheio)</option>
                                    <option value="retorno">Apenas Retorno (Receber Vazio)</option>
                                </select>
                            </div>

                            <div class="mb-4" id="form-group-qtd-entregue-gas">
                                <label for="input-qtd-entregue-gas" class="form-label">Qtd. Entregue (Cheio)</label>
                                <input type="number" id="input-qtd-entregue-gas" class="form-input" min="0" value="0" required>
                            </div>
                            
                            <div class="mb-4 hidden" id="form-group-qtd-retorno-gas">
                                <label for="input-qtd-retorno-gas" class="form-label">Qtd. Recebida (Vazio)</label>
                                <input type="number" id="input-qtd-retorno-gas" class="form-input" min="0" value="0" required>
                            </div>
                            
                             <div class="mb-4">
                                <label for="input-data-gas" class="form-label">Data</label>
                                <input type="date" id="input-data-gas" class="form-input" required>
                            </div>
                             <div class="mb-4">
                                 <label for="input-responsavel-gas" class="form-label">Respons√°vel (Unidade)</label>
                                 <input type="text" id="input-responsavel-gas" class="form-input" placeholder="Nome de quem recebeu/entregou" required>
                            </div>
                            <button type="submit" id="btn-submit-gas" class="btn btn-primary w-full">Salvar Movimenta√ß√£o</button>
                        </form>

                        <!-- Form 2: Entrada (Estoque) -->
                        <form id="form-entrada-gas" class="hidden">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Dar Entrada no Estoque (G√°s)</h2>
                            <div class="mb-4">
                                <label for="input-qtd-entrada-gas" class="form-label">Quantidade</label>
                                <input type="number" id="input-qtd-entrada-gas" class="form-input" min="1" value="1" required>
                            </div>
                            <div class="mb-4">
                                <label for="input-data-entrada-gas" class="form-label">Data da Entrada</label>
                                <input type="date" id="input-data-entrada-gas" class="form-input" required>
                            </div>
                            <div class="mb-4">
                                 <label for="input-responsavel-entrada-gas" class="form-label">Recebido por (Almoxarifado)</label>
                                 <input type="text" id="input-responsavel-entrada-gas" class="form-input" placeholder="Nome de quem recebeu" required>
                            </div>
                             <div class="mb-4">
                                 <label for="input-nf-entrada-gas" class="form-label">Nota Fiscal (Opcional)</label>
                                 <input type="text" id="input-nf-entrada-gas" class="form-input" placeholder="N¬∫ da Nota Fiscal">
                            </div>
                            <button type="submit" id="btn-submit-entrada-gas" class="btn btn-primary w-full">Salvar Entrada</button>
                        </form>

                        <div id="alert-gas" class="alert mt-4"></div>
                    </div>
                    
                    <!-- Coluna de Status e Hist√≥rico -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Card Status G√°s -->
                        <div class="card">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Status de Botij√µes (Saldo nas Unidades)</h2>
                            <p class="text-sm text-slate-500 mb-2">Lista de unidades e saldo de botij√µes. Passe o mouse na linha para ver o √∫ltimo respons√°vel.</p>
                            <div id="alert-gas-lista" class="alert mb-4"></div>

                            <div class="mb-4">
                                <label for="filtro-status-gas" class="form-label text-xs">Buscar Unidade:</label>
                                <input type="text" id="filtro-status-gas" data-table="table-status-gas" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Digite o nome da unidade...">
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="table w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th>Unidade</th>
                                            <th>Tipo</th>
                                            <th>Entregues</th>
                                            <th>Recebidos</th>
                                            <th>Saldo (Vazios)</th> 
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-status-gas">
                                        <tr><td colspan="6" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Card: Hist√≥rico de Entradas G√°s -->
                         <div class="card">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Hist√≥rico de Entradas no Estoque (G√°s)</h2>
                            <div id="alert-historico-gas" class="alert mb-4"></div>
                            
                            <div class="mb-4">
                                <label for="filtro-historico-gas" class="form-label text-xs">Buscar no Hist√≥rico:</label>
                                <input type="text" id="filtro-historico-gas" data-table="table-historico-gas" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Buscar por data, respons√°vel, NF...">
                            </div>

                            <div class="overflow-x-auto max-h-96">
                                <table class="table w-full text-sm">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Tipo</th>
                                            <th>Qtd.</th>
                                            <th>Respons√°vel</th>
                                            <th>NF</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-historico-gas">
                                        <tr><td colspan="6" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div> <!-- Fim Subview Movimenta√ß√£o G√°s -->
            
            <!-- (REQ 4) Subview Previs√£o G√°s -->
            <!-- ======================================================= -->
            <!-- === IN√çCIO: HTML PREVIS√ÉO G√ÅS SUBSTITU√çDO (DO TXT) === -->
            <!-- ======================================================= -->
            <div id="subview-previsao-gas" class="hidden">
                <div class="card max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">
                        üîÆ Previs√£o Inteligente de Consumo - G√°s
                    </h2>
                    <p class="text-sm text-slate-500 mb-6">
                        Calcule previs√µes precisas baseadas no hist√≥rico de consumo para planejar compras e garantir abastecimento suficiente.
                    </p>

                    <div class="mb-6">
                        <h3 class="font-semibold text-slate-700 mb-3">1. Selecione o modo de previs√£o:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="previsao-option-card" data-modo="unidade-especifica" onclick="selecionarModoPrevisao('gas', 'unidade-especifica')">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="bg-blue-100 p-2 rounded-full">
                                        <i data-lucide="building" class="text-blue-600"></i>
                                    </div>
                                    <h4 class="font-bold text-slate-800">Unidade Espec√≠fica</h4>
                                </div>
                                <p class="text-sm text-slate-600">Previs√£o detalhada para uma unidade individual</p>
                            </div>

                            <div class="previsao-option-card" data-modo="por-tipo" onclick="selecionarModoPrevisao('gas', 'por-tipo')">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="bg-green-100 p-2 rounded-full">
                                        <i data-lucide="layers" class="text-green-600"></i>
                                    </div>
                                    <h4 class="font-bold text-slate-800">Por Tipo</h4>
                                </div>
                                <p class="text-sm text-slate-600">Previs√£o para todas as unidades de um tipo</p>
                            </div>

                            <div class="previsao-option-card" data-modo="completo" onclick="selecionarModoPrevisao('gas', 'completo')">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="bg-purple-100 p-2 rounded-full">
                                        <i data-lucide="globe" class="text-purple-600"></i>
                                    </div>
                                    <h4 class="font-bold text-slate-800">Completo</h4>
                                </div>
                                <p class="text-sm text-slate-600">Previs√£o total para todas as unidades</p>
                            </div>
                        </div>
                    </div>

                    <div id="config-previsao-gas" class="hidden mb-6">
                        <h3 class="font-semibold text-slate-700 mb-3">2. Configure sua previs√£o:</h3>

                        <div id="select-unidade-container-gas" class="hidden mb-4">
                            <label for="select-previsao-unidade-gas-v2" class="form-label">Selecione a Unidade:</label>
                            <select id="select-previsao-unidade-gas-v2" class="form-select"></select>
                        </div>

                        <!-- (REQ 5.1) Select de tipo agora √© din√¢mico -->
                        <div id="select-tipo-container-gas" class="hidden mb-4">
                            <label for="select-previsao-tipo-gas" class="form-label">Selecione o Tipo:</label>
                            <select id="select-previsao-tipo-gas" class="form-select">
                               <option value="">-- Carregando tipos... --</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="dias-previsao-gas" class="form-label">Per√≠odo da Previs√£o (dias):</label>
                                <input type="number" id="dias-previsao-gas" class="form-input" min="1" value="7">
                            </div>
                            <div>
                                <label for="margem-seguranca-gas" class="form-label">Margem de Seguran√ßa (%):</label>
                                <input type="number" id="margem-seguranca-gas" class="form-input" min="0" max="100" value="15">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Excluir Unidades do C√°lculo (opcional)</label>
                            <div id="exclusao-container-gas" class="mb-2">
                                <select id="select-exclusao-gas" class="form-select mb-2">
                                    <option value="">-- Selecione para excluir --</option>
                                </select>
                                <button type="button" onclick="adicionarExclusao('gas')" class="btn btn-secondary btn-sm">
                                    + Adicionar Exclus√£o
                                </button>
                            </div>
                            <div id="lista-exclusoes-gas" class="flex flex-wrap gap-2 mt-2"></div>
                        </div>
                    </div>

                    <div class="text-center mb-6">
                        <button id="btn-calcular-previsao-gas-v2" class="btn btn-primary btn-lg px-8" onclick="calcularPrevisaoInteligente('gas')">
                            <i data-lucide="calculator"></i>
                            Calcular Previs√£o
                        </button>
                    </div>

                    <div id="resultado-previsao-gas-v2" class="hidden">
                        <div class="previsao-card mb-6">
                            <h3 class="text-xl font-bold mb-4">üìä Resultados da Previs√£o</h3>
                            <div id="resultado-content-gas"></div>
                        </div>

                        <div class="card mt-4">
                            <h4 class="font-semibold text-slate-700 mb-3">üìà Tend√™ncia de Consumo</h4>
                            <canvas id="grafico-previsao-gas" style="height: 200px;"></canvas>
                        </div>

                        <div id="alertas-previsao-gas" class="mt-4"></div>
                    </div>
                </div>
            </div>
            <!-- ===================================================== -->
            <!-- === FIM: HTML PREVIS√ÉO G√ÅS SUBSTITU√çDO (DO TXT) === -->
            <!-- ===================================================== -->
            <!-- Fim Subview Previs√£o G√°s -->

        </div> <!-- Fim Content G√°s -->

        <!-- Conte√∫do Entrega de Materiais -->
        <div id="content-materiais" class="hidden fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Coluna de Lan√ßamento -->
                <div class="lg:col-span-1 card">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Registrar Separa√ß√£o de Material</h2>
                    <form id="form-materiais">
                        <div class="mb-4">
                            <label for="select-unidade-materiais" class="form-label">Unidade (Apenas habilitadas)</label>
                            <select id="select-unidade-materiais" class="form-select" required></select>
                        </div>
                        <div class="mb-4">
                            <label for="select-tipo-materiais" class="form-label">Tipo de Material</label>
                            <select id="select-tipo-materiais" class="form-select" required>
                                <option value="alimento">Alimento</option>
                                <option value="expediente">Expediente</option>
                                <option value="limpeza">Limpeza</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="input-data-separacao" class="form-label">Data da Separa√ß√£o</label>
                            <input type="date" id="input-data-separacao" class="form-input" required>
                        </div>
                        
                        <div class="mb-4">
                             <label for="textarea-itens-materiais" class="form-label">Observa√ß√£o:</label>
                             <textarea id="textarea-itens-materiais" class="form-textarea" placeholder="Alguma observa√ß√£o sobre esta separa√ß√£o... (Opcional)"></textarea>
                        </div>

                         <div class="mb-4">
                             <label for="input-responsavel-materiais" class="form-label">Respons√°vel (Separa√ß√£o)</label>
                             <input type="text" id="input-responsavel-materiais" class="form-input" placeholder="Nome de quem separou" required>
                        </div>
                        <button type="submit" id="btn-submit-materiais" class="btn btn-primary w-full">Registrar Separa√ß√£o</button>
                    </form>
                    <div id="alert-materiais" class="alert mt-4"></div>
                </div>
                
                <!-- (REQ 6.2) Coluna de Status (T√≠tulo atualizado) -->
                <div class="lg:col-span-2 card">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Status dos Materiais</h2>
                    <p class="text-sm text-slate-500 mb-4">Controle de materiais em separa√ß√£o, dispon√≠veis para retirada e j√° entregues.</p>
                    <div id="alert-materiais-lista" class="alert mb-4"></div>
                    <div class="overflow-x-auto">
                        <table class="table w-full text-sm">
                            <thead>
                                <tr>
                                    <th>Unidade</th>
                                    <th>Tipo</th>
                                    <th>Data Separa√ß√£o</th>
                                    <th>Status</th>
                                    <th class="text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="table-status-materiais">
                               <tr><td colspan="5" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conte√∫do Gest√£o de Unidades -->
        <div id="content-gestao" class="hidden fade-in">
            <div class="card max-w-4xl mx-auto">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Gest√£o de Unidades de Atendimento</h2>
                <div id="alert-gestao" class="alert mb-4"></div>

                <!-- Se√ß√£o de Adicionar Novas Unidades -->
                <div class="mb-8 p-4 border border-slate-200 rounded-lg bg-slate-50">
                     <h3 class="font-semibold text-slate-700 mb-2">Adicionar Novas Unidades</h3>
                     <p class="text-sm text-slate-500 mb-3">Cole aqui a lista de unidades (uma por linha) no formato: <strong>Tipo [TAB] Nome da Unidade</strong>. Exemplo:</p>
                     <pre class="text-xs bg-white p-2 rounded border border-slate-300 mb-3">CRAS	Anjo da Guarda<br>CREAS	Centro</pre>
                     <textarea id="textarea-bulk-unidades" class="form-textarea mb-3" rows="5" placeholder="Cole os dados aqui..."></textarea>
                     <button id="btn-bulk-add-unidades" class="btn btn-primary">Adicionar Unidades</button>
                </div>

                <!-- Tabela de Gest√£o Existente -->
                <h3 class="font-semibold text-slate-700 mb-2">Habilitar Servi√ßos por Unidade</h3>
                <p class="text-sm text-slate-500 mb-4">Marque as caixas para habilitar/desabilitar servi√ßos. Clique no l√°pis para editar o nome.</p>
                
                <!-- Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="filtro-unidade-nome" class="form-label text-xs">Filtrar por Nome:</label>
                        <input type="text" id="filtro-unidade-nome" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Digite parte do nome...">
                    </div>
                    <div>
                        <label for="filtro-unidade-tipo" class="form-label text-xs">Filtrar por Tipo:</label>
                        <input type="text" id="filtro-unidade-tipo" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Digite o tipo (ex: CRAS)...">
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="table w-full text-sm">
                        <thead>
                            <tr>
                                <th>Unidade</th>
                                <th>Tipo</th>
                                <th class="text-center">üíß √Ågua</th>
                                <th class="text-center">üî• G√°s</th>
                                <th class="text-center">üöö Materiais</th>
                                <th class="text-center">A√ß√µes</th> <!-- Colspan ajustado para A√ß√µes -->
                            </tr>
                        </thead>
                        <tbody id="table-gestao-unidades">
                             <tr><td colspan="6" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr> 
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Conte√∫do Gerar Relat√≥rio -->
        <div id="content-relatorio" class="hidden fade-in">
            <div class="card max-w-2xl mx-auto">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Gerar Relat√≥rio em PDF</h2>
                <p class="text-sm text-slate-500 mb-6">Selecione o tipo de relat√≥rio e o per√≠odo desejado. O relat√≥rio ser√° gerado e baixado automaticamente.</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="relatorio-tipo" class="form-label">Tipo de Relat√≥rio</label>
                        <select id="relatorio-tipo" class="form-select">
                            <option value="agua">üíß Fornecimento de √Ågua</option>
                            <option value="gas">üî• Fornecimento de G√°s</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="relatorio-data-inicio" class="form-label">Data In√≠cio</label>
                            <input type="date" id="relatorio-data-inicio" class="form-input" required>
                        </div>
                        <div>
                            <label for="relatorio-data-fim" class="form-label">Data Fim</label>
                            <input type="date" id="relatorio-data-fim" class="form-input" required>
                        </div>
                    </div>
                    <button id="btn-gerar-pdf" class="btn btn-primary w-full">Gerar Relat√≥rio PDF</button>
                </div>
                <div id="alert-relatorio" class="alert mt-4"></div>
            </div>
        </div>


    </main>

    <!-- 5. Rodap√© -->
    <footer class="text-center mt-12 mb-6 text-sm text-slate-500">
        <p>Jurandy Santana</p>
    </footer>
    

     <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="confirm-delete-modal" class="modal">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h2 class="modal-title text-red-600">Confirmar Exclus√£o</h2>
          <button class="modal-close" onclick="document.getElementById('confirm-delete-modal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
            <p>Tem certeza que deseja remover este item? Esta a√ß√£o n√£o pode ser desfeita.</p>
             <p class="text-sm mt-2 text-yellow-700 bg-yellow-100 p-2 rounded border border-yellow-300" id="delete-warning-unidade" style="display: none;">
                <strong>Aten√ß√£o:</strong> Remover uma unidade tamb√©m remover√° todo o hist√≥rico de movimenta√ß√µes (√°gua, g√°s, materiais) associado a ela.
            </p>
             <p class="text-sm mt-2 text-red-700 bg-red-100 p-2 rounded border border-red-300" id="delete-warning-inicial" style="display: none;">
                <strong>Aten√ß√£o:</strong> Voc√™ est√° prestes a remover o lan√ßamento de Estoque Inicial. Isso recalcular√° todo o saldo de estoque!
            </p>
            <p id="delete-details" class="text-sm text-slate-600 mt-2"></p>
        </div>
        <div class="modal-footer space-x-2">
          <button id="btn-cancel-delete" class="btn-secondary">Cancelar</button>
          <button id="btn-confirm-delete" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Confirmar Exclus√£o</button>
        </div>
      </div>
    </div>

    <!-- Script Principal -->
    <script type="module">
        // --- IMPORTS DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, Timestamp, serverTimestamp, setLogLevel, setDoc, getDocs, where, limit, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // --- CONFIGURA√á√ÉO E VARI√ÅVEIS GLOBAIS ---
        
        const userFallbackConfig = { 
            apiKey: "AIzaSyD7VCxaHo8veaHnM8RwY60EX_DEh3hOVHk", 
            authDomain: "controle-almoxarifado-semcas.firebaseapp.com", 
            projectId: "controle-almoxarifado-semcas", 
            storageBucket: "controle-almoxarifado-semcas.firebasestorage.app", 
            messagingSenderId: "916615427315", 
            appId: "1:916615427315:web:6823897ed065c50d413386" 
        };
        
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(userFallbackConfig);
        const firebaseConfig = JSON.parse(firebaseConfigString);
        
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const appId = rawAppId.replace(/[\/.]/g, '-'); 
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db, userId;
        let isAuthReady = false;
        
        let unidadesCollection, aguaCollection, gasCollection, materiaisCollection;
        let estoqueAguaCollection, estoqueGasCollection;

        let fb_unidades = [], fb_agua_movimentacoes = [], fb_gas_movimentacoes = [], fb_materiais = [];
        let fb_estoque_agua = [], fb_estoque_gas = [];
        let estoqueInicialDefinido = { agua: false, gas: false }; 
        
        let visaoAtiva = 'dashboard'; 
        let dashboardAguaChartInstance, dashboardGasChartInstance;
        let dashboardRefreshInterval = null;
        let deleteInfo = { id: null, type: null, collectionRef: null, details: null, isInicial: false }; 

        // --- Refer√™ncias de Elementos (DOM) ---
        let navButtons, contentPanes, connectionStatusEl, lastUpdateTimeEl;
        // Dashboard
        let dashboardNavControls;
        let summaryAguaPendente, summaryAguaEntregue, summaryAguaRecebido;
        let summaryGasPendente, summaryGasEntregue, summaryGasRecebido;
        let dashboardMateriaisProntosContainer, loadingMateriaisProntos;
        let dashboardMateriaisListContainer, loadingMateriaisDashboard;
        let dashboardEstoqueAguaEl, dashboardEstoqueGasEl, dashboardMateriaisSeparacaoCountEl;
        let dashboardMateriaisRetiradaCountEl; // (REQ 6.4)
        // √Ågua
        let formAgua, selectUnidadeAgua, selectTipoAgua, inputDataAgua, inputResponsavelAgua, btnSubmitAgua, alertAgua, tableStatusAgua, alertAguaLista;
        let inputQtdEntregueAgua, inputQtdRetornoAgua, formGroupQtdEntregueAgua, formGroupQtdRetornoAgua; 
        // G√°s
        let formGas, selectUnidadeGas, selectTipoGas, inputDataGas, inputResponsavelGas, btnSubmitGas, alertGas, tableStatusGas, alertGasLista;
        let inputQtdEntregueGas, inputQtdRetornoGas, formGroupQtdEntregueGas, formGroupQtdRetornoGas; 
        // Materiais
        let formMateriais, selectUnidadeMateriais, selectTipoMateriais, inputDataSeparacao, textareaItensMateriais, inputResponsavelMateriais, btnSubmitMateriais, alertMateriais, tableStatusMateriais, alertMateriaisLista;
        // Gest√£o
        let tableGestaoUnidades, alertGestao, textareaBulkUnidades, btnBulkAddUnidades;
        let filtroUnidadeNome, filtroUnidadeTipo; 
        // Relat√≥rio PDF
        let relatorioTipo, relatorioDataInicio, relatorioDataFim, btnGerarPdf, alertRelatorio;
        // Modal Delete
        let confirmDeleteModal, btnCancelDelete, btnConfirmDelete, deleteDetailsEl, deleteWarningUnidadeEl, deleteWarningInicialEl; 
        
        // Estoque √Ågua
        let estoqueAguaInicialEl, estoqueAguaEntradasEl, estoqueAguaSaidasEl, estoqueAguaAtualEl, loadingEstoqueAguaEl, resumoEstoqueAguaEl;
        let formEntradaAgua, inputDataEntradaAgua, btnSubmitEntradaAgua; // Outros inputs s√£o buscados na fun√ß√£o
        let formInicialAguaContainer, formInicialAgua, inputInicialQtdAgua, inputInicialResponsavelAgua, btnSubmitInicialAgua, alertInicialAgua, btnAbrirInicialAgua; 
        let tableHistoricoAgua, alertHistoricoAgua; 
        
        // Estoque G√°s
        let estoqueGasInicialEl, estoqueGasEntradasEl, estoqueGasSaidasEl, estoqueGasAtualEl, loadingEstoqueGasEl, resumoEstoqueGasEl;
        let formEntradaGas, inputDataEntradaGas, btnSubmitEntradaGas; // Outros inputs s√£o buscados na fun√ß√£o
        let formInicialGasContainer, formInicialGas, inputInicialQtdGas, inputInicialResponsavelGas, btnSubmitInicialGas, alertInicialGas, btnAbrirInicialGas; 
        let tableHistoricoGas, alertHistoricoGas; 

        // Previs√£o Inteligente
        let listaExclusoes = { agua: [], gas: [] };
        let modoPrevisao = { agua: null, gas: null };
        let graficoPrevisao = { agua: null, gas: null };
        let tipoSelecionadoPrevisao = { agua: null, gas: null }; // (REQ 5.2) Armazena tipo selecionado


        // --- FUN√á√ïES DE UTILIDADE ---

        function showAlert(elementId, message, type = 'info', duration = 5000) {
            const el = document.getElementById(elementId);
            if (!el) { console.warn(`Elemento de alerta n√£o encontrado: ${elementId}`); return; }
            el.className = `alert alert-${type}`; 
            el.textContent = message;
            el.style.display = 'block';
            if (el.timeoutId) clearTimeout(el.timeoutId);
            el.timeoutId = setTimeout(() => {
                el.style.display = 'none';
                el.timeoutId = null;
            }, duration);
        }

        function getTodayDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function dateToTimestamp(dateString) {
             if (!dateString) return null;
            try {
                // Adiciona T00:00:00 para evitar problemas de fuso hor√°rio na convers√£o
                const date = new Date(dateString + 'T00:00:00'); 
                if (isNaN(date.getTime())) return null; 
                return Timestamp.fromDate(date);
            } catch (e) { console.error("Erro ao converter data:", dateString, e); return null; }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp || typeof timestamp.toDate !== 'function') return 'N/A';
            try {
                const date = timestamp.toDate();
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                if (yyyy < 2000) return 'Data Inv√°lida'; // Simple sanity check
                return `${dd}/${mm}/${yyyy}`;
            } catch (e) { console.error("Erro ao formatar timestamp:", timestamp, e); return 'Erro Data'; }
        }

        // Normaliza string para busca (min√∫sculas, sem acentos)
        function normalizeString(str) {
            if (!str) return '';
            return String(str).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // Capitaliza a primeira letra de cada palavra
        function capitalizeString(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        }
        
        // Filtra linhas de uma tabela baseado no input
        function filterTable(inputEl, tableBodyId) {
            const searchTerm = normalizeString(inputEl.value);
            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) return;
            const rows = tableBody.querySelectorAll('tr');
            // N√£o faz nada se a tabela est√° vazia ou carregando
            if (rows.length === 1 && (rows[0].querySelector('.loading-spinner-small') || rows[0].textContent.includes('Nenhum'))) {
                return;
            }
            rows.forEach(row => {
                // N√£o filtra linhas que est√£o em modo de edi√ß√£o ou linhas de observa√ß√£o
                if (row.querySelectorAll('td').length > 1 && !row.classList.contains('editing-row') && !row.classList.contains('obs-row')) { 
                    const rowText = normalizeString(row.textContent);
                    const isMatch = rowText.includes(searchTerm);
                    row.style.display = isMatch ? '' : 'none';
                    // (REQ 6.2) Mostra/esconde a linha de observa√ß√£o correspondente
                    const obsRow = row.nextElementSibling;
                    if(obsRow && obsRow.classList.contains('obs-row')) {
                        obsRow.style.display = isMatch ? '' : 'none';
                    }
                } else if (!row.classList.contains('obs-row')) { // Esconde linhas de edi√ß√£o/outras se n√£o for observa√ß√£o
                    // row.style.display = ''; // Mant√©m linhas de edi√ß√£o vis√≠veis?
                }
            });
        }


        // --- INICIALIZA√á√ÉO E AUTENTICA√á√ÉO FIREBASE ---
        
        async function initFirebase() {
             try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Descomente para logs detalhados do Firebase
                
                connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-yellow-400 rounded-full animate-pulse"></span> <span>Autenticando...</span>`;

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        userId = user.uid;
                        console.log("Autenticado com UID:", userId, "An√¥nimo:", user.isAnonymous);
                        connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-green-500 rounded-full"></span> <span class="text-green-700">Conectado</span>`;
                        
                        // Define caminhos das cole√ß√µes (usando /public/data para dados compartilhados)
                        const basePath = `artifacts/${appId}/public/data`;
                        unidadesCollection = collection(db, `${basePath}/unidades`);
                        aguaCollection = collection(db, `${basePath}/controleAgua`);
                        gasCollection = collection(db, `${basePath}/controleGas`);
                        materiaisCollection = collection(db, `${basePath}/controleMateriais`);
                        estoqueAguaCollection = collection(db, `${basePath}/estoqueAgua`);
                        estoqueGasCollection = collection(db, `${basePath}/estoqueGas`);
                        
                        console.log("Caminho base das cole√ß√µes:", basePath);
                        initFirestoreListeners(); // Inicia os listeners DEPOIS de definir as cole√ß√µes
                        
                    } else {
                        isAuthReady = false;
                        userId = null; 
                        console.log("Usu√°rio deslogado.");
                        connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-red-500 rounded-full"></span> <span class="text-red-700">Desconectado</span>`;
                        clearAlmoxarifadoData(); // Limpa dados da UI
                    }
                    updateLastUpdateTime(); // Atualiza hora na UI
                });

                // Tenta autenticar com token customizado (se fornecido pelo ambiente) ou anonimamente
                if (initialAuthToken) {
                    console.log("Tentando login com Custom Token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Nenhum Custom Token encontrado. Tentando login an√¥nimo...");
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-red-500 rounded-full"></span> <span class="text-red-700">Erro Firebase</span>`;
                showAlert('alert-agua', `Erro cr√≠tico na conex√£o com Firebase: ${error.message}. Recarregue a p√°gina.`, 'error', 60000);
            }
        }

        // --- L√ìGICA DO FIRESTORE (LISTENERS) ---
        
        function initFirestoreListeners() {
            if (!isAuthReady || !unidadesCollection) { 
                console.warn("Firestore listeners n√£o iniciados: Auth n√£o pronto ou cole√ß√£o inv√°lida."); 
                return; 
            }
            console.log("Iniciando listeners do Firestore...");

            // Listener para Unidades
            onSnapshot(query(unidadesCollection), (snapshot) => { 
                fb_unidades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                
                // Popula todos os selects de unidade
                populateUnidadeSelects(selectUnidadeAgua, 'atendeAgua');
                populateUnidadeSelects(selectUnidadeGas, 'atendeGas');
                populateUnidadeSelects(selectUnidadeMateriais, 'atendeMateriais');
                populateUnidadeSelects(document.getElementById('select-previsao-unidade-agua-v2'), 'atendeAgua', false); 
                populateUnidadeSelects(document.getElementById('select-previsao-unidade-gas-v2'), 'atendeGas', false); 
                
                // (REQ 5.1) Popula os selects de TIPO da previs√£o
                populateTipoSelects('agua');
                populateTipoSelects('gas');

                // Popula selects de exclus√£o (inicialmente com todas as unidades)
                populateUnidadeSelects(document.getElementById('select-exclusao-agua'), 'atendeAgua', false, true, null); 
                populateUnidadeSelects(document.getElementById('select-exclusao-gas'), 'atendeGas', false, true, null); 
                
                // Renderiza tabelas e status
                renderGestaoUnidades(); 
                renderAguaStatus(); 
                renderGasStatus(); 
                console.log("Unidades atualizadas:", fb_unidades.length);
            }, (error) => { console.error("Erro no listener de unidades:", error); showAlert('alert-gestao', `Erro ao carregar unidades: ${error.message}`, 'error'); });

            // Listener para Sa√≠das de √Ågua
            onSnapshot(query(aguaCollection), (snapshot) => {
                fb_agua_movimentacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAguaStatus(); 
                renderDashboardAguaChart(); 
                renderDashboardAguaSummary();
                renderEstoqueAgua(); // Recalcula estoque
                console.log("Mov. √Ågua (Sa√≠das) atualizadas:", fb_agua_movimentacoes.length);
            }, (error) => { console.error("Erro no listener de √°gua:", error); showAlert('alert-agua-lista', `Erro ao carregar dados de √°gua: ${error.message}`, 'error'); });

            // Listener para Sa√≠das de G√°s
            onSnapshot(query(gasCollection), (snapshot) => {
                fb_gas_movimentacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGasStatus(); 
                renderDashboardGasChart(); 
                renderDashboardGasSummary();
                renderEstoqueGas(); // Recalcula estoque
                console.log("Mov. G√°s (Sa√≠das) atualizadas:", fb_gas_movimentacoes.length);
            }, (error) => { console.error("Erro no listener de g√°s:", error); showAlert('alert-gas-lista', `Erro ao carregar dados de g√°s: ${error.message}`, 'error'); });

            // Listener para Materiais
            onSnapshot(query(materiaisCollection), (snapshot) => {
                fb_materiais = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMateriaisStatus(); 
                renderDashboardMateriaisList();
                renderDashboardMateriaisProntos(); 
                renderDashboardMateriaisCounts(); // (REQ 6.4) Atualiza os dois contadores
                console.log("Materiais atualizados:", fb_materiais.length);
            }, (error) => { console.error("Erro no listener de materiais:", error); showAlert('alert-materiais-lista', `Erro ao carregar materiais: ${error.message}`, 'error'); });
        
            // Listener para Entradas de Estoque de √Ågua
            onSnapshot(query(estoqueAguaCollection), (snapshot) => {
                fb_estoque_agua = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                estoqueInicialDefinido.agua = fb_estoque_agua.some(e => e.tipo === 'inicial');
                renderEstoqueAgua(); // Recalcula e renderiza estoque
                renderHistoricoAgua(); // Renderiza hist√≥rico de entradas
                console.log("Estoque √Ågua (Entradas) atualizado:", fb_estoque_agua.length, "Inicial definido:", estoqueInicialDefinido.agua);
            }, (error) => { console.error("Erro no listener de estoque √°gua:", error); });

            // Listener para Entradas de Estoque de G√°s
            onSnapshot(query(estoqueGasCollection), (snapshot) => {
                fb_estoque_gas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                estoqueInicialDefinido.gas = fb_estoque_gas.some(e => e.tipo === 'inicial');
                renderEstoqueGas(); // Recalcula e renderiza estoque
                renderHistoricoGas(); // Renderiza hist√≥rico de entradas
                console.log("Estoque G√°s (Entradas) atualizado:", fb_estoque_gas.length, "Inicial definido:", estoqueInicialDefinido.gas);
            }, (error) => { console.error("Erro no listener de estoque g√°s:", error); });
        }
        
        // Limpa os dados da UI quando desconectado
        function clearAlmoxarifadoData() {
            fb_unidades = []; fb_agua_movimentacoes = []; fb_gas_movimentacoes = []; fb_materiais = [];
            fb_estoque_agua = []; fb_estoque_gas = []; 
            estoqueInicialDefinido = { agua: false, gas: false };

            // Limpa selects de unidade
            [selectUnidadeAgua, selectUnidadeGas, selectUnidadeMateriais, 
             document.getElementById('select-previsao-unidade-agua-v2'), 
             document.getElementById('select-previsao-unidade-gas-v2'),
             document.getElementById('select-exclusao-agua'),
             document.getElementById('select-exclusao-gas'),
             document.getElementById('select-previsao-tipo-agua'),
             document.getElementById('select-previsao-tipo-gas')
            ].forEach(sel => { if(sel) sel.innerHTML = '<option value="">Desconectado</option>'; });
            
            // Limpa tabelas
            [tableStatusAgua, tableStatusGas, tableStatusMateriais, tableGestaoUnidades, tableHistoricoAgua, tableHistoricoGas].forEach(tbody => { if(tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Desconectado do Firebase</td></tr>'; });
            
            // Limpa containers do Dashboard
            [dashboardMateriaisListContainer, dashboardMateriaisProntosContainer].forEach(el => { if(el) el.innerHTML = '<p class="text-center py-4 text-red-500">Desconectado</p>'; });
            
            // Destroi inst√¢ncias dos gr√°ficos
            [dashboardAguaChartInstance, dashboardGasChartInstance, graficoPrevisao.agua, graficoPrevisao.gas].forEach(chartInstance => { 
                if (chartInstance) { 
                    chartInstance.destroy(); 
                    chartInstance = null; // Garante que a refer√™ncia seja limpa
                } 
            });
            // Zera contadores de estoque na UI
            [estoqueAguaInicialEl, estoqueAguaEntradasEl, estoqueAguaSaidasEl, estoqueAguaAtualEl, estoqueGasInicialEl, estoqueGasEntradasEl, estoqueGasSaidasEl, estoqueGasAtualEl].forEach(el => { if(el) el.textContent = '0'; });
            
            // Esconde resumos e mostra loaders/bot√µes iniciais
            [resumoEstoqueAguaEl, resumoEstoqueGasEl].forEach(el => { if(el) el.classList.add('hidden'); });
            [loadingEstoqueAguaEl, loadingEstoqueGasEl].forEach(el => { if(el) el.style.display = 'block'; });
            [btnAbrirInicialAgua, btnAbrirInicialGas].forEach(btn => { if(btn) btn.classList.remove('hidden'); }); 
            [formInicialAguaContainer, formInicialGasContainer].forEach(form => { if(form) form.classList.add('hidden'); }); 
            
            // Zera contadores do Dashboard
            if (dashboardEstoqueAguaEl) dashboardEstoqueAguaEl.textContent = '0';
            if (dashboardEstoqueGasEl) dashboardEstoqueGasEl.textContent = '0';
            if (dashboardMateriaisSeparacaoCountEl) dashboardMateriaisSeparacaoCountEl.textContent = '0';
            if (dashboardMateriaisRetiradaCountEl) dashboardMateriaisRetiradaCountEl.textContent = '0'; // (REQ 6.4)

            // Limpa filtros
            if (filtroUnidadeNome) filtroUnidadeNome.value = '';
            if (filtroUnidadeTipo) filtroUnidadeTipo.value = '';
            document.getElementById('filtro-status-agua')?.setAttribute('value', ''); // Usar setAttribute para garantir atualiza√ß√£o visual
            document.getElementById('filtro-historico-agua')?.setAttribute('value', '');
            document.getElementById('filtro-status-gas')?.setAttribute('value', '');
            document.getElementById('filtro-historico-gas')?.setAttribute('value', '');

            console.log("Dados do Almoxarifado limpos devido √† desconex√£o.");
        }

        // Atualiza o hor√°rio da √∫ltima atualiza√ß√£o na UI
        function updateLastUpdateTime() {
             if (!lastUpdateTimeEl) return;
            const now = new Date();
            const formattedDate = now.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
            lastUpdateTimeEl.textContent = `Atualizado: ${formattedDate}`;
        }

        // Popula selects de unidade, com op√ß√µes de filtro e agrupamento
        function populateUnidadeSelects(selectEl, serviceField, includeAll = false, includeSelecione = true, filterType = null) {
            if (!selectEl) return;

            // Filtra unidades pelo servi√ßo E pelo tipo (se fornecido)
            let unidadesFiltradas = fb_unidades.filter(u => {
                const atendeServico = serviceField ? (u[serviceField] ?? true) : true;
                // (REQ 5.3) Normaliza tipo para 'SEDE' se for 'SEMCAS' antes de filtrar
                const tipoUnidadeNormalizado = (u.tipo || '').toUpperCase() === 'SEMCAS' ? 'SEDE' : (u.tipo || '').toUpperCase();
                const tipoCorreto = !filterType || tipoUnidadeNormalizado === (filterType || '').toUpperCase();
                return atendeServico && tipoCorreto;
            });
            
            // Agrupa por tipo para optgroup
            const grupos = unidadesFiltradas.reduce((acc, unidade) => { 
                // (REQ 5.3) Agrupa SEMCAS sob SEDE
                let tipo = (unidade.tipo || 'Sem Tipo').toUpperCase(); 
                if (tipo === 'SEMCAS') tipo = 'SEDE';
                if (!acc[tipo]) acc[tipo] = []; 
                acc[tipo].push(unidade); 
                return acc; 
            }, {});
            const tiposOrdenados = Object.keys(grupos).sort();
            
            // Monta HTML das op√ß√µes
            let html = '';
            if (includeSelecione) {
                html += '<option value="">-- Selecione --</option>';
            }
            // Op√ß√£o "Todas as Unidades" (usada em selects de exclus√£o)
            if (includeAll) {
                 html += '<option value="todas">Todas as Unidades</option>';
            }

            // Mensagem se n√£o houver unidades ap√≥s filtrar
            if (unidadesFiltradas.length === 0 && !includeAll) { 
                selectEl.innerHTML = `<option value="">Nenhuma unidade ${filterType ? `do tipo ${filterType} ` : ''}habilitada</option>`; 
                return; 
            }

            // Cria os optgroups e options
            tiposOrdenados.forEach(tipo => {
                html += `<optgroup label="${tipo}">`; // Tipo j√° est√° em mai√∫sculas
                grupos[tipo].sort((a,b) => a.nome.localeCompare(b.nome)).forEach(unidade => { 
                    // Usa ID como valor para selects da previs√£o, formato antigo para outros
                    const optionValue = (selectEl.id.includes('-v2') || selectEl.id.includes('exclusao')) ? unidade.id : `${unidade.id}|${unidade.nome}|${unidade.tipo}`;
                    html += `<option value="${optionValue}">${unidade.nome}</option>`; 
                });
                html += `</optgroup>`;
            });
            selectEl.innerHTML = html;
        }

        // (REQ 5.1) Popula os selects de TIPO na Previs√£o
        function populateTipoSelects(itemType) { // itemType √© 'agua' ou 'gas'
            const selectEl = document.getElementById(`select-previsao-tipo-${itemType}`);
            if (!selectEl) return;

            // Obt√©m tipos √∫nicos das unidades, tratando SEDE/SEMCAS
            const uniqueTypes = [...new Set(fb_unidades.map(u => {
                let tipo = (u.tipo || 'Sem Tipo').toUpperCase();
                return tipo === 'SEMCAS' ? 'SEDE' : tipo;
            }))].sort();

            let html = '<option value="">-- Selecione o Tipo --</option>';
            uniqueTypes.forEach(tipo => {
                html += `<option value="${tipo}">${tipo}</option>`;
            });
            selectEl.innerHTML = html;
        }


        // --- L√ìGICA DE CONTROLE DE √ÅGUA ---
        
        // Controla visibilidade dos inputs Qtd Entregue/Retorno baseado no Tipo de Movimenta√ß√£o
        function toggleAguaFormInputs() {
            if (!selectTipoAgua) return; 
            const tipo = selectTipoAgua.value;
            if (tipo === 'troca') {
                formGroupQtdEntregueAgua?.classList.remove('hidden');
                formGroupQtdRetornoAgua?.classList.remove('hidden');
            } else if (tipo === 'entrega') {
                formGroupQtdEntregueAgua?.classList.remove('hidden');
                formGroupQtdRetornoAgua?.classList.add('hidden');
                if (inputQtdRetornoAgua) inputQtdRetornoAgua.value = "0"; 
            } else if (tipo === 'retorno') {
                formGroupQtdEntregueAgua?.classList.add('hidden');
                formGroupQtdRetornoAgua?.classList.remove('hidden');
                if (inputQtdEntregueAgua) inputQtdEntregueAgua.value = "0"; 
            }
        }

        // Salva movimenta√ß√£o de √°gua (sa√≠da para unidades)
        async function handleAguaSubmit(e) {
             e.preventDefault();
            if (!isAuthReady) { showAlert('alert-agua', 'Erro: N√£o autenticado.', 'error'); return; }
            const selectValue = selectUnidadeAgua.value; 
            if (!selectValue) { showAlert('alert-agua', 'Selecione uma unidade.', 'warning'); return; }
            const [unidadeId, unidadeNome, tipoUnidadeRaw] = selectValue.split('|');
            // (REQ 5.3) Normaliza tipo para consist√™ncia
            const tipoUnidade = (tipoUnidadeRaw || '').toUpperCase() === 'SEMCAS' ? 'SEDE' : (tipoUnidadeRaw || '').toUpperCase();

            const tipoMovimentacao = selectTipoAgua.value; 
            const qtdEntregue = parseInt(inputQtdEntregueAgua.value, 10) || 0;
            const qtdRetorno = parseInt(inputQtdRetornoAgua.value, 10) || 0;
            const data = dateToTimestamp(inputDataAgua.value);
            const responsavel = capitalizeString(inputResponsavelAgua.value.trim()); 
            
            // Valida√ß√µes
            if (!unidadeId || !data || !responsavel) {
                showAlert('alert-agua', 'Dados inv√°lidos. Verifique Unidade, Data e Respons√°vel.', 'warning'); return;
            }
            if (tipoMovimentacao === 'troca' && qtdEntregue === 0 && qtdRetorno === 0) {
                 showAlert('alert-agua', 'Para "Troca", ao menos uma das quantidades deve ser maior que zero.', 'warning'); return;
            }
            if (tipoMovimentacao === 'entrega' && qtdEntregue <= 0) {
                 showAlert('alert-agua', 'Para "Apenas Sa√≠da", a quantidade deve ser maior que zero.', 'warning'); return;
            }
            if (tipoMovimentacao === 'retorno' && qtdRetorno <= 0) {
                 showAlert('alert-agua', 'Para "Apenas Retorno", a quantidade deve ser maior que zero.', 'warning'); return;
            }
            // Verifica estoque ANTES de salvar sa√≠da
            if (qtdEntregue > 0) {
                if (!estoqueInicialDefinido.agua) {
                    showAlert('alert-agua', 'Defina o Estoque Inicial de √Ågua antes de lan√ßar sa√≠das.', 'warning'); return;
                }
                const estoqueAtual = parseInt(estoqueAguaAtualEl.textContent) || 0;
                if (qtdEntregue > estoqueAtual) {
                    showAlert('alert-agua', `Erro: Estoque insuficiente. Dispon√≠vel: ${estoqueAtual}`, 'error'); return;
                }
            }
            
            // Desabilita bot√£o e mostra loading
            btnSubmitAgua.disabled = true; btnSubmitAgua.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            let msgSucesso = [];
            
            try {
                const timestamp = serverTimestamp(); // Timestamp do servidor
                // Adiciona documento para entrega (se houver)
                if (qtdEntregue > 0) {
                    await addDoc(aguaCollection, { unidadeId, unidadeNome, tipoUnidade, tipo: 'entrega', quantidade: qtdEntregue, data, responsavel, registradoEm: timestamp });
                    msgSucesso.push(`${qtdEntregue} gal√£o(√µes) entregue(s)`);
                }
                // Adiciona documento para retorno (se houver)
                if (qtdRetorno > 0) {
                     await addDoc(aguaCollection, { unidadeId, unidadeNome, tipoUnidade, tipo: 'retorno', quantidade: qtdRetorno, data, responsavel, registradoEm: timestamp });
                     msgSucesso.push(`${qtdRetorno} gal√£o(√µes) recebido(s)`);
                }
                showAlert('alert-agua', `Movimenta√ß√£o salva! ${msgSucesso.join('; ')}.`, 'success');
                formAgua.reset(); // Limpa formul√°rio
                inputDataAgua.value = getTodayDateString(); // Reseta data para hoje
                toggleAguaFormInputs(); // Ajusta inputs de quantidade
            } catch (error) { 
                console.error("Erro salvar √°gua:", error); 
                showAlert('alert-agua', `Erro: ${error.message}`, 'error');
            } finally { 
                // Reabilita bot√£o
                btnSubmitAgua.disabled = false; 
                btnSubmitAgua.textContent = 'Salvar Movimenta√ß√£o'; 
            }
        }

        // Renderiza a tabela de status de gal√µes por unidade
        function renderAguaStatus() {
             if (!tableStatusAgua) return;
             
             // Cria um mapa para acumular status por unidade
             const statusMap = new Map();
             fb_unidades.forEach(u => { 
                // (REQ 5.3) Normaliza tipo ao inicializar o mapa
                let tipoNormalizado = (u.tipo || 'N/A').toUpperCase();
                if (tipoNormalizado === 'SEMCAS') tipoNormalizado = 'SEDE';
                statusMap.set(u.id, { id: u.id, nome: u.nome, tipo: tipoNormalizado, entregues: 0, recebidos: 0, ultimosLancamentos: [] }); 
            });

             // Ordena movimenta√ß√µes por data de registro (mais recente primeiro)
             const movsOrdenadas = [...fb_agua_movimentacoes].sort((a, b) => (b.registradoEm?.toMillis() || 0) - (a.registradoEm?.toMillis() || 0));
             
             // Processa movimenta√ß√µes para calcular totais e √∫ltimo respons√°vel
             movsOrdenadas.forEach(m => {
                 if (statusMap.has(m.unidadeId)) {
                     const unidadeStatus = statusMap.get(m.unidadeId);
                     if (m.tipo === 'entrega') unidadeStatus.entregues += m.quantidade;
                     else if (m.tipo === 'retorno') unidadeStatus.recebidos += m.quantidade;
                     // Guarda apenas o √∫ltimo lan√ßamento para o bot√£o de deletar
                     if (unidadeStatus.ultimosLancamentos.length < 1) { 
                         unidadeStatus.ultimosLancamentos.push({id: m.id, resp: m.responsavel, data: formatTimestamp(m.data), tipo: m.tipo});
                     }
                 }
             });

             // Converte mapa para array, calcula saldo e filtra unidades sem movimenta√ß√£o
             const statusArray = Array.from(statusMap.values())
                 .map(s => ({ ...s, pendentes: s.entregues - s.recebidos })) 
                 .filter(s => s.entregues > 0 || s.recebidos > 0 || s.pendentes !== 0) // Mostra apenas se houve movimenta√ß√£o ou saldo
                 .sort((a, b) => b.pendentes - a.pendentes || a.nome.localeCompare(b.nome)); // Ordena por saldo (maior primeiro), depois por nome

            // Renderiza HTML da tabela
            if (statusArray.length === 0) { 
                tableStatusAgua.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Nenhuma movimenta√ß√£o registrada.</td></tr>'; 
                return; 
            }
            tableStatusAgua.innerHTML = statusArray.map(s => {
                const tooltipText = s.ultimosLancamentos.map(l => `${l.tipo === 'entrega' ? 'E': 'R'}: ${l.resp} (${l.data})`).join(' | ');
                const ultimoId = s.ultimosLancamentos[0]?.id; // ID para bot√£o de deletar
                const saldo = s.pendentes;
                const saldoText = saldo > 0 ? `Faltando ${saldo}` : (saldo < 0 ? `Cr√©dito ${Math.abs(saldo)}` : 'Zerado');
                const saldoClass = saldo > 0 ? 'text-red-600' : (saldo < 0 ? 'text-blue-600' : 'text-green-600');
                return `
                <tr title="${tooltipText || 'Sem detalhes de respons√°vel'}">
                    <td class="font-medium">${s.nome}</td><td>${s.tipo || 'N/A'}</td>
                    <td class="text-center">${s.entregues}</td><td class="text-center">${s.recebidos}</td>
                    <td class="text-center font-bold ${saldoClass}">${saldoText}</td>
                    <td class="text-center">
                        ${ultimoId ? `<button class="btn-danger btn-remove" data-id="${ultimoId}" data-type="agua" title="Remover √∫ltimo lan√ßamento desta unidade"><i data-lucide="trash-2"></i></button>` : '-'}
                    </td>
                </tr>
            `}).join('');
             lucide.createIcons(); // Recria √≠cones

             // Reaplica filtro se houver algum termo na busca
            const filtroStatusAguaEl = document.getElementById('filtro-status-agua');
            if (filtroStatusAguaEl && filtroStatusAguaEl.value) {
                filterTable(filtroStatusAguaEl, 'table-status-agua');
            }
        }
        
        // --- L√ìGICA DE CONTROLE DE G√ÅS ---
        
        // Similar a toggleAguaFormInputs, mas para g√°s
        function toggleGasFormInputs() {
            if (!selectTipoGas) return; 
            const tipo = selectTipoGas.value;
            if (tipo === 'troca') {
                formGroupQtdEntregueGas?.classList.remove('hidden');
                formGroupQtdRetornoGas?.classList.remove('hidden');
            } else if (tipo === 'entrega') {
                formGroupQtdEntregueGas?.classList.remove('hidden');
                formGroupQtdRetornoGas?.classList.add('hidden');
                if(inputQtdRetornoGas) inputQtdRetornoGas.value = "0"; 
            } else if (tipo === 'retorno') {
                formGroupQtdEntregueGas?.classList.add('hidden');
                formGroupQtdRetornoGas?.classList.remove('hidden');
                if(inputQtdEntregueGas) inputQtdEntregueGas.value = "0"; 
            }
        }
        
        // Similar a handleAguaSubmit, mas para g√°s
        async function handleGasSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) { showAlert('alert-gas', 'Erro: N√£o autenticado.', 'error'); return; }
            const selectValue = selectUnidadeGas.value; 
            if (!selectValue) { showAlert('alert-gas', 'Selecione uma unidade.', 'warning'); return; }
            const [unidadeId, unidadeNome, tipoUnidadeRaw] = selectValue.split('|');
            // (REQ 5.3) Normaliza tipo
            const tipoUnidade = (tipoUnidadeRaw || '').toUpperCase() === 'SEMCAS' ? 'SEDE' : (tipoUnidadeRaw || '').toUpperCase();

            const tipoMovimentacao = selectTipoGas.value; 
            const qtdEntregue = parseInt(inputQtdEntregueGas.value, 10) || 0;
            const qtdRetorno = parseInt(inputQtdRetornoGas.value, 10) || 0;
            const data = dateToTimestamp(inputDataGas.value);
            const responsavel = capitalizeString(inputResponsavelGas.value.trim()); 
            
             if (!unidadeId || !data || !responsavel) { 
                showAlert('alert-gas', 'Dados inv√°lidos. Verifique Unidade, Data e Respons√°vel.', 'warning'); return;
            }
            if (tipoMovimentacao === 'troca' && qtdEntregue === 0 && qtdRetorno === 0) {
                 showAlert('alert-gas', 'Para "Troca", ao menos uma das quantidades deve ser maior que zero.', 'warning'); return;
            }
            if (tipoMovimentacao === 'entrega' && qtdEntregue <= 0) {
                 showAlert('alert-gas', 'Para "Apenas Sa√≠da", a quantidade deve ser maior que zero.', 'warning'); return;
            }
            if (tipoMovimentacao === 'retorno' && qtdRetorno <= 0) {
                 showAlert('alert-gas', 'Para "Apenas Retorno", a quantidade deve ser maior que zero.', 'warning'); return;
            }
            if (qtdEntregue > 0) {
                if (!estoqueInicialDefinido.gas) {
                    showAlert('alert-gas', 'Defina o Estoque Inicial de G√°s antes de lan√ßar sa√≠das.', 'warning'); return;
                }
                const estoqueAtual = parseInt(estoqueGasAtualEl.textContent) || 0;
                if (qtdEntregue > estoqueAtual) {
                    showAlert('alert-gas', `Erro: Estoque insuficiente. Dispon√≠vel: ${estoqueAtual}`, 'error'); return;
                }
            }
            
            btnSubmitGas.disabled = true; btnSubmitGas.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            let msgSucesso = [];
            
            try {
                const timestamp = serverTimestamp();
                if (qtdEntregue > 0) {
                    await addDoc(gasCollection, { unidadeId, unidadeNome, tipoUnidade, tipo: 'entrega', quantidade: qtdEntregue, data, responsavel, registradoEm: timestamp });
                    msgSucesso.push(`${qtdEntregue} botij√£o(√µes) entregue(s)`);
                }
                if (qtdRetorno > 0) {
                     await addDoc(gasCollection, { unidadeId, unidadeNome, tipoUnidade, tipo: 'retorno', quantidade: qtdRetorno, data, responsavel, registradoEm: timestamp });
                     msgSucesso.push(`${qtdRetorno} botij√£o(√µes) recebido(s)`);
                }
                showAlert('alert-gas', `Movimenta√ß√£o salva! ${msgSucesso.join('; ')}.`, 'success');
                formGas.reset(); 
                inputDataGas.value = getTodayDateString(); 
                toggleGasFormInputs(); 
            } catch (error) { 
                console.error("Erro salvar g√°s:", error); 
                showAlert('alert-gas', `Erro: ${error.message}`, 'error');
            } finally { 
                btnSubmitGas.disabled = false; 
                btnSubmitGas.textContent = 'Salvar Movimenta√ß√£o'; 
            }
        }

        // Similar a renderAguaStatus, mas para g√°s
        function renderGasStatus() {
            if (!tableStatusGas) return;
            
            const statusMap = new Map();
             fb_unidades.forEach(u => { 
                // (REQ 5.3) Normaliza tipo
                let tipoNormalizado = (u.tipo || 'N/A').toUpperCase();
                if (tipoNormalizado === 'SEMCAS') tipoNormalizado = 'SEDE';
                statusMap.set(u.id, { id: u.id, nome: u.nome, tipo: tipoNormalizado, entregues: 0, recebidos: 0, ultimosLancamentos: [] }); 
            });

            const movsOrdenadas = [...fb_gas_movimentacoes].sort((a, b) => (b.registradoEm?.toMillis() || 0) - (a.registradoEm?.toMillis() || 0));
            
            movsOrdenadas.forEach(m => {
                 if (statusMap.has(m.unidadeId)) {
                     const unidadeStatus = statusMap.get(m.unidadeId);
                     if (m.tipo === 'entrega') unidadeStatus.entregues += m.quantidade;
                     else if (m.tipo === 'retorno') unidadeStatus.recebidos += m.quantidade;
                     if (unidadeStatus.ultimosLancamentos.length < 1) { 
                         unidadeStatus.ultimosLancamentos.push({id: m.id, resp: m.responsavel, data: formatTimestamp(m.data), tipo: m.tipo});
                     }
                 }
             });

             const statusArray = Array.from(statusMap.values())
                 .map(s => ({ ...s, pendentes: s.entregues - s.recebidos }))
                 .filter(s => s.entregues > 0 || s.recebidos > 0 || s.pendentes !== 0) 
                 .sort((a, b) => b.pendentes - a.pendentes || a.nome.localeCompare(b.nome));

            if (statusArray.length === 0) { 
                tableStatusGas.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Nenhuma movimenta√ß√£o registrada.</td></tr>'; 
                return; 
            }
             tableStatusGas.innerHTML = statusArray.map(s => {
                const tooltipText = s.ultimosLancamentos.map(l => `${l.tipo === 'entrega' ? 'E': 'R'}: ${l.resp} (${l.data})`).join(' | ');
                const ultimoId = s.ultimosLancamentos[0]?.id;
                const saldo = s.pendentes;
                const saldoText = saldo > 0 ? `Faltando ${saldo}` : (saldo < 0 ? `Cr√©dito ${Math.abs(saldo)}` : 'Zerado');
                const saldoClass = saldo > 0 ? 'text-red-600' : (saldo < 0 ? 'text-blue-600' : 'text-green-600');
                return `
                <tr title="${tooltipText || 'Sem detalhes de respons√°vel'}">
                    <td class="font-medium">${s.nome}</td><td>${s.tipo || 'N/A'}</td>
                    <td class="text-center">${s.entregues}</td><td class="text-center">${s.recebidos}</td>
                    <td class="text-center font-bold ${saldoClass}">${saldoText}</td>
                     <td class="text-center">
                        ${ultimoId ? `<button class="btn-danger btn-remove" data-id="${ultimoId}" data-type="gas" title="Remover √∫ltimo lan√ßamento"><i data-lucide="trash-2"></i></button>` : '-'}
                    </td>
                </tr>
            `}).join('');
             lucide.createIcons();

            const filtroStatusGasEl = document.getElementById('filtro-status-gas');
            if (filtroStatusGasEl && filtroStatusGasEl.value) {
                filterTable(filtroStatusGasEl, 'table-status-gas');
            }
        }
        
        // --- L√ìGICA DE PREVIS√ÉO INTELIGENTE ---
        
        // Chamada quando um modo de previs√£o √© selecionado (card clicado)
        window.selecionarModoPrevisao = (tipoItem, modo) => { // tipoItem: 'agua' ou 'gas'
            console.log(`Modo Previs√£o (${tipoItem}): ${modo}`);
            modoPrevisao[tipoItem] = modo;
            
            // Seletores dos containers de configura√ß√£o
            const configContainer = document.getElementById(`config-previsao-${tipoItem}`);
            const cards = document.querySelectorAll(`#subview-previsao-${tipoItem} .previsao-option-card`);
            const selectUnidadeContainer = document.getElementById(`select-unidade-container-${tipoItem}`);
            const selectTipoContainer = document.getElementById(`select-tipo-container-${tipoItem}`);
            const selectTipoEl = document.getElementById(`select-previsao-tipo-${tipoItem}`); // (REQ 5.2) Select de tipo
            const exclusaoContainer = document.getElementById(`exclusao-container-${tipoItem}`);
            const selectExclusaoEl = document.getElementById(`select-exclusao-${tipoItem}`); // (REQ 5.2) Select de exclus√£o

            // Resetar UI: mostra container de config, esconde selects espec√≠ficos
            configContainer.classList.remove('hidden');
            selectUnidadeContainer.classList.add('hidden');
            selectTipoContainer.classList.add('hidden');
            exclusaoContainer.classList.remove('hidden'); // Vis√≠vel por padr√£o
            
            // Marca o card selecionado
            cards.forEach(card => card.classList.toggle('selected', card.dataset.modo === modo));

            // Mostra/esconde selects espec√≠ficos do modo
            if (modo === 'unidade-especifica') {
                selectUnidadeContainer.classList.remove('hidden');
                exclusaoContainer.classList.add('hidden'); // N√£o faz sentido excluir se √© uma espec√≠fica
                tipoSelecionadoPrevisao[tipoItem] = null; // (REQ 5.2) Limpa tipo selecionado
            } else if (modo === 'por-tipo') {
                selectTipoContainer.classList.remove('hidden');
                tipoSelecionadoPrevisao[tipoItem] = selectTipoEl.value; // (REQ 5.2) Guarda o tipo atual
                // (REQ 5.2) Popula exclus√£o S√ì com unidades do tipo selecionado
                populateUnidadeSelects(selectExclusaoEl, tipoItem === 'agua' ? 'atendeAgua' : 'atendeGas', false, true, tipoSelecionadoPrevisao[tipoItem]); 
            } else if (modo === 'completo') {
                tipoSelecionadoPrevisao[tipoItem] = null; // (REQ 5.2) Limpa tipo selecionado
                // (REQ 5.2) Popula exclus√£o com TODAS unidades habilitadas
                 populateUnidadeSelects(selectExclusaoEl, tipoItem === 'agua' ? 'atendeAgua' : 'atendeGas', false, true, null);
            }

            // Resetar exclus√µes ao trocar de modo
            listaExclusoes[tipoItem] = [];
            renderizarListaExclusoes(tipoItem);
            
            // (REQ 5.2) Adiciona listener para atualizar exclus√µes quando o TIPO muda
            selectTipoEl.removeEventListener('change', handleTipoPrevisaoChange); // Remove listener antigo para evitar duplica√ß√£o
            selectTipoEl.addEventListener('change', handleTipoPrevisaoChange); 
        }

        // (REQ 5.2) Fun√ß√£o chamada quando o tipo de unidade √© alterado na previs√£o "Por Tipo"
        function handleTipoPrevisaoChange(event) {
            const selectEl = event.target;
            const tipoItem = selectEl.id.includes('agua') ? 'agua' : 'gas'; // Determina se √© √°gua ou g√°s
            const novoTipo = selectEl.value;
            tipoSelecionadoPrevisao[tipoItem] = novoTipo; // Atualiza o tipo selecionado globalmente
            
            const selectExclusaoEl = document.getElementById(`select-exclusao-${tipoItem}`);
            // Repopula a lista de exclus√£o filtrando pelo novo tipo
            populateUnidadeSelects(selectExclusaoEl, tipoItem === 'agua' ? 'atendeAgua' : 'atendeGas', false, true, novoTipo); 
            
            // Limpa a lista de exclus√µes atual, pois o tipo mudou
            listaExclusoes[tipoItem] = [];
            renderizarListaExclusoes(tipoItem);
        }


        // Adiciona uma unidade √† lista de exclus√£o
        window.adicionarExclusao = (tipoItem) => {
            const selectExclusao = document.getElementById(`select-exclusao-${tipoItem}`);
            const unidadeId = selectExclusao.value;
            if (!unidadeId || unidadeId === 'todas') return; // Ignora se for vazio ou "Todas"
            
            // Evita adicionar duplicados
            if (listaExclusoes[tipoItem].find(item => item.id === unidadeId)) {
                selectExclusao.value = ""; // Reseta o select
                return;
            }

            const unidadeNome = selectExclusao.options[selectExclusao.selectedIndex].text;
            listaExclusoes[tipoItem].push({ id: unidadeId, nome: unidadeNome });
            
            renderizarListaExclusoes(tipoItem); // Atualiza a UI da lista
            selectExclusao.value = ""; // Reseta o select
        }
        
        // Renderiza os "badges" das unidades exclu√≠das
        function renderizarListaExclusoes(tipoItem) {
            const container = document.getElementById(`lista-exclusoes-${tipoItem}`);
            container.innerHTML = listaExclusoes[tipoItem].map((item, index) => `
                <span class="exclusao-item">
                    ${item.nome}
                    <button type="button" onclick="removerExclusao('${tipoItem}', ${index})">&times;</button>
                </span>
            `).join('');
        }
        
        // Remove uma unidade da lista de exclus√£o
        window.removerExclusao = (tipoItem, index) => {
            listaExclusoes[tipoItem].splice(index, 1); // Remove do array
            renderizarListaExclusoes(tipoItem); // Atualiza a UI
        }

        // Calcula e exibe a previs√£o inteligente
        window.calcularPrevisaoInteligente = (tipoItem) => {
            console.log(`Calculando previs√£o para ${tipoItem}...`);
            const alertId = `alertas-previsao-${tipoItem}`;
            const resultadoContainerId = `resultado-previsao-${tipoItem}-v2`;
            
            // 1. Validar Modo Selecionado
            if (!modoPrevisao[tipoItem]) {
                showAlert(alertId, 'Por favor, selecione um modo de previs√£o primeiro (Etapa 1).', 'warning');
                return;
            }

            // 2. Obter Dados do Formul√°rio
            const diasPrevisao = parseInt(document.getElementById(`dias-previsao-${tipoItem}`).value, 10) || 7;
            const margemSeguranca = (parseInt(document.getElementById(`margem-seguranca-${tipoItem}`).value, 10) || 15) / 100;
            
            let unidadeIdFiltro = null;
            let tipoUnidadeFiltro = null;

            if (modoPrevisao[tipoItem] === 'unidade-especifica') {
                unidadeIdFiltro = document.getElementById(`select-previsao-unidade-${tipoItem}-v2`).value;
                if (!unidadeIdFiltro) {
                    showAlert(alertId, 'Por favor, selecione uma unidade espec√≠fica (Etapa 2).', 'warning');
                    return;
                }
            } else if (modoPrevisao[tipoItem] === 'por-tipo') {
                tipoUnidadeFiltro = document.getElementById(`select-previsao-tipo-${tipoItem}`).value;
                 if (!tipoUnidadeFiltro) {
                    showAlert(alertId, 'Por favor, selecione um tipo de unidade (Etapa 2).', 'warning');
                    return;
                }
            }
            
            // Mostrar container de resultado e loading
            document.getElementById(resultadoContainerId).classList.remove('hidden');
            const resultadoContentEl = document.getElementById(`resultado-content-${tipoItem}`);
            const alertasContentEl = document.getElementById(alertId);
            resultadoContentEl.innerHTML = '<div class="loading-spinner-small mx-auto" style="border-color: #fff; border-top-color: #ccc;"></div>';
            alertasContentEl.innerHTML = ''; // Limpar alertas antigos

            // 3. Filtrar Movimenta√ß√µes
            const movimentacoes = (tipoItem === 'agua') ? fb_agua_movimentacoes : fb_gas_movimentacoes;
            const idsExcluidos = new Set(listaExclusoes[tipoItem].map(item => item.id)); // IDs das unidades a excluir
            
            let movsFiltradas = movimentacoes.filter(m => {
                // (REQ 5.3) Normaliza tipo da movimenta√ß√£o para comparar
                let tipoMov = (m.tipoUnidade || '').toUpperCase();
                if (tipoMov === 'SEMCAS') tipoMov = 'SEDE';

                const isEntrega = m.tipo === 'entrega';
                const hasData = m.data;
                const naoExcluida = !idsExcluidos.has(m.unidadeId);
                const unidadeMatch = !unidadeIdFiltro || m.unidadeId === unidadeIdFiltro;
                // Compara com o tipo J√Å NORMALIZADO do filtro
                const tipoMatch = !tipoUnidadeFiltro || tipoMov === tipoUnidadeFiltro.toUpperCase(); 

                return isEntrega && hasData && naoExcluida && unidadeMatch && tipoMatch;
            });

            // Define t√≠tulo da previs√£o
            let tituloPrevisao = "Previs√£o Completa";
            if (modoPrevisao[tipoItem] === 'unidade-especifica') {
                const unidade = fb_unidades.find(u => u.id === unidadeIdFiltro);
                tituloPrevisao = `Previs√£o para: ${unidade?.nome || 'Unidade Desconhecida'}`;
            } else if (modoPrevisao[tipoItem] === 'por-tipo') {
                tituloPrevisao = `Previs√£o para tipo: ${tipoUnidadeFiltro}`;
            }

            // 4. Calcular M√©dia Di√°ria
            // Precisa de pelo menos 2 registros para calcular intervalo de dias
            if (movsFiltradas.length < 2) {
                resultadoContentEl.innerHTML = `<p class="text-yellow-200">Dados insuficientes para calcular (necess√°rio no m√≠nimo 2 entregas no per√≠odo/filtro).</p>`;
                if (graficoPrevisao[tipoItem]) graficoPrevisao[tipoItem].destroy(); // Limpa gr√°fico antigo se existir
                return;
            }
            
            // Ordena por data para pegar a primeira e √∫ltima
            movsFiltradas.sort((a, b) => a.data.toMillis() - b.data.toMillis());
            
            const primeiraData = movsFiltradas[0].data.toDate();
            const ultimaData = movsFiltradas[movsFiltradas.length - 1].data.toDate();
            
            // Calcula diferen√ßa em dias (considerando o dia inteiro)
            const diffTime = Math.abs(ultimaData.getTime() - primeiraData.getTime());
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            if (diffDays === 0) diffDays = 1; // M√≠nimo 1 dia se forem no mesmo dia
            
            // Calcula total e m√©dia
            const totalQuantidade = movsFiltradas.reduce((sum, m) => sum + (m.quantidade || 0), 0);
            const mediaDiaria = totalQuantidade / diffDays;
            
            // Calcula previs√£o base e com margem
            const previsaoBase = mediaDiaria * diasPrevisao;
            const valorMargem = previsaoBase * margemSeguranca;
            const previsaoFinal = Math.ceil(previsaoBase + valorMargem); // Arredonda para cima

            // 5. Renderizar Resultados na UI
            resultadoContentEl.innerHTML = `
                <h4 class="text-lg font-semibold mb-3">${tituloPrevisao}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div>
                        <span class="text-sm opacity-80 block">M√©dia Di√°ria</span>
                        <span class="text-2xl font-bold">${mediaDiaria.toFixed(2)}</span>
                    </div>
                    <div>
                        <span class="text-sm opacity-80 block">Previs√£o p/ ${diasPrevisao} dias</span>
                        <span class="text-2xl font-bold">${Math.ceil(previsaoBase)}</span>
                    </div>
                    <div>
                        <span class="text-sm opacity-80 block">Total Recomendado (+${(margemSeguranca * 100).toFixed(0)}%)</span>
                        <span class="text-3xl font-bold text-yellow-300">${previsaoFinal}</span>
                    </div>
                </div>
                <p class="text-xs opacity-70 mt-3 text-center">C√°lculo baseado em ${totalQuantidade} unidades entregues entre ${formatTimestamp(movsFiltradas[0].data)} e ${formatTimestamp(movsFiltradas[movsFiltradas.length - 1].data)} (${diffDays} dias).</p>
                 ${listaExclusoes[tipoItem].length > 0 ? `<p class="text-xs opacity-70 mt-1 text-center text-red-200">Exclu√≠das: ${listaExclusoes[tipoItem].map(u=>u.nome).join(', ')}</p>` : ''}
            `;
            
            // 6. Renderizar Gr√°fico de Tend√™ncia
            renderizarGraficoPrevisao(tipoItem, movsFiltradas);
            
            // 7. Gerar Alertas de Estoque Baixo (Opcional)
            const estoqueAtualEl = (tipoItem === 'agua') ? estoqueAguaAtualEl : estoqueGasAtualEl;
            const estoqueAtual = parseInt(estoqueAtualEl?.textContent || '0') || 0;
                
            if (estoqueAtual < previsaoFinal) {
                 alertasContentEl.innerHTML = `
                    <div class="previsao-alerta">
                        <h4 class="font-bold text-yellow-800">Alerta de Estoque Baixo!</h4>
                        <p class="text-sm text-yellow-700">Seu estoque atual (${estoqueAtual}) est√° abaixo da necessidade prevista (${previsaoFinal}) para os pr√≥ximos ${diasPrevisao} dias. Recomenda-se reposi√ß√£o.</p>
                    </div>
                `;
            } else {
                 alertasContentEl.innerHTML = `
                     <div class="alert alert-success"> 
                        <h4 class="font-bold">Estoque Suficiente</h4>
                        <p class="text-sm">Seu estoque atual (${estoqueAtual}) parece suficiente para a demanda prevista (${previsaoFinal}) nos pr√≥ximos ${diasPrevisao} dias.</p>
                     </div>
                 `;
                 // Mostra o alerta de sucesso
                 document.querySelector(`#${alertId} .alert-success`).style.display = 'block'; 
            }
             lucide.createIcons(); // Garante √≠cones nos alertas
        }
        
        // Renderiza o gr√°fico de linha da previs√£o
        function renderizarGraficoPrevisao(tipoItem, movsFiltradas) {
            const canvasId = `grafico-previsao-${tipoItem}`;
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;

            // Agrupa quantidade entregue por dia
            const dadosPorDia = movsFiltradas.reduce((acc, m) => {
                const dataFormatada = formatTimestamp(m.data); // Usa dd/mm/yyyy como chave
                if (!acc[dataFormatada]) {
                    acc[dataFormatada] = { timestamp: m.data.toMillis(), total: 0 };
                }
                acc[dataFormatada].total += m.quantidade;
                return acc;
            }, {});
            
            // Ordena os dias cronologicamente para o gr√°fico
            const diasOrdenados = Object.keys(dadosPorDia).sort((a, b) => dadosPorDia[a].timestamp - dadosPorDia[b].timestamp);
            
            const labels = diasOrdenados;
            const data = diasOrdenados.map(dia => dadosPorDia[dia].total);

            // Destroi gr√°fico anterior se existir
            if (graficoPrevisao[tipoItem]) {
                graficoPrevisao[tipoItem].destroy();
            }
            
            // Cria o novo gr√°fico
            graficoPrevisao[tipoItem] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Consumo Di√°rio (Entregas)',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1 // Suaviza a linha
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Permite controlar altura pelo CSS
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { precision: 0 } // N√∫meros inteiros no eixo Y
                        },
                        x: { 
                            ticks: {
                                autoSkip: true, // Pula labels se ficarem muito juntos
                                maxTicksLimit: 10 // Limita o n√∫mero m√°ximo de labels no eixo X
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false } // Esconde legenda
                    }
                }
            });
        }


        // --- L√ìGICA DE CONTROLE DE MATERIAIS ---
        
        // Salva um registro de separa√ß√£o de material
        async function handleMateriaisSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) { showAlert('alert-materiais', 'Erro: N√£o autenticado.', 'error'); return; }
            const selectValue = selectUnidadeMateriais.value; 
            if (!selectValue) { showAlert('alert-materiais', 'Selecione uma unidade.', 'warning'); return; }
            const [unidadeId, unidadeNome, tipoUnidadeRaw] = selectValue.split('|');
            // (REQ 5.3) Normaliza tipo
            const tipoUnidade = (tipoUnidadeRaw || '').toUpperCase() === 'SEMCAS' ? 'SEDE' : (tipoUnidadeRaw || '').toUpperCase();

            const tipoMaterial = selectTipoMateriais.value;
            const dataSeparacao = dateToTimestamp(inputDataSeparacao.value);
            const itens = textareaItensMateriais.value.trim(); // Observa√ß√£o
            const responsavelSeparacao = capitalizeString(inputResponsavelMateriais.value.trim()); 
             
             if (!unidadeId || !tipoMaterial || !dataSeparacao || !responsavelSeparacao) {
                showAlert('alert-materiais', 'Dados inv√°lidos. Verifique unidade, tipo, data e Respons√°vel (Separa√ß√£o).', 'warning'); return;
            }
            
            btnSubmitMateriais.disabled = true; btnSubmitMateriais.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            
            try {
                // (REQ 6.1) Adiciona documento com status inicial 'separacao'
                await addDoc(materiaisCollection, { 
                    unidadeId, unidadeNome, tipoUnidade, tipoMaterial, 
                    dataSeparacao, itens, status: 'separacao', // Status inicial
                    dataRetirada: null, // (REQ 6.1) Novo campo
                    dataEntrega: null, responsavelSeparacao, 
                    responsavelRetirada: null, // (REQ 6.1) Novo campo (n√£o usado ainda)
                    responsavelEntrega: null, 
                    registradoEm: serverTimestamp() 
                });
                showAlert('alert-materiais', 'Separa√ß√£o registrada!', 'success');
                formMateriais.reset(); // Limpa formul√°rio
                inputDataSeparacao.value = getTodayDateString(); // Reseta data
            } catch (error) { 
                console.error("Erro salvar separa√ß√£o:", error); 
                showAlert('alert-materiais', `Erro: ${error.message}`, 'error');
            } finally { 
                btnSubmitMateriais.disabled = false; 
                btnSubmitMateriais.textContent = 'Registrar Separa√ß√£o'; 
            }
        }

        // (REQ 6.2) Renderiza a tabela de status de materiais (separa√ß√£o/retirada/entregues)
        function renderMateriaisStatus() {
             if (!tableStatusMateriais) return;
            
             // Ordena: Em separa√ß√£o (1), Dispon√≠vel (2), Entregue (3)
             // Depois por data (mais recente primeiro)
            const materiaisOrdenados = [...fb_materiais].sort((a,b) => { 
                const statusOrder = { 'separacao': 1, 'retirada': 2, 'entregue': 3 }; 
                const statusCompare = (statusOrder[a.status] || 9) - (statusOrder[b.status] || 9);
                if (statusCompare !== 0) return statusCompare;
                // Se status for igual, ordena por data (mais recente primeiro)
                const dateA = a.dataEntrega?.toMillis() || a.dataRetirada?.toMillis() || a.dataSeparacao?.toMillis() || 0; 
                const dateB = b.dataEntrega?.toMillis() || b.dataRetirada?.toMillis() || b.dataSeparacao?.toMillis() || 0; 
                return dateB - dateA; 
            });

            if (materiaisOrdenados.length === 0) { 
                tableStatusMateriais.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-500">Nenhuma separa√ß√£o registrada.</td></tr>'; 
                return; 
            }

            // Gera HTML da tabela
            tableStatusMateriais.innerHTML = materiaisOrdenados.map(m => {
                let statusClass = '';
                let statusText = '';
                let dataStatusText = '';
                let acoesHtml = '';
                
                const tooltipText = `Separado por: ${m.responsavelSeparacao || 'N/A'}${m.responsavelEntrega ? ' | Entregue por: '+m.responsavelEntrega : ''}`;
                const isEntregue = m.status === 'entregue';
                
                if (m.status === 'separacao') {
                    statusClass = 'badge-yellow';
                    statusText = 'Em Separa√ß√£o';
                    dataStatusText = ''; // Data da separa√ß√£o j√° est√° na coluna
                    acoesHtml = `
                        <button class="btn-info btn-retirada text-xs py-1 px-2" data-id="${m.id}">Dispon√≠vel p/ Retirada</button>
                    `;
                } else if (m.status === 'retirada') {
                    statusClass = 'badge-green';
                    statusText = 'Dispon√≠vel p/ Retirada';
                    dataStatusText = m.dataRetirada ? ` (${formatTimestamp(m.dataRetirada)})` : '';
                    acoesHtml = `
                        <button class="btn-success btn-entregue text-xs py-1 px-2" data-id="${m.id}">Entregue</button>
                    `;
                } else { // entregue
                    statusClass = 'badge-gray';
                    statusText = 'Entregue';
                    dataStatusText = m.dataEntrega ? ` (${formatTimestamp(m.dataEntrega)})` : '';
                    acoesHtml = ''; // Nenhuma a√ß√£o principal
                }
                
                // Linha principal com dados
                const linhaPrincipal = `
                    <tr class="align-top ${isEntregue ? 'opacity-60' : ''}" title="${tooltipText}">
                        <td class="font-medium">${m.unidadeNome || 'Unidade Desc.'}</td>
                        <td class="capitalize">${m.tipoMaterial || 'N/D'}</td>
                        <td>${formatTimestamp(m.dataSeparacao)}</td>
                        <td><span class="badge ${statusClass}">${statusText}${dataStatusText}</span></td>
                        <td class="text-right space-x-1">
                            ${acoesHtml}
                            <button class="btn-danger btn-remove" data-id="${m.id}" data-type="materiais" title="Remover este registro"><i data-lucide="trash-2"></i></button>
                        </td>
                    </tr>`;
                
                // Linha adicional para observa√ß√£o (se existir)
                const linhaObservacao = m.itens ? `
                    <tr class="obs-row ${isEntregue ? 'opacity-60' : ''} ${m.status === 'separacao' ? 'bg-slate-50' : (m.status === 'retirada' ? 'bg-green-50' : 'bg-gray-50')} border-b-2 border-slate-200">
                        <td colspan="5" class="py-2 px-6 text-sm text-slate-600 whitespace-pre-wrap"><strong>Observa√ß√£o:</strong> ${m.itens}</td>
                    </tr>` : '';

                return linhaPrincipal + linhaObservacao;
            }).join('');
            lucide.createIcons(); // Recria √≠cones
        }

        // (REQ 6.2) Marca um material como dispon√≠vel para retirada
        async function handleMarcarRetirada(e) {
            const button = e.target.closest('button.btn-retirada[data-id]');
            if (!button) return; // Sai se n√£o clicou no bot√£o correto
            
            const materialId = button.dataset.id;
            if (!isAuthReady || !materialId) return;
            
            // Desabilita bot√£o e mostra loading
            button.disabled = true; button.innerHTML = '<div class="loading-spinner-small mx-auto" style="width: 16px; height: 16px; border-width: 2px;"></div>';
            
            try {
                // Atualiza documento no Firestore
                const docRef = doc(materiaisCollection, materialId);
                await updateDoc(docRef, { 
                    status: 'retirada', // Novo status
                    dataRetirada: serverTimestamp() // Data atual do servidor
                });
                showAlert('alert-materiais-lista', 'Material marcado como Dispon√≠vel para Retirada!', 'success', 3000);
            } catch (error) { 
                console.error("Erro marcar p/ retirada:", error); 
                showAlert('alert-materiais-lista', `Erro: ${error.message}`, 'error'); 
                // Reabilita bot√£o em caso de erro
                button.disabled = false; 
                button.textContent = 'Dispon√≠vel p/ Retirada'; 
            }
        }

        // (REQ 6.3) Marca um material como entregue (vindo do status 'retirada')
        async function handleMarcarEntregue(e) {
            const button = e.target.closest('button.btn-entregue[data-id]');
            if (!button) return; // Sai se n√£o clicou no bot√£o correto
            
            const materialId = button.dataset.id;
            if (!isAuthReady || !materialId) return;
            
            // Pede nome do respons√°vel pela entrega
            const responsavelEntrega = prompt("Nome do respons√°vel pela entrega/retirada:");
            if (!responsavelEntrega) { // Se cancelar ou deixar vazio
                 showAlert('alert-materiais-lista', 'Nome do respons√°vel √© obrigat√≥rio para marcar como entregue.', 'warning');
                 return; 
            }
            
            // Desabilita bot√£o e mostra loading
            button.disabled = true; button.innerHTML = '<div class="loading-spinner-small mx-auto" style="width: 16px; height: 16px; border-width: 2px;"></div>';
            
            try {
                // Atualiza documento no Firestore
                const docRef = doc(materiaisCollection, materialId);
                await updateDoc(docRef, { 
                    status: 'entregue', 
                    dataEntrega: serverTimestamp(), // Data atual do servidor
                    responsavelEntrega: capitalizeString(responsavelEntrega) 
                });
                showAlert('alert-materiais-lista', 'Material marcado como entregue!', 'success', 3000);
            } catch (error) { 
                console.error("Erro marcar entregue:", error); 
                showAlert('alert-materiais-lista', `Erro: ${error.message}`, 'error'); 
                // Reabilita bot√£o em caso de erro
                button.disabled = false; 
                button.textContent = 'Entregue'; 
            } 
            // Bot√£o n√£o precisa ser reabilitado em caso de sucesso, pois ele some da UI
        }
        
        // --- L√ìGICA DE GEST√ÉO DE UNIDADES ---
        
        // Renderiza a tabela de gest√£o de unidades
        function renderGestaoUnidades() {
            if (!tableGestaoUnidades) return;
            
            // Aplica filtros de nome e tipo
            const filtroNome = normalizeString(filtroUnidadeNome.value);
            const filtroTipo = normalizeString(filtroUnidadeTipo.value);
            const unidadesFiltradas = fb_unidades.filter(unidade => {
                const nomeNormalizado = normalizeString(unidade.nome);
                // (REQ 5.3) Normaliza tipo para filtro
                let tipoNormalizado = normalizeString(unidade.tipo);
                if (tipoNormalizado === 'semcas') tipoNormalizado = 'sede';
                
                const nomeMatch = !filtroNome || nomeNormalizado.includes(filtroNome);
                const tipoMatch = !filtroTipo || tipoNormalizado.includes(normalizeString(filtroTipo));
                return nomeMatch && tipoMatch;
            });

            // Renderiza HTML da tabela
            if (unidadesFiltradas.length === 0) { 
                tableGestaoUnidades.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-slate-500">Nenhuma unidade encontrada ${ (filtroNome || filtroTipo) ? 'com estes filtros' : 'cadastrada. Adicione abaixo.'}</td></tr>`; 
                return; 
            }
            tableGestaoUnidades.innerHTML = unidadesFiltradas.map(unidade => {
                 // (REQ 5.3) Mostra 'SEDE' mesmo que o tipo original seja 'SEMCAS'
                 let tipoDisplay = (unidade.tipo || 'N/A').toUpperCase();
                 if (tipoDisplay === 'SEMCAS') tipoDisplay = 'SEDE';
                 return `
                    <tr data-unidade-id="${unidade.id}">
                        <td class="font-medium">
                            <span class="unidade-nome-display">${unidade.nome}</span>
                            <button class="btn-icon btn-edit-unidade ml-1" title="Editar nome"><i data-lucide="pencil"></i></button>
                        </td>
                        <td>${tipoDisplay}</td>
                        <td class="text-center"><input type="checkbox" class="form-toggle gestao-toggle" data-field="atendeAgua" ${(unidade.atendeAgua ?? true) ? 'checked' : ''}></td>
                        <td class="text-center"><input type="checkbox" class="form-toggle gestao-toggle" data-field="atendeGas" ${(unidade.atendeGas ?? true) ? 'checked' : ''}></td>
                        <td class="text-center"><input type="checkbox" class="form-toggle gestao-toggle" data-field="atendeMateriais" ${(unidade.atendeMateriais ?? true) ? 'checked' : ''}></td>
                        <td class="text-center">
                            <button class="btn-danger btn-remove" data-id="${unidade.id}" data-type="unidade" data-details="${unidade.nome} (${tipoDisplay})" title="Remover esta unidade e seu hist√≥rico"><i data-lucide="trash-2"></i></button>
                        </td>
                    </tr>`
            }).join('');
            lucide.createIcons(); 
        }

        // Atualiza status (atendeAgua, etc.) de uma unidade ao clicar no checkbox
        async function handleGestaoToggle(e) {
            const checkbox = e.target.closest('.gestao-toggle'); 
            if (!checkbox) return; // Sai se n√£o foi um checkbox de gest√£o
            
            const row = checkbox.closest('tr');
            const id = row?.dataset.unidadeId; 
            const field = checkbox.dataset.field; // Campo a atualizar (ex: 'atendeAgua')
            const value = checkbox.checked; // Novo valor (true/false)
            
            if (!isAuthReady || !id || !field) return; 
            
            checkbox.disabled = true; // Desabilita enquanto salva
            
            try {
                // Atualiza documento no Firestore
                const docRef = doc(unidadesCollection, id); 
                await updateDoc(docRef, { [field]: value });
                
                // Atualiza localmente para refletir na UI imediatamente (opcional, listener far√° isso)
                // const localUnidade = fb_unidades.find(u => u.id === id); 
                // if (localUnidade) localUnidade[field] = value;
                
                showAlert('alert-gestao', 'Status atualizado!', 'success', 2000);
            } catch (error) { 
                console.error("Erro atualizar unidade:", error); 
                showAlert('alert-gestao', `Erro: ${error.message}`, 'error'); 
                checkbox.checked = !value; // Reverte a mudan√ßa na UI em caso de erro
            } finally { 
                checkbox.disabled = false; // Reabilita checkbox
            }
        }

        // Habilita edi√ß√£o do nome da unidade (substitui texto por input)
        function handleEditUnidadeClick(e) {
            const button = e.target.closest('.btn-edit-unidade');
            if (!button) return;
            
            // Encontra elementos relevantes (c√©lula, linha, ID, span do nome)
            const td = button.closest('td');
            const row = td.closest('tr');
            const unidadeId = row.dataset.unidadeId;
            const nomeSpan = td.querySelector('.unidade-nome-display');
            const currentName = nomeSpan.textContent;

            // Substitui o conte√∫do da c√©lula pelo input e bot√µes Salvar/Cancelar
            td.innerHTML = `
                <input type="text" value="${currentName}" class="edit-input w-full" placeholder="Novo nome da unidade">
                <div class="mt-1 space-x-1">
                    <button class="btn-icon btn-save-unidade text-green-600 hover:text-green-800" title="Salvar"><i data-lucide="save"></i></button>
                    <button class="btn-icon btn-cancel-edit-unidade text-red-600 hover:text-red-800" title="Cancelar"><i data-lucide="x-circle"></i></button>
                </div>
            `;
            row.classList.add('editing-row'); // Adiciona classe para evitar que filtro esconda a linha
            lucide.createIcons(); // Recria √≠cones
            td.querySelector('input').focus(); // Foca no input
        }

        // Cancela a edi√ß√£o do nome (restaura o texto original)
        function handleCancelEditUnidadeClick(e) {
            const button = e.target.closest('.btn-cancel-edit-unidade');
            if (!button) return;
            
            const td = button.closest('td');
            const row = td.closest('tr');
            const unidadeId = row.dataset.unidadeId;
            // Busca o nome original do array local
            const unidade = fb_unidades.find(u => u.id === unidadeId);
            
            // Restaura o HTML original da c√©lula
            td.innerHTML = `
                <span class="unidade-nome-display">${unidade?.nome || 'Erro'}</span> 
                <button class="btn-icon btn-edit-unidade ml-1" title="Editar nome"><i data-lucide="pencil"></i></button>
            `;
            row.classList.remove('editing-row'); // Remove classe de edi√ß√£o
            lucide.createIcons(); // Recria √≠cones
        }

        // Salva o novo nome da unidade no Firestore
        async function handleSaveUnidadeClick(e) {
            const button = e.target.closest('.btn-save-unidade');
            if (!button) return;
            
            const td = button.closest('td');
            const row = td.closest('tr');
            const unidadeId = row.dataset.unidadeId;
            const input = td.querySelector('.edit-input');
            const newName = capitalizeString(input.value.trim()); // Pega e normaliza novo nome

            // Valida√ß√£o simples
            if (!newName) {
                showAlert('alert-gestao', 'O nome da unidade n√£o pode ser vazio.', 'warning');
                input.focus();
                return;
            }

            // Desabilita bot√µes e mostra loading
            button.disabled = true;
            const cancelButton = td.querySelector('.btn-cancel-edit-unidade');
            if(cancelButton) cancelButton.disabled = true;
            button.innerHTML = '<div class="loading-spinner-small inline-block" style="width: 1em; height: 1em; border-width: 2px;"></div>';

            try {
                // Atualiza documento no Firestore
                const docRef = doc(unidadesCollection, unidadeId);
                await updateDoc(docRef, { nome: newName });
                
                // Restaura a visualiza√ß√£o normal (o listener atualizar√° o array fb_unidades)
                td.innerHTML = `
                    <span class="unidade-nome-display">${newName}</span>
                    <button class="btn-icon btn-edit-unidade ml-1" title="Editar nome"><i data-lucide="pencil"></i></button>
                `;
                 row.classList.remove('editing-row'); // Remove classe de edi√ß√£o
                lucide.createIcons(); // Recria √≠cones
                showAlert('alert-gestao', 'Nome da unidade atualizado!', 'success', 2000);
            
            } catch (error) {
                console.error("Erro ao salvar nome da unidade:", error);
                showAlert('alert-gestao', `Erro ao salvar: ${error.message}`, 'error');
                // Reabilita bot√µes em caso de erro
                button.disabled = false;
                 if(cancelButton) cancelButton.disabled = false;
                button.innerHTML = '<i data-lucide="save"></i>'; // Restaura √≠cone
                lucide.createIcons();
            }
        }

        // Adiciona unidades em lote a partir do textarea
        async function handleBulkAddUnidades() {
             if (!isAuthReady || !textareaBulkUnidades) return;
             
             const text = textareaBulkUnidades.value.trim();
             if (!text) { showAlert('alert-gestao', 'A √°rea de texto est√° vazia.', 'warning'); return; }
             
             const lines = text.split('\n');
             const unidadesParaAdd = [];
             const erros = [];
             
             // Processa cada linha
             lines.forEach((line, index) => {
                 const parts = line.split('\t'); // Separa por TAB
                 if (parts.length === 2) {
                     // (REQ 5.3) Normaliza tipo para SEDE se for SEMCAS
                     let tipo = parts[0].trim().toUpperCase(); 
                     if (tipo === 'SEMCAS') tipo = 'SEDE';
                     const nome = capitalizeString(parts[1].trim()); 
                     
                     if (tipo && nome) {
                         // Verifica se j√° existe (comparando normalizado)
                         const existe = fb_unidades.some(u => {
                             let uTipo = (u.tipo || '').toUpperCase();
                             if (uTipo === 'SEMCAS') uTipo = 'SEDE';
                             return normalizeString(u.nome) === normalizeString(nome) && uTipo === tipo;
                         });
                         if (!existe) {
                             // Adiciona √† lista para salvar
                             unidadesParaAdd.push({ nome, tipo, atendeAgua: true, atendeGas: true, atendeMateriais: true });
                         } else {
                             console.log(`Unidade j√° existe (ignorada): ${tipo} - ${nome}`);
                         }
                     } else { erros.push(`Linha ${index + 1}: Tipo ou Nome vazio.`); }
                 } else if (line.trim()) { // Linha n√£o vazia com formato errado
                     erros.push(`Linha ${index + 1}: Formato inv√°lido (use TIPO [TAB] NOME).`);
                 }
             });

             // Se n√£o h√° unidades novas v√°lidas
             if (unidadesParaAdd.length === 0) {
                 showAlert('alert-gestao', 'Nenhuma unidade nova para adicionar (ou todas j√° existem/formato inv√°lido).', 'info');
                 if(erros.length > 0) console.warn("Erros na importa√ß√£o:", erros);
                 return;
             }
             
             // Desabilita bot√£o e mostra loading
             btnBulkAddUnidades.disabled = true; btnBulkAddUnidades.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
             let adicionadasCount = 0;
             
             try {
                 // Adiciona cada unidade nova ao Firestore
                 for (const unidade of unidadesParaAdd) {
                     await addDoc(unidadesCollection, unidade);
                     adicionadasCount++;
                 }
                 showAlert('alert-gestao', `${adicionadasCount} unidade(s) adicionada(s) com sucesso!`, 'success');
                 textareaBulkUnidades.value = ''; // Limpa textarea
                 
                 // Alerta sobre erros/avisos se houver
                 if(erros.length > 0) {
                      showAlert('alert-gestao', `Algumas linhas foram ignoradas por erros de formato ou por j√° existirem. Verifique o console (F12) para detalhes.`, 'warning', 8000);
                      console.warn("Erros/Avisos na importa√ß√£o:", erros);
                 }
             } catch (error) {
                 console.error("Erro ao adicionar unidades em lote:", error);
                 showAlert('alert-gestao', `Erro ao adicionar unidades: ${error.message}. ${adicionadasCount} foram adicionadas antes do erro.`, 'error');
             } finally {
                 // Reabilita bot√£o
                 btnBulkAddUnidades.disabled = false; btnBulkAddUnidades.textContent = 'Adicionar Unidades';
             }
        }

        // --- L√ìGICA DO DASHBOARD ---
        
        // Troca a visualiza√ß√£o dentro do Dashboard (Geral, √Ågua, G√°s, Materiais)
        function switchDashboardView(viewName) {
            // Atualiza bot√µes de navega√ß√£o do dashboard
            document.querySelectorAll('#dashboard-nav-controls .dashboard-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });
            // Mostra/esconde pain√©is de conte√∫do do dashboard
            document.querySelectorAll('.dashboard-tv-view > div[id^="dashboard-view-"]').forEach(pane => {
                 pane.classList.toggle('hidden', pane.id !== `dashboard-view-${viewName}`);
            });
            
            // Renderiza conte√∫do espec√≠fico da vis√£o ativa
            if(viewName === 'agua') renderDashboardAguaChart();
            if(viewName === 'gas') renderDashboardGasChart();
            if(viewName === 'geral') {
                renderDashboardVisaoGeralSummary(); 
                renderDashboardMateriaisProntos();
            }
            if(viewName === 'materiais') renderDashboardMateriaisList();
        }

        // Atualiza os cards de resumo da vis√£o GERAL do dashboard
        function renderDashboardVisaoGeralSummary() {
            if (dashboardEstoqueAguaEl) {
                dashboardEstoqueAguaEl.textContent = estoqueAguaAtualEl?.textContent || '0';
            }
            if (dashboardEstoqueGasEl) {
                dashboardEstoqueGasEl.textContent = estoqueGasAtualEl?.textContent || '0';
            }
            // A contagem de materiais √© feita em renderDashboardMateriaisCounts()
        }
        
        // (REQ 6.4) Atualiza os cards "Em Separa√ß√£o" e "Dispon√≠vel p/ Retirada"
        function renderDashboardMateriaisCounts() {
            if (!dashboardMateriaisSeparacaoCountEl || !dashboardMateriaisRetiradaCountEl) return;
            const separacaoCount = fb_materiais.filter(m => m.status === 'separacao').length;
            const retiradaCount = fb_materiais.filter(m => m.status === 'retirada').length;
            
            dashboardMateriaisSeparacaoCountEl.textContent = separacaoCount;
            dashboardMateriaisRetiradaCountEl.textContent = retiradaCount;
        }

        // Filtra um array de movimenta√ß√µes para incluir apenas os √∫ltimos 30 dias
        function filterLast30Days(movimentacoes) {
            const today = new Date(); 
            today.setHours(23, 59, 59, 999); // Final do dia de hoje
            const thirtyDaysAgo = new Date(today); 
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); // 30 dias atr√°s
            thirtyDaysAgo.setHours(0, 0, 0, 0); // In√≠cio do dia
            
            const thirtyDaysAgoTimestamp = thirtyDaysAgo.getTime();
            const todayTimestamp = today.getTime();
            
            return movimentacoes.filter(m => {
                if (!m.data || typeof m.data.toDate !== 'function') return false; // Ignora se n√£o tiver data v√°lida
                const mTimestamp = m.data.toMillis();
                return mTimestamp >= thirtyDaysAgoTimestamp && mTimestamp <= todayTimestamp;
            });
        }

        // Prepara dados para os gr√°ficos de linha (√Ågua/G√°s) dos √∫ltimos 30 dias
        function getChartDataLast30Days(movimentacoes) {
            const labels = []; const entregasData = []; const retornosData = []; 
            const dataMap = new Map(); // Mapa para acumular dados por dia
            
            // Cria entradas no mapa para os √∫ltimos 30 dias (garante que todos os dias apare√ßam)
            const today = new Date(); today.setHours(0, 0, 0, 0);
            for (let i = 29; i >= 0; i--) { 
                const d = new Date(today); 
                d.setDate(d.getDate() - i); 
                const dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; 
                const dateLabel = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); 
                labels.push(dateLabel); 
                dataMap.set(dateKey, { entregas: 0, retornos: 0 }); // Inicializa contadores
            }

            // Filtra movimenta√ß√µes dos √∫ltimos 30 dias
            const movs30Dias = filterLast30Days(movimentacoes);
            
            // Acumula quantidades por dia no mapa
            movs30Dias.forEach(m => { 
                const mDate = m.data.toDate(); 
                mDate.setHours(0,0,0,0); // Normaliza para in√≠cio do dia
                const dateKey = `${mDate.getFullYear()}-${String(mDate.getMonth() + 1).padStart(2, '0')}-${String(mDate.getDate()).padStart(2, '0')}`; 
                if (dataMap.has(dateKey)) { 
                    const dayData = dataMap.get(dateKey); 
                    if (m.tipo === 'entrega') dayData.entregas += m.quantidade; 
                    else if (m.tipo === 'retorno') dayData.retornos += m.quantidade; 
                } 
            });

            // Extrai dados do mapa para arrays do Chart.js
            dataMap.forEach(value => { 
                entregasData.push(value.entregas); 
                retornosData.push(value.retornos); 
            });

            // Retorna estrutura de dados esperada pelo Chart.js
            return { 
                labels, 
                datasets: [ 
                    { label: 'Entregues (Cheios)', data: entregasData, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, tension: 0.1 }, 
                    { label: 'Recebidos (Vazios)', data: retornosData, backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: 'rgba(16, 185, 129, 1)', borderWidth: 1, tension: 0.1 } 
                ] 
            };
        }

        // Renderiza ou atualiza o gr√°fico de √Ågua no Dashboard
        function renderDashboardAguaChart() {
            const ctx = document.getElementById('dashboardAguaChart')?.getContext('2d'); if (!ctx) return; 
            const data = getChartDataLast30Days(fb_agua_movimentacoes); 
            // Atualiza dados se gr√°fico j√° existe, sen√£o cria um novo
            if (dashboardAguaChartInstance) { 
                dashboardAguaChartInstance.data = data; 
                dashboardAguaChartInstance.update(); 
            } else { 
                dashboardAguaChartInstance = new Chart(ctx, { type: 'line', data: data, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { position: 'top' } } } }); 
            }
        }
        
        // Renderiza ou atualiza o gr√°fico de G√°s no Dashboard
        function renderDashboardGasChart() {
            const ctx = document.getElementById('dashboardGasChart')?.getContext('2d'); if (!ctx) return; 
            const data = getChartDataLast30Days(fb_gas_movimentacoes); 
            // Atualiza dados se gr√°fico j√° existe, sen√£o cria um novo
            if (dashboardGasChartInstance) { 
                dashboardGasChartInstance.data = data; 
                dashboardGasChartInstance.update(); 
            } else { 
                dashboardGasChartInstance = new Chart(ctx, { type: 'line', data: data, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { position: 'top' } } } }); 
            }
        }
        
        // Atualiza os cards de resumo na vis√£o de √ÅGUA do dashboard
        function renderDashboardAguaSummary() {
            if (!summaryAguaPendente) return; // Sai se elemento n√£o existe
            // Calcula totais GERAIS (hist√≥rico completo)
            const totalEntregueGeral = fb_agua_movimentacoes.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const totalRecebidoGeral = fb_agua_movimentacoes.filter(m => m.tipo === 'retorno').reduce((sum, m) => sum + m.quantidade, 0);
            summaryAguaPendente.textContent = totalEntregueGeral - totalRecebidoGeral; // Saldo total
            
            // Calcula totais dos √öLTIMOS 30 DIAS
            const movs30Dias = filterLast30Days(fb_agua_movimentacoes);
            const totalEntregue30d = movs30Dias.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const totalRecebido30d = movs30Dias.filter(m => m.tipo === 'retorno').reduce((sum, m) => sum + m.quantidade, 0);
            summaryAguaEntregue.textContent = totalEntregue30d;
            summaryAguaRecebido.textContent = totalRecebido30d;
            
            renderDashboardVisaoGeralSummary(); // Atualiza card de estoque na vis√£o geral
        }

        // Atualiza os cards de resumo na vis√£o de G√ÅS do dashboard
        function renderDashboardGasSummary() {
             if (!summaryGasPendente) return; // Sai se elemento n√£o existe
            // Calcula totais GERAIS
            const totalEntregueGeral = fb_gas_movimentacoes.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const totalRecebidoGeral = fb_gas_movimentacoes.filter(m => m.tipo === 'retorno').reduce((sum, m) => sum + m.quantidade, 0);
            summaryGasPendente.textContent = totalEntregueGeral - totalRecebidoGeral; // Saldo total
            
            // Calcula totais dos √öLTIMOS 30 DIAS
            const movs30Dias = filterLast30Days(fb_gas_movimentacoes);
            const totalEntregue30d = movs30Dias.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const totalRecebido30d = movs30Dias.filter(m => m.tipo === 'retorno').reduce((sum, m) => sum + m.quantidade, 0);
            summaryGasEntregue.textContent = totalEntregue30d;
            summaryGasRecebido.textContent = totalRecebido30d;
            
            renderDashboardVisaoGeralSummary(); // Atualiza card de estoque na vis√£o geral
        }

        // (REQ 6.6) Renderiza a lista de materiais pendentes (separacao e retirada) na vis√£o de MATERIAIS do dashboard
        function renderDashboardMateriaisList() {
             if (!dashboardMateriaisListContainer || !loadingMateriaisDashboard) return; 
             loadingMateriaisDashboard.style.display = 'none'; // Esconde loading
             
             // Filtra e ordena materiais pendentes (separacao primeiro, depois retirada, depois mais antigos)
            const pendentes = fb_materiais
                .filter(m => m.status === 'separacao' || m.status === 'retirada')
                .sort((a,b) => { 
                    const statusOrder = { 'separacao': 1, 'retirada': 2 }; 
                    const statusCompare = (statusOrder[a.status] || 9) - (statusOrder[b.status] || 9);
                    if (statusCompare !== 0) return statusCompare;
                    return (a.dataSeparacao?.toMillis() || 0) - (b.dataSeparacao?.toMillis() || 0); // Mais antigos primeiro
                }); 
            
            // Renderiza HTML da lista
            if (pendentes.length === 0) { 
                dashboardMateriaisListContainer.innerHTML = '<p class="text-sm text-slate-500 text-center py-4">Nenhum material pendente.</p>'; 
                return; 
            }
            dashboardMateriaisListContainer.innerHTML = pendentes.map(m => {
                const isSeparacao = m.status === 'separacao';
                const badgeClass = isSeparacao ? 'badge-yellow' : 'badge-green';
                const badgeText = isSeparacao ? 'Em Separa√ß√£o' : 'Dispon√≠vel';
                const bgColor = isSeparacao ? 'bg-slate-50' : 'bg-green-50';
                const borderColor = isSeparacao ? 'border-slate-200' : 'border-green-300';

                return ` 
                    <div class="p-3 ${bgColor} rounded-lg border ${borderColor}"> 
                        <div class="flex justify-between items-center gap-2"> 
                            <span class="font-medium text-slate-700 text-sm truncate" title="${m.unidadeNome || ''}">${m.unidadeNome || 'Unidade Desc.'}</span> 
                            <span class="badge ${badgeClass} flex-shrink-0">${badgeText} (${formatTimestamp(m.dataSeparacao)})</span> 
                        </div> 
                        <p class="text-xs text-slate-600 capitalize mt-1">${m.tipoMaterial || 'N/D'}</p> 
                        ${m.itens ? `<p class="text-xs text-gray-500 mt-1 truncate" title="${m.itens}">Obs: ${m.itens}</p>` : ''} 
                    </div> `
            }).join('');
        }
        
        // (REQ 6.5) Renderiza as colunas de materiais pendentes (separacao e retirada) por TIPO DE UNIDADE na vis√£o GERAL do dashboard
        function renderDashboardMateriaisProntos() {
            if (!dashboardMateriaisProntosContainer || !loadingMateriaisProntos) return;
            loadingMateriaisProntos.style.display = 'none'; // Esconde loading
            
            const pendentes = fb_materiais.filter(m => m.status === 'separacao' || m.status === 'retirada');
            
            if (pendentes.length === 0) {
                dashboardMateriaisProntosContainer.innerHTML = '<p class="text-sm text-slate-500 text-center py-4 col-span-full">Nenhum material pendente.</p>';
                return;
            }

            // Agrupa unidades pendentes por TIPO DE UNIDADE, depois por STATUS, depois por NOME DA UNIDADE
            const gruposTipoUnidade = pendentes.reduce((acc, m) => {
                // Normaliza tipo para agrupar
                let tipoUnidade = (m.tipoUnidade || 'OUTROS').toUpperCase();
                if (tipoUnidade === 'SEMCAS') tipoUnidade = 'SEDE'; 
                
                if (!acc[tipoUnidade]) acc[tipoUnidade] = { separacao: {}, retirada: {} };
                
                const statusGrupo = m.status; // 'separacao' ou 'retirada'
                const unidadeNome = m.unidadeNome || 'Desconhecida';

                if (!acc[tipoUnidade][statusGrupo][unidadeNome]) { 
                    acc[tipoUnidade][statusGrupo][unidadeNome] = new Set(); 
                }
                acc[tipoUnidade][statusGrupo][unidadeNome].add(m.tipoMaterial || 'N/D'); 
                return acc;
            }, {});

            // Define ordem das colunas (tipos de unidade)
            const ordemColunas = ['CT', 'SEDE', 'CRAS', 'CREAS', 'ABRIGO'];
            // Adiciona outros tipos que possam existir e n√£o est√£o na ordem padr√£o
            Object.keys(gruposTipoUnidade).forEach(tipo => { if (!ordemColunas.includes(tipo)) ordemColunas.push(tipo); });

            // Gera HTML das colunas
            let html = '';
            let colunasRenderizadas = 0;
            ordemColunas.forEach(tipoUnidade => {
                if (gruposTipoUnidade[tipoUnidade]) { // S√≥ renderiza se houver unidades desse tipo
                    const unidadesSeparacao = gruposTipoUnidade[tipoUnidade].separacao;
                    const unidadesRetirada = gruposTipoUnidade[tipoUnidade].retirada;
                    const temSeparacao = Object.keys(unidadesSeparacao).length > 0;
                    const temRetirada = Object.keys(unidadesRetirada).length > 0;

                    if (!temSeparacao && !temRetirada) return; // Pula se este tipo n√£o tiver nada pendente

                    colunasRenderizadas++;
                    html += `<div class="materiais-prontos-col"><h4>${tipoUnidade}</h4><ul class="space-y-3">`; 
                    
                    // Renderiza "Em Separa√ß√£o"
                    if(temSeparacao) {
                        if(temRetirada) html += `<h5>Em Separa√ß√£o</h5>`; // S√≥ mostra subt√≠tulo se houver os dois
                        const unidadesOrdenadas = Object.keys(unidadesSeparacao).sort(); 
                        unidadesOrdenadas.forEach(unidadeNome => {
                            const tiposMateriais = Array.from(unidadesSeparacao[unidadeNome]).join(', ');
                            html += `<li><strong>${unidadeNome}</strong><br><span class="capitalize">(${tiposMateriais})</span></li>`; 
                        });
                    }

                    // Renderiza "Dispon√≠vel p/ Retirada"
                    if(temRetirada) {
                         if(temSeparacao) html += `<h5 class="pt-2 border-t border-slate-200">Dispon√≠vel p/ Retirada</h5>`; // Subt√≠tulo com separador
                         const unidadesOrdenadas = Object.keys(unidadesRetirada).sort();
                         unidadesOrdenadas.forEach(unidadeNome => {
                            const tiposMateriais = Array.from(unidadesRetirada[unidadeNome]).join(', ');
                            // (REQ 6.5) Adiciona classe 'item-retirada' e √≠cone
                            html += `<li class="item-retirada">
                                        <div class="flex items-center gap-1">
                                            <i data-lucide="check-circle"></i>
                                            <strong>${unidadeNome}</strong>
                                        </div>
                                        <span class="capitalize ml-5">(${tiposMateriais})</span>
                                     </li>`; 
                        });
                    }
                    
                    html += `</ul></div>`;
                }
            });

            // Insere HTML no container
            dashboardMateriaisProntosContainer.innerHTML = colunasRenderizadas > 0 ? html : '<p class="text-sm text-slate-500 text-center py-4 col-span-full">Nenhum material pendente.</p>';
            lucide.createIcons(); // Recria √≠cones (importante para o √≠cone de check)
        }
        
        // Inicia o intervalo de atualiza√ß√£o autom√°tica do Dashboard
        function startDashboardRefresh() {
            stopDashboardRefresh(); // Garante que n√£o haja intervalos duplicados
            console.log("Iniciando auto-refresh do Dashboard (2 min)");
            dashboardRefreshInterval = setInterval(() => {
                // Para o refresh se sair da aba Dashboard
                if (visaoAtiva !== 'dashboard') { stopDashboardRefresh(); return; }
                console.log("Atualizando dados do Dashboard (auto-refresh)...");
                // Renderiza gr√°ficos e sum√°rios
                renderDashboardAguaChart(); renderDashboardGasChart();
                renderDashboardAguaSummary(); renderDashboardGasSummary();
                renderDashboardMateriaisList(); renderDashboardMateriaisProntos();
                renderDashboardVisaoGeralSummary(); 
                renderDashboardMateriaisCounts(); // (REQ 6.4)
                updateLastUpdateTime(); // Atualiza hora
            }, 120000); // 120000 ms = 2 minutos
        }

        // Para o intervalo de atualiza√ß√£o autom√°tica
        function stopDashboardRefresh() {
            if (dashboardRefreshInterval) {
                console.log("Parando auto-refresh do Dashboard");
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }
        }

        // --- L√ìGICA DE RELAT√ìRIO PDF ---
        
        // Gera o relat√≥rio PDF de fornecimento (√Ågua ou G√°s)
        function handleGerarPdf() {
            // Verifica se as bibliotecas jsPDF e jsPDF-AutoTable est√£o carregadas
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.AutoTable === 'undefined') {
                showAlert('alert-relatorio', 'Erro: Bibliotecas PDF n√£o carregadas. Tente recarregar a p√°gina.', 'error'); return;
            }
            const { jsPDF } = window.jspdf;
            const autoTable = window.jspdf.AutoTable; // Alias para jsPDF.AutoTable

            // Obt√©m dados do formul√°rio
            const tipo = relatorioTipo.value; // 'agua' ou 'gas'
            const dataInicioStr = relatorioDataInicio.value;
            const dataFimStr = relatorioDataFim.value;

            if (!dataInicioStr || !dataFimStr) { showAlert('alert-relatorio', 'Selecione a data de in√≠cio e fim.', 'warning'); return; }

            // Converte datas para timestamps (millisegundos) para facilitar compara√ß√£o
            const dataInicio = dateToTimestamp(dataInicioStr).toMillis();
            // Adiciona 1 dia menos 1ms ao fim para incluir todo o dia final
            const dataFim = dateToTimestamp(dataFimStr).toMillis() + (24 * 60 * 60 * 1000 - 1); 

            // Seleciona as movimenta√ß√µes corretas (√°gua ou g√°s)
            const movimentacoes = (tipo === 'agua' ? fb_agua_movimentacoes : fb_gas_movimentacoes);
            const tipoLabel = (tipo === 'agua' ? '√Ågua' : 'G√°s');

            // Filtra movimenta√ß√µes de ENTREGA dentro do per√≠odo selecionado
            const movsFiltradas = movimentacoes.filter(m => { 
                const mData = m.data?.toMillis(); 
                return m.tipo === 'entrega' && mData >= dataInicio && mData <= dataFim; 
            });

            if (movsFiltradas.length === 0) { showAlert('alert-relatorio', 'Nenhum dado de entrega encontrado para este per√≠odo.', 'info'); return; }
            
            // Desabilita bot√£o e mostra loading
            btnGerarPdf.disabled = true; btnGerarPdf.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            
            try {
                const doc = new jsPDF(); // Cria novo documento PDF

                // Agrupa quantidade entregue por UNIDADE
                const abastecimentoMap = new Map(); 
                movsFiltradas.forEach(m => { 
                    const nome = m.unidadeNome || 'Desconhecida'; 
                    const atual = abastecimentoMap.get(nome) || 0; 
                    abastecimentoMap.set(nome, atual + m.quantidade); 
                });
                // Converte mapa para array e ordena por quantidade (maior primeiro)
                const abastecimentoData = Array.from(abastecimentoMap.entries())
                    .sort((a,b) => b[1] - a[1]) // Ordena [nome, qtd] pela qtd (b[1] - a[1])
                    .map(entry => [entry[0], entry[1]]); // Formato esperado pelo autoTable

                // Agrupa quantidade entregue por RESPONS√ÅVEL (quem recebeu na unidade)
                const responsavelMap = new Map(); 
                movsFiltradas.forEach(m => { 
                    const nome = m.responsavel || 'N√£o identificado'; 
                    const atual = responsavelMap.get(nome) || 0; 
                    responsavelMap.set(nome, atual + m.quantidade); 
                });
                // Converte mapa para array e ordena por quantidade
                const responsavelData = Array.from(responsavelMap.entries())
                    .sort((a,b) => b[1] - a[1])
                    .map(entry => [entry[0], entry[1]]);

                // --- Adiciona conte√∫do ao PDF ---
                doc.setFontSize(16); doc.text(`Relat√≥rio de Fornecimento - ${tipoLabel}`, 14, 20);
                doc.setFontSize(10); doc.text(`Per√≠odo: ${formatTimestamp(Timestamp.fromMillis(dataInicio))} a ${formatTimestamp(Timestamp.fromMillis(dataFim))}`, 14, 26);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 32);

                // Tabela 1: Entregas por Unidade
                autoTable(doc, { 
                    startY: 40, // Posi√ß√£o inicial Y
                    head: [['Relat√≥rio de Entregas por Unidade']], // T√≠tulo da tabela
                    body: [[]], // Corpo vazio, apenas para o t√≠tulo
                    theme: 'plain', // Sem linhas/bordas
                    styles: { fontSize: 12, fontStyle: 'bold' } 
                });
                autoTable(doc, { 
                    head: [['Unidade', 'Quantidade Fornecida']], 
                    body: abastecimentoData, 
                    theme: 'striped', // Linhas alternadas
                    headStyles: { fillColor: [22, 160, 133] } // Cor do cabe√ßalho
                });

                // Tabela 2: Recebimento por Respons√°vel
                autoTable(doc, { 
                    startY: doc.lastAutoTable.finalY + 15, // Come√ßa abaixo da tabela anterior
                    head: [['Relat√≥rio de Recebimento por Respons√°vel']], 
                    body: [[]], 
                    theme: 'plain', 
                    styles: { fontSize: 12, fontStyle: 'bold' } 
                });
                autoTable(doc, { 
                    head: [['Respons√°vel', 'Quantidade Recebida']], 
                    body: responsavelData, 
                    theme: 'striped', 
                    headStyles: { fillColor: [41, 128, 185] } 
                });
                // --- Fim do conte√∫do do PDF ---

                // Salva o arquivo PDF
                doc.save(`Relatorio_${tipoLabel}_${dataInicioStr}_a_${dataFimStr}.pdf`);
                showAlert('alert-relatorio', 'Relat√≥rio PDF gerado com sucesso!', 'success');
            } catch (error) { 
                console.error("Erro ao gerar PDF:", error); 
                showAlert('alert-relatorio', `Erro ao gerar PDF: ${error.message}`, 'error');
            } finally { 
                // Reabilita bot√£o
                btnGerarPdf.disabled = false; btnGerarPdf.textContent = 'Gerar Relat√≥rio PDF'; 
            }
        }
        
        // --- L√ìGICA DE EXCLUS√ÉO ---
        
        // Abre o modal de confirma√ß√£o para exclus√£o
        async function openConfirmDeleteModal(id, type, details = null) {
            if (!id || !type) return; // Sai se faltar ID ou tipo
            
            let collectionRef = null; 
            let detailsText = details ? `${details} (ID: ${id.substring(0,6)}...)` : `ID: ${id.substring(0,6)}...`;
            let alertElementId = 'alert-gestao'; // ID do alerta padr√£o
            let showUnidadeWarning = false; 
            let isInicial = false; // Flag para estoque inicial

            // Determina a cole√ß√£o e ajusta detalhes baseado no tipo
            if (type === 'agua') { 
                collectionRef = aguaCollection; 
                detailsText = `Movimenta√ß√£o de √Ågua ${detailsText}`; 
                alertElementId = 'alert-agua-lista';
            } else if (type === 'gas') { 
                collectionRef = gasCollection; 
                detailsText = `Movimenta√ß√£o de G√°s ${detailsText}`; 
                alertElementId = 'alert-gas-lista';
            } else if (type === 'materiais') { 
                collectionRef = materiaisCollection; 
                detailsText = `Registro de Material ${detailsText}`; 
                alertElementId = 'alert-materiais-lista';
            } else if (type === 'entrada-agua') { 
                collectionRef = estoqueAguaCollection; 
                detailsText = `Entrada de Estoque (√Ågua) ${detailsText}`; 
                alertElementId = 'alert-historico-agua'; 
                // Verifica se √© o lan√ßamento inicial
                const docSnap = await getDoc(doc(collectionRef, id)); 
                isInicial = docSnap.exists() && docSnap.data().tipo === 'inicial';
            } else if (type === 'entrada-gas') { 
                collectionRef = estoqueGasCollection; 
                detailsText = `Entrada de Estoque (G√°s) ${detailsText}`; 
                alertElementId = 'alert-historico-gas'; 
                const docSnap = await getDoc(doc(collectionRef, id)); 
                isInicial = docSnap.exists() && docSnap.data().tipo === 'inicial';
            } else if (type === 'unidade') { 
                collectionRef = unidadesCollection; 
                detailsText = `Unidade ${detailsText}`; 
                alertElementId = 'alert-gestao'; 
                showUnidadeWarning = true; // Mostra aviso sobre hist√≥rico
            } else { 
                console.error("Tipo inv√°lido para exclus√£o:", type); return; 
            }

            // Guarda informa√ß√µes para a fun√ß√£o executeDelete
            deleteInfo = { id, type, collectionRef, alertElementId, details, isInicial }; 
            
            // Atualiza UI do modal
            deleteDetailsEl.textContent = `Detalhes: ${detailsText}`;
            deleteWarningUnidadeEl.style.display = showUnidadeWarning ? 'block' : 'none'; 
            deleteWarningInicialEl.style.display = isInicial ? 'block' : 'none'; // Mostra aviso de estoque inicial
            confirmDeleteModal.style.display = 'block'; // Mostra o modal
        }
        
        // Executa a exclus√£o ap√≥s confirma√ß√£o no modal
        async function executeDelete() {
            if (!isAuthReady || !deleteInfo.id || !deleteInfo.collectionRef) {
                 showAlert(deleteInfo.alertElementId || 'alert-gestao', 'Erro: N√£o autenticado ou informa√ß√£o de exclus√£o inv√°lida.', 'error');
                 return;
            }
            
            // Desabilita bot√µes do modal e mostra loading
            btnConfirmDelete.disabled = true; btnConfirmDelete.innerHTML = '<div class="loading-spinner-small mx-auto" style="width:18px; height:18px;"></div>';
            btnCancelDelete.disabled = true;
            
            try {
                // Deleta o documento principal
                const docRef = doc(deleteInfo.collectionRef, deleteInfo.id);
                await deleteDoc(docRef);

                // Se for exclus√£o de UNIDADE, deleta tamb√©m o hist√≥rico associado
                if (deleteInfo.type === 'unidade') {
                    await deleteUnitHistory(deleteInfo.id); 
                    showAlert(deleteInfo.alertElementId || 'alert-gestao', `Unidade "${deleteInfo.details}" e seu hist√≥rico removidos!`, 'success');
                } else {
                    // Mensagem espec√≠fica para estoque inicial
                    const message = deleteInfo.isInicial ? 'Lan√ßamento de Estoque Inicial removido!' : 'Lan√ßamento removido com sucesso!';
                    showAlert(deleteInfo.alertElementId || 'alert-gestao', message, 'success');
                }

            } catch (error) {
                console.error(`Erro ao remover ${deleteInfo.type}:`, error);
                showAlert(deleteInfo.alertElementId || 'alert-gestao', `Erro ao remover: ${error.message}`, 'error');
            } finally {
                // Esconde modal e reabilita bot√µes
                confirmDeleteModal.style.display = 'none';
                btnConfirmDelete.disabled = false; btnConfirmDelete.textContent = 'Confirmar Exclus√£o';
                btnCancelDelete.disabled = false;
                // Limpa informa√ß√µes de exclus√£o
                deleteInfo = { id: null, type: null, collectionRef: null, alertElementId: null, details: null, isInicial: false };
            }
        }

        // Deleta todo o hist√≥rico de movimenta√ß√µes (√°gua, g√°s, materiais) de uma unidade espec√≠fica
        async function deleteUnitHistory(unidadeId) {
            if (!unidadeId || !isAuthReady) return;
            console.log(`Iniciando remo√ß√£o do hist√≥rico para unidade ID: ${unidadeId}`);
            
            const batch = writeBatch(db); // Usa batch para m√∫ltiplas exclus√µes at√¥micas
            let deleteCount = 0;
            
            try {
                // Query e adiciona exclus√µes de √ÅGUA ao batch
                const aguaQuery = query(aguaCollection, where("unidadeId", "==", unidadeId));
                const aguaSnapshot = await getDocs(aguaQuery); 
                aguaSnapshot.forEach(doc => { batch.delete(doc.ref); deleteCount++; });
                console.log(` - ${aguaSnapshot.size} movimenta√ß√µes de √°gua para remover.`);
                
                // Query e adiciona exclus√µes de G√ÅS ao batch
                const gasQuery = query(gasCollection, where("unidadeId", "==", unidadeId));
                const gasSnapshot = await getDocs(gasQuery); 
                gasSnapshot.forEach(doc => { batch.delete(doc.ref); deleteCount++; });
                 console.log(` - ${gasSnapshot.size} movimenta√ß√µes de g√°s para remover.`);
                 
                // Query e adiciona exclus√µes de MATERIAIS ao batch
                const materiaisQuery = query(materiaisCollection, where("unidadeId", "==", unidadeId));
                const materiaisSnapshot = await getDocs(materiaisQuery); 
                materiaisSnapshot.forEach(doc => { batch.delete(doc.ref); deleteCount++; });
                 console.log(` - ${materiaisSnapshot.size} registros de materiais para remover.`);
                 
                // Executa o batch se houver algo para deletar
                if (deleteCount > 0) {
                    await batch.commit(); 
                    console.log(`Hist√≥rico da unidade ${unidadeId} removido (${deleteCount} documentos).`);
                } else { 
                    console.log(`Nenhum hist√≥rico encontrado para a unidade ${unidadeId}.`); 
                }
            } catch (error) {
                 console.error(`Erro ao remover hist√≥rico da unidade ${unidadeId}:`, error);
                 // Alerta o usu√°rio sobre o erro, mas a unidade principal j√° foi removida
                 showAlert('alert-gestao', `Erro ao limpar o hist√≥rico da unidade: ${error.message}. A unidade foi removida, mas o hist√≥rico pode permanecer.`, 'error', 10000);
                 throw error; // Re-lan√ßa o erro para ser pego pela `executeDelete` se necess√°rio
            }
        }

        // --- L√ìGICA DE CONTROLE DE ESTOQUE (ENTRADA) ---

        // Salva o estoque inicial (s√≥ pode ser feito uma vez)
        async function handleInicialEstoqueSubmit(e) {
            e.preventDefault();
            const tipoEstoque = e.target.id.includes('agua') ? 'agua' : 'gas'; // 'agua' ou 'gas'
            
            // Obt√©m valores do form
            const inputQtd = document.getElementById(`input-inicial-qtd-${tipoEstoque}`).value;
            const inputResp = document.getElementById(`input-inicial-responsavel-${tipoEstoque}`).value;
            const btnSubmit = document.getElementById(`btn-submit-inicial-${tipoEstoque}`);
            const alertElId = `alert-inicial-${tipoEstoque}`;
            
            const quantidade = parseInt(inputQtd, 10);
            const responsavel = capitalizeString(inputResp.trim());

            // Valida√ß√£o
            if (isNaN(quantidade) || quantidade < 0 || !responsavel) { 
                showAlert(alertElId, "Preencha a quantidade e o respons√°vel.", 'warning'); return; 
            }
            
            // Verifica se o inicial j√° foi definido (pelo listener)
            const estoqueDefinido = (tipoEstoque === 'agua') ? estoqueInicialDefinido.agua : estoqueInicialDefinido.gas;
            if (estoqueDefinido) {
                 showAlert(alertElId, "O estoque inicial j√° foi definido.", 'info'); 
                 // Esconde form e bot√£o de abrir novamente
                 document.getElementById(`form-inicial-${tipoEstoque}-container`).classList.add('hidden');
                 document.getElementById(`btn-abrir-inicial-${tipoEstoque}`).classList.add('hidden');
                 document.getElementById(`resumo-estoque-${tipoEstoque}`).classList.remove('hidden'); // Mostra resumo
                 return;
            }
            
            btnSubmit.disabled = true; btnSubmit.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            const collectionRef = (tipoEstoque === 'agua') ? estoqueAguaCollection : estoqueGasCollection;
            
            try {
                // Adiciona documento de tipo 'inicial'
                await addDoc(collectionRef, { 
                    tipo: 'inicial', 
                    quantidade: quantidade, 
                    data: serverTimestamp(), // Data atual do servidor
                    responsavel: responsavel, 
                    notaFiscal: 'INICIAL', // NF padr√£o para inicial
                    registradoEm: serverTimestamp() 
                });
                showAlert(alertElId, "Estoque inicial salvo!", 'success', 2000);
                 // Esconde form e bot√£o (listener vai atualizar a UI principal)
                 document.getElementById(`form-inicial-${tipoEstoque}-container`).classList.add('hidden');
                 document.getElementById(`btn-abrir-inicial-${tipoEstoque}`).classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar estoque inicial:", error);
                showAlert(alertElId, `Erro ao salvar: ${error.message}`, 'error');
                btnSubmit.disabled = false; btnSubmit.textContent = 'Salvar Inicial'; // Reabilita em caso de erro
            }
        }

        // Alterna entre os forms de Sa√≠da (Unidades) e Entrada (Estoque)
        function switchEstoqueForm(formName) { // Ex: 'saida-agua', 'entrada-gas'
            const [action, itemType] = formName.split('-'); // ['saida', 'agua'] ou ['entrada', 'gas']
            const otherAction = (action === 'saida') ? 'entrada' : 'saida';

            // Seletores dos bot√µes e formul√°rios
            const btnAtivo = document.querySelector(`.form-tab-btn[data-form="${action}-${itemType}"]`);
            const btnInativo = document.querySelector(`.form-tab-btn[data-form="${otherAction}-${itemType}"]`);
            const formAtivo = document.getElementById(action === 'saida' ? `form-${itemType}` : `form-${action}-${itemType}`);
            const formInativo = document.getElementById(action === 'saida' ? `form-${otherAction}-${itemType}` : `form-${itemType}`);
            
            // Atualiza classes dos bot√µes
            btnAtivo?.classList.add('active');
            btnInativo?.classList.remove('active');
            
            // Mostra/esconde formul√°rios
            formAtivo?.classList.remove('hidden');
            formInativo?.classList.add('hidden');
        }

        // Salva uma entrada de estoque (compra/recebimento)
        async function handleEntradaEstoqueSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) { showAlert('alert-agua', 'Erro: N√£o autenticado.', 'error'); return; } // Pode ser alert-gas tbm, mas serve
            
            const tipoEstoque = e.target.id.includes('agua') ? 'agua' : 'gas';
            const alertElementId = `alert-${tipoEstoque}`; // Alerta do form principal
            
            // Obt√©m valores do form espec√≠fico
            const inputQtd = document.getElementById(`input-qtd-entrada-${tipoEstoque}`).value;
            const inputData = document.getElementById(`input-data-entrada-${tipoEstoque}`).value;
            const inputResp = document.getElementById(`input-responsavel-entrada-${tipoEstoque}`).value;
            const inputNf = document.getElementById(`input-nf-entrada-${tipoEstoque}`).value;
            const btnSubmit = document.getElementById(`btn-submit-entrada-${tipoEstoque}`);
            const form = document.getElementById(`form-entrada-${tipoEstoque}`);
            
            const quantidade = parseInt(inputQtd, 10);
            const data = dateToTimestamp(inputData);
            const responsavel = capitalizeString(inputResp.trim());
            const notaFiscal = inputNf.trim() || 'N/A'; // 'N/A' se vazio

            // Valida√ß√µes
            if (!quantidade || quantidade <= 0 || !data || !responsavel) { 
                showAlert(alertElementId, 'Dados inv√°lidos. Verifique quantidade, data e respons√°vel.', 'warning'); return; 
            }
            // Verifica se estoque inicial foi definido ANTES de permitir entradas
            if (!estoqueInicialDefinido[tipoEstoque]) { 
                showAlert(alertElementId, `Defina o Estoque Inicial de ${tipoEstoque === 'agua' ? '√Ågua' : 'G√°s'} antes de lan√ßar entradas.`, 'warning'); return; 
            }
            
            btnSubmit.disabled = true; btnSubmit.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            const collectionRef = (tipoEstoque === 'agua') ? estoqueAguaCollection : estoqueGasCollection;
            
            try {
                // Adiciona documento de tipo 'entrada'
                await addDoc(collectionRef, { 
                    tipo: 'entrada', 
                    quantidade: quantidade, 
                    data: data, 
                    responsavel: responsavel, 
                    notaFiscal: notaFiscal, 
                    registradoEm: serverTimestamp() 
                });
                showAlert(alertElementId, 'Entrada no estoque salva!', 'success');
                form.reset(); // Limpa form
                document.getElementById(`input-data-entrada-${tipoEstoque}`).value = getTodayDateString(); // Reseta data
            } catch (error) {
                console.error("Erro salvar entrada estoque:", error); 
                showAlert(alertElementId, `Erro: ${error.message}`, 'error');
            } finally { 
                btnSubmit.disabled = false; btnSubmit.textContent = 'Salvar Entrada'; 
            }
        }

        // Renderiza o card de resumo do estoque de √Ågua
        function renderEstoqueAgua() {
            if (!estoqueAguaAtualEl) return; // Sai se elemento n√£o existe
            
            if (loadingEstoqueAguaEl) loadingEstoqueAguaEl.style.display = 'none'; // Esconde loading
            
            // Controla visibilidade do form/bot√£o inicial vs resumo
            if (estoqueInicialDefinido.agua) {
                btnAbrirInicialAgua.classList.add('hidden'); 
                formInicialAguaContainer.classList.add('hidden'); 
                resumoEstoqueAguaEl.classList.remove('hidden'); // Mostra resumo
            } else { 
                btnAbrirInicialAgua.classList.remove('hidden'); // Mostra bot√£o para definir inicial
                resumoEstoqueAguaEl.classList.add('hidden'); 
            }

            // Calcula totais
            const estoqueInicial = fb_estoque_agua.filter(e => e.tipo === 'inicial').reduce((sum, e) => sum + e.quantidade, 0);
            const totalEntradas = fb_estoque_agua.filter(e => e.tipo === 'entrada').reduce((sum, e) => sum + e.quantidade, 0);
            const totalSaidas = fb_agua_movimentacoes.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const estoqueAtual = estoqueInicial + totalEntradas - totalSaidas;

            // Atualiza UI do resumo
            estoqueAguaInicialEl.textContent = estoqueInicial;
            estoqueAguaEntradasEl.textContent = `+${totalEntradas}`;
            estoqueAguaSaidasEl.textContent = `-${totalSaidas}`;
            estoqueAguaAtualEl.textContent = estoqueAtual;
            
            renderDashboardVisaoGeralSummary(); // Atualiza card no dashboard geral
        }

        // Renderiza o card de resumo do estoque de G√°s (similar a √°gua)
        function renderEstoqueGas() {
             if (!estoqueGasAtualEl) return;
            if (loadingEstoqueGasEl) loadingEstoqueGasEl.style.display = 'none';
            
            if (estoqueInicialDefinido.gas) {
                btnAbrirInicialGas.classList.add('hidden'); 
                formInicialGasContainer.classList.add('hidden'); 
                resumoEstoqueGasEl.classList.remove('hidden');
            } else { 
                btnAbrirInicialGas.classList.remove('hidden'); 
                resumoEstoqueGasEl.classList.add('hidden'); 
            }

            const estoqueInicial = fb_estoque_gas.filter(e => e.tipo === 'inicial').reduce((sum, e) => sum + e.quantidade, 0);
            const totalEntradas = fb_estoque_gas.filter(e => e.tipo === 'entrada').reduce((sum, e) => sum + e.quantidade, 0);
            const totalSaidas = fb_gas_movimentacoes.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const estoqueAtual = estoqueInicial + totalEntradas - totalSaidas;

            estoqueGasInicialEl.textContent = estoqueInicial;
            estoqueGasEntradasEl.textContent = `+${totalEntradas}`;
            estoqueGasSaidasEl.textContent = `-${totalSaidas}`;
            estoqueGasAtualEl.textContent = estoqueAtual;
            
            renderDashboardVisaoGeralSummary(); // Atualiza card no dashboard geral
        }

        // Renderiza a tabela de hist√≥rico de entradas de estoque de √Ågua
        function renderHistoricoAgua() {
            if (!tableHistoricoAgua) return;
            
            // Ordena por data (mais recente primeiro)
            const historicoOrdenado = [...fb_estoque_agua].sort((a, b) => (b.data?.toMillis() || 0) - (a.data?.toMillis() || 0));
             
             if (historicoOrdenado.length === 0) { 
                tableHistoricoAgua.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Nenhuma entrada registrada.</td></tr>'; return; 
             }
             
            // Gera HTML da tabela
            tableHistoricoAgua.innerHTML = historicoOrdenado.map(e => {
                const tipoClass = e.tipo === 'inicial' ? 'badge-blue' : 'badge-green';
                const tipoText = e.tipo === 'inicial' ? 'Inicial' : 'Entrada';
                return `
                <tr>
                    <td>${formatTimestamp(e.data)}</td>
                    <td><span class="badge ${tipoClass}">${tipoText}</span></td>
                    <td class="text-center font-medium">${e.quantidade}</td>
                    <td>${e.responsavel || 'N/A'}</td><td>${e.notaFiscal || 'N/A'}</td>
                    <td class="text-center">
                        <button class="btn-danger btn-remove" data-id="${e.id}" data-type="entrada-agua" title="Remover esta entrada"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `}).join('');
            lucide.createIcons(); // Recria √≠cones

            // Reaplica filtro se houver
            const filtroHistoricoAguaEl = document.getElementById('filtro-historico-agua');
            if (filtroHistoricoAguaEl && filtroHistoricoAguaEl.value) { filterTable(filtroHistoricoAguaEl, 'table-historico-agua'); }
        }

        // Renderiza a tabela de hist√≥rico de entradas de estoque de G√°s (similar a √°gua)
        function renderHistoricoGas() {
             if (!tableHistoricoGas) return;
            
            const historicoOrdenado = [...fb_estoque_gas].sort((a, b) => (b.data?.toMillis() || 0) - (a.data?.toMillis() || 0));
             
             if (historicoOrdenado.length === 0) { 
                tableHistoricoGas.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Nenhuma entrada registrada.</td></tr>'; return; 
             }
             
            tableHistoricoGas.innerHTML = historicoOrdenado.map(e => {
                const tipoClass = e.tipo === 'inicial' ? 'badge-blue' : 'badge-green';
                const tipoText = e.tipo === 'inicial' ? 'Inicial' : 'Entrada';
                return `
                <tr>
                    <td>${formatTimestamp(e.data)}</td>
                    <td><span class="badge ${tipoClass}">${tipoText}</span></td>
                    <td class="text-center font-medium">${e.quantidade}</td>
                    <td>${e.responsavel || 'N/A'}</td><td>${e.notaFiscal || 'N/A'}</td>
                    <td class="text-center">
                        <button class="btn-danger btn-remove" data-id="${e.id}" data-type="entrada-gas" title="Remover esta entrada"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `}).join('');
            lucide.createIcons();

            const filtroHistoricoGasEl = document.getElementById('filtro-historico-gas');
            if (filtroHistoricoGasEl && filtroHistoricoGasEl.value) { filterTable(filtroHistoricoGasEl, 'table-historico-gas'); }
        }


        // --- CONTROLE DE ABAS E INICIALIZA√á√ÉO ---
        
        // Troca a sub-aba vis√≠vel (Movimenta√ß√£o ou Previs√£o) dentro de √Ågua/G√°s
        function switchSubTabView(tabPrefix, subViewName) { // tabPrefix: 'agua' ou 'gas'
            // Atualiza bot√µes da sub-navega√ß√£o
            document.querySelectorAll(`#sub-nav-${tabPrefix} .sub-nav-btn`).forEach(btn => {
                btn.classList.toggle('active', btn.dataset.subview === subViewName);
            });
            // Mostra/esconde pain√©is da sub-aba
            document.querySelectorAll(`#content-${tabPrefix} > div[id^="subview-"]`).forEach(pane => {
                 pane.classList.toggle('hidden', pane.id !== `subview-${subViewName}`);
            });
             lucide.createIcons(); // Garante renderiza√ß√£o de √≠cones na nova sub-aba
        }

        // Troca a aba principal vis√≠vel (Dashboard, √Ågua, G√°s, etc.)
        function switchTab(tabName) {
            // Atualiza bot√µes da navega√ß√£o principal
            navButtons.forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.nav-btn[data-tab="${tabName}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Mostra/esconde pain√©is de conte√∫do principais
            contentPanes.forEach(pane => pane.classList.add('hidden'));
            const activePane = document.getElementById(`content-${tabName}`);
            if(activePane) activePane.classList.remove('hidden');
            
            visaoAtiva = tabName; // Guarda aba ativa globalmente

            // L√≥gica espec√≠fica ao entrar em certas abas
            if (tabName === 'dashboard') { 
                switchDashboardView('geral'); // Mostra vis√£o geral por padr√£o
                startDashboardRefresh(); // Inicia atualiza√ß√£o autom√°tica
            } else { 
                stopDashboardRefresh(); // Para atualiza√ß√£o se sair do dashboard
            }
            
            // Renderiza conte√∫do ao entrar nas abas (garante dados atualizados)
            if (tabName === 'gestao') { renderGestaoUnidades(); }
            if (tabName === 'agua') { 
                switchSubTabView('agua', 'movimentacao-agua'); // Default para sub-aba movimenta√ß√£o
                switchEstoqueForm('saida-agua'); // Default para form de sa√≠da
                toggleAguaFormInputs(); 
                renderEstoqueAgua(); 
                renderHistoricoAgua(); 
            }
            if (tabName === 'gas') { 
                switchSubTabView('gas', 'movimentacao-gas'); 
                switchEstoqueForm('saida-gas'); 
                toggleGasFormInputs(); 
                renderEstoqueGas(); 
                renderHistoricoGas(); 
            }

            // Garante renderiza√ß√£o de √≠cones ap√≥s troca de aba
            setTimeout(() => { if(typeof lucide !== 'undefined') lucide.createIcons(); }, 50); 
        }

        // Inicializa a aplica√ß√£o ap√≥s o DOM carregar
        function initApp() {
            // --- Mapeia elementos do DOM para vari√°veis ---
            navButtons = document.querySelectorAll('.nav-btn'); 
            contentPanes = document.querySelectorAll('main > div[id^="content-"]'); 
            connectionStatusEl = document.getElementById('connectionStatus'); 
            lastUpdateTimeEl = document.getElementById('last-update-time');
            // Dashboard
            dashboardNavControls = document.getElementById('dashboard-nav-controls');
            summaryAguaPendente = document.getElementById('summary-agua-pendente'); summaryAguaEntregue = document.getElementById('summary-agua-entregue'); summaryAguaRecebido = document.getElementById('summary-agua-recebido');
            summaryGasPendente = document.getElementById('summary-gas-pendente'); summaryGasEntregue = document.getElementById('summary-gas-entregue'); summaryGasRecebido = document.getElementById('summary-gas-recebido');
            dashboardMateriaisProntosContainer = document.getElementById('dashboard-materiais-prontos'); loadingMateriaisProntos = document.getElementById('loading-materiais-prontos');
            dashboardMateriaisListContainer = document.getElementById('dashboard-materiais-list'); loadingMateriaisDashboard = document.getElementById('loading-materiais-dashboard');
            dashboardEstoqueAguaEl = document.getElementById('dashboard-estoque-agua'); dashboardEstoqueGasEl = document.getElementById('dashboard-estoque-gas'); dashboardMateriaisSeparacaoCountEl = document.getElementById('dashboard-materiais-separacao-count');
            dashboardMateriaisRetiradaCountEl = document.getElementById('dashboard-materiais-retirada-count'); // (REQ 6.4)
            // √Ågua
            formAgua = document.getElementById('form-agua'); selectUnidadeAgua = document.getElementById('select-unidade-agua'); selectTipoAgua = document.getElementById('select-tipo-agua'); inputDataAgua = document.getElementById('input-data-agua'); inputResponsavelAgua = document.getElementById('input-responsavel-agua'); btnSubmitAgua = document.getElementById('btn-submit-agua'); alertAgua = document.getElementById('alert-agua'); tableStatusAgua = document.getElementById('table-status-agua'); alertAguaLista = document.getElementById('alert-agua-lista');
            inputQtdEntregueAgua = document.getElementById('input-qtd-entregue-agua'); inputQtdRetornoAgua = document.getElementById('input-qtd-retorno-agua'); formGroupQtdEntregueAgua = document.getElementById('form-group-qtd-entregue-agua'); formGroupQtdRetornoAgua = document.getElementById('form-group-qtd-retorno-agua');
            // G√°s
            formGas = document.getElementById('form-gas'); selectUnidadeGas = document.getElementById('select-unidade-gas'); selectTipoGas = document.getElementById('select-tipo-gas'); inputDataGas = document.getElementById('input-data-gas'); inputResponsavelGas = document.getElementById('input-responsavel-gas'); btnSubmitGas = document.getElementById('btn-submit-gas'); alertGas = document.getElementById('alert-gas'); tableStatusGas = document.getElementById('table-status-gas'); alertGasLista = document.getElementById('alert-gas-lista');
            inputQtdEntregueGas = document.getElementById('input-qtd-entregue-gas'); inputQtdRetornoGas = document.getElementById('input-qtd-retorno-gas'); formGroupQtdEntregueGas = document.getElementById('form-group-qtd-entregue-gas'); formGroupQtdRetornoGas = document.getElementById('form-group-qtd-retorno-gas');
            // Materiais
            formMateriais = document.getElementById('form-materiais'); selectUnidadeMateriais = document.getElementById('select-unidade-materiais'); selectTipoMateriais = document.getElementById('select-tipo-materiais'); inputDataSeparacao = document.getElementById('input-data-separacao'); textareaItensMateriais = document.getElementById('textarea-itens-materiais'); inputResponsavelMateriais = document.getElementById('input-responsavel-materiais'); btnSubmitMateriais = document.getElementById('btn-submit-materiais'); alertMateriais = document.getElementById('alert-materiais'); tableStatusMateriais = document.getElementById('table-status-materiais'); alertMateriaisLista = document.getElementById('alert-materiais-lista');
            // Gest√£o
            tableGestaoUnidades = document.getElementById('table-gestao-unidades'); alertGestao = document.getElementById('alert-gestao'); textareaBulkUnidades = document.getElementById('textarea-bulk-unidades'); btnBulkAddUnidades = document.getElementById('btn-bulk-add-unidades');
            filtroUnidadeNome = document.getElementById('filtro-unidade-nome'); filtroUnidadeTipo = document.getElementById('filtro-unidade-tipo'); 
            // Relat√≥rio PDF
            relatorioTipo = document.getElementById('relatorio-tipo'); relatorioDataInicio = document.getElementById('relatorio-data-inicio'); relatorioDataFim = document.getElementById('relatorio-data-fim'); btnGerarPdf = document.getElementById('btn-gerar-pdf'); alertRelatorio = document.getElementById('alert-relatorio');
            // Modal Delete
            confirmDeleteModal = document.getElementById('confirm-delete-modal'); btnCancelDelete = document.getElementById('btn-cancel-delete'); btnConfirmDelete = document.getElementById('btn-confirm-delete'); deleteDetailsEl = document.getElementById('delete-details'); deleteWarningUnidadeEl = document.getElementById('delete-warning-unidade'); deleteWarningInicialEl = document.getElementById('delete-warning-inicial'); 
            // Estoque √Ågua
            estoqueAguaInicialEl = document.getElementById('estoque-agua-inicial'); estoqueAguaEntradasEl = document.getElementById('estoque-agua-entradas'); estoqueAguaSaidasEl = document.getElementById('estoque-agua-saidas'); estoqueAguaAtualEl = document.getElementById('estoque-agua-atual'); loadingEstoqueAguaEl = document.getElementById('loading-estoque-agua'); resumoEstoqueAguaEl = document.getElementById('resumo-estoque-agua');
            formEntradaAgua = document.getElementById('form-entrada-agua'); inputDataEntradaAgua = document.getElementById('input-data-entrada-agua'); btnSubmitEntradaAgua = document.getElementById('btn-submit-entrada-agua');
            formInicialAguaContainer = document.getElementById('form-inicial-agua-container'); formInicialAgua = document.getElementById('form-inicial-agua'); inputInicialQtdAgua = document.getElementById('input-inicial-qtd-agua'); inputInicialResponsavelAgua = document.getElementById('input-inicial-responsavel-agua'); btnSubmitInicialAgua = document.getElementById('btn-submit-inicial-agua'); alertInicialAgua = document.getElementById('alert-inicial-agua'); btnAbrirInicialAgua = document.getElementById('btn-abrir-inicial-agua');
            tableHistoricoAgua = document.getElementById('table-historico-agua'); alertHistoricoAgua = document.getElementById('alert-historico-agua');
            // Estoque G√°s
            estoqueGasInicialEl = document.getElementById('estoque-gas-inicial'); estoqueGasEntradasEl = document.getElementById('estoque-gas-entradas'); estoqueGasSaidasEl = document.getElementById('estoque-gas-saidas'); estoqueGasAtualEl = document.getElementById('estoque-gas-atual'); loadingEstoqueGasEl = document.getElementById('loading-estoque-gas'); resumoEstoqueGasEl = document.getElementById('resumo-estoque-gas');
            formEntradaGas = document.getElementById('form-entrada-gas'); inputDataEntradaGas = document.getElementById('input-data-entrada-gas'); btnSubmitEntradaGas = document.getElementById('btn-submit-entrada-gas');
            formInicialGasContainer = document.getElementById('form-inicial-gas-container'); formInicialGas = document.getElementById('form-inicial-gas'); inputInicialQtdGas = document.getElementById('input-inicial-qtd-gas'); inputInicialResponsavelGas = document.getElementById('input-inicial-responsavel-gas'); btnSubmitInicialGas = document.getElementById('btn-submit-inicial-gas'); alertInicialGas = document.getElementById('alert-inicial-gas'); btnAbrirInicialGas = document.getElementById('btn-abrir-inicial-gas');
            tableHistoricoGas = document.getElementById('table-historico-gas'); alertHistoricoGas = document.getElementById('alert-historico-gas');
            // --- Fim do mapeamento ---

            // Define datas iniciais nos inputs de data
            const todayStr = getTodayDateString();
            [inputDataAgua, inputDataGas, inputDataSeparacao, relatorioDataInicio, relatorioDataFim, inputDataEntradaAgua, inputDataEntradaGas].forEach(input => {
                if(input) input.value = todayStr;
            });

            // --- Adiciona Event Listeners ---
            // Navega√ß√£o Principal
            navButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
            // Navega√ß√£o Dashboard
            if (dashboardNavControls) dashboardNavControls.addEventListener('click', (e) => { const btn = e.target.closest('button.dashboard-nav-btn[data-view]'); if (btn) switchDashboardView(btn.dataset.view); });
            // Forms Principais
            if (formAgua) formAgua.addEventListener('submit', handleAguaSubmit); 
            if (formGas) formGas.addEventListener('submit', handleGasSubmit); 
            if (formMateriais) formMateriais.addEventListener('submit', handleMateriaisSubmit); 
            // Selects de Tipo de Movimenta√ß√£o (√Ågua/G√°s)
            if (selectTipoAgua) selectTipoAgua.addEventListener('change', toggleAguaFormInputs);
            if (selectTipoGas) selectTipoGas.addEventListener('change', toggleGasFormInputs);
            
            // (REQ 6.2) Delega√ß√£o de eventos para bot√µes 'Remover', 'Entregue' e 'Retirada'
            document.querySelector('main').addEventListener('click', (e) => {
                 const removeBtn = e.target.closest('button.btn-remove[data-id]');
                 const entregueBtn = e.target.closest('button.btn-entregue[data-id]');
                 const retiradaBtn = e.target.closest('button.btn-retirada[data-id]'); // (REQ 6.2)
                 
                 if (removeBtn) { openConfirmDeleteModal(removeBtn.dataset.id, removeBtn.dataset.type, removeBtn.dataset.details); } 
                 else if (entregueBtn) { handleMarcarEntregue(e); }
                 else if (retiradaBtn) { handleMarcarRetirada(e); } // (REQ 6.2)
            });
            // Edi√ß√£o de Unidades (Gest√£o)
            if (tableGestaoUnidades) { 
                tableGestaoUnidades.addEventListener('click', handleEditUnidadeClick);
                tableGestaoUnidades.addEventListener('click', handleCancelEditUnidadeClick);
                tableGestaoUnidades.addEventListener('click', handleSaveUnidadeClick);
            }
            // Toggles e Filtros (Gest√£o)
            const contentGestao = document.getElementById('content-gestao');
            if (contentGestao) {
                contentGestao.addEventListener('change', handleGestaoToggle); // Checkboxes
                if(filtroUnidadeNome) filtroUnidadeNome.addEventListener('input', renderGestaoUnidades); // Filtro nome
                if(filtroUnidadeTipo) filtroUnidadeTipo.addEventListener('input', renderGestaoUnidades); // Filtro tipo
            }
            // Adicionar Unidades em Lote
            if (btnBulkAddUnidades) btnBulkAddUnidades.addEventListener('click', handleBulkAddUnidades);
            // Relat√≥rio PDF
            if (btnGerarPdf) btnGerarPdf.addEventListener('click', handleGerarPdf);
            // Modal Delete
            if (btnCancelDelete) btnCancelDelete.addEventListener('click', () => confirmDeleteModal.style.display = 'none');
            if (btnConfirmDelete) btnConfirmDelete.addEventListener('click', executeDelete);
            // Abas de Entrada/Sa√≠da Estoque
            document.querySelectorAll('.form-tab-btn[data-form="saida-agua"]').forEach(btn => btn.addEventListener('click', () => switchEstoqueForm('saida-agua')));
            document.querySelectorAll('.form-tab-btn[data-form="entrada-agua"]').forEach(btn => btn.addEventListener('click', () => switchEstoqueForm('entrada-agua')));
            document.querySelectorAll('.form-tab-btn[data-form="saida-gas"]').forEach(btn => btn.addEventListener('click', () => switchEstoqueForm('saida-gas')));
            document.querySelectorAll('.form-tab-btn[data-form="entrada-gas"]').forEach(btn => btn.addEventListener('click', () => switchEstoqueForm('entrada-gas')));
            // Forms de Entrada Estoque
            if (formEntradaAgua) formEntradaAgua.addEventListener('submit', handleEntradaEstoqueSubmit);
            if (formEntradaGas) formEntradaGas.addEventListener('submit', handleEntradaEstoqueSubmit);
            // Bot√µes/Forms Estoque Inicial
            if (btnAbrirInicialAgua) btnAbrirInicialAgua.addEventListener('click', () => { formInicialAguaContainer.classList.remove('hidden'); btnAbrirInicialAgua.classList.add('hidden'); });
            if (btnAbrirInicialGas) btnAbrirInicialGas.addEventListener('click', () => { formInicialGasContainer.classList.remove('hidden'); btnAbrirInicialGas.classList.add('hidden'); });
            if (formInicialAgua) formInicialAgua.addEventListener('submit', handleInicialEstoqueSubmit);
            if (formInicialGas) formInicialGas.addEventListener('submit', handleInicialEstoqueSubmit);
            // Filtros das tabelas de Status e Hist√≥rico
            document.getElementById('filtro-status-agua')?.addEventListener('input', (e) => filterTable(e.target, 'table-status-agua'));
            document.getElementById('filtro-historico-agua')?.addEventListener('input', (e) => filterTable(e.target, 'table-historico-agua'));
            document.getElementById('filtro-status-gas')?.addEventListener('input', (e) => filterTable(e.target, 'table-status-gas'));
            document.getElementById('filtro-historico-gas')?.addEventListener('input', (e) => filterTable(e.target, 'table-historico-gas'));
            // Sub-navega√ß√£o (√Ågua/G√°s)
            document.getElementById('sub-nav-agua')?.addEventListener('click', (e) => { const btn = e.target.closest('button.sub-nav-btn[data-subview]'); if (btn) switchSubTabView('agua', btn.dataset.subview); });
            document.getElementById('sub-nav-gas')?.addEventListener('click', (e) => { const btn = e.target.closest('button.sub-nav-btn[data-subview]'); if (btn) switchSubTabView('gas', btn.dataset.subview); });

            // Renderiza √≠cones iniciais
            if(typeof lucide !== 'undefined') lucide.createIcons();
            // Ajusta visibilidade inicial dos inputs Qtd
            toggleAguaFormInputs(); toggleGasFormInputs();
        }

        // --- INICIALIZA√á√ÉO GERAL ---
        document.addEventListener('DOMContentLoaded', () => { 
            initApp();          // Mapeia elementos e adiciona listeners
            initFirebase();     // Conecta ao Firebase e inicia listeners de dados
            switchTab('dashboard'); // Define a aba inicial
        });
    </script>
</body>
</html>
