<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROLE DE ALMOXARIFADO - SEMCAS (v.6.2 - Estoque v2)</title>
    
    <!-- Scripts e Links -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
    <!-- jsPDF para Relatórios PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js" defer></script>
    <!-- Icones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Estilos -->
    <style>
        :root {
            --primary-blue: #1e40af; /* Azul SEMCAS principal */
            --secondary-blue: #3b82f6; /* Azul SEMCAS secundário */
            --light-blue: #60a5fa; /* Azul SEMCAS claro */
            --success: #10b981; /* Verde sucesso */
            --warning: #f59e0b; /* Amarelo aviso */
            --error: #ef4444; /* Vermelho erro */
            --info: #3b82f6; /* Azul info */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; /* bg-slate-100 */ }
        .header-banner { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 50%, var(--light-blue) 100%); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); color: white; }
        .logo-container { display: flex; align-items: center; gap: 1rem; padding: 1rem; }
        .logo-img { height: 60px; width: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); background: white; padding: 4px; }
        .main-title { font-size: 1.5rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); line-height: 1.2; margin: 0; }
        .sub-title { font-size: 0.9rem; opacity: 0.9; }
        
        /* Navegação */
        .nav-btn { padding: 0.75rem 1rem; border: none; background: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.2s ease; font-weight: 600; color: #475569; white-space: nowrap; }
        .nav-btn:hover { background-color: #f8fafc; }
        .nav-btn.active { color: var(--secondary-blue); border-bottom-color: var(--secondary-blue); }
        .main-nav-container { overflow-x: auto; white-space: nowrap; }
        
        /* Dashboard Sub-nav */
        .dashboard-nav-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; background: white; cursor: pointer; transition: all 0.2s ease; font-weight: 500; color: #475569; }
        .dashboard-nav-btn:hover { background-color: #f8fafc; }
        .dashboard-nav-btn.active { background-color: var(--primary-blue); color: white; border-color: var(--primary-blue); }

        /* Cards */
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        /* Formulários */
        .form-label { display: block; font-size: 0.875rem; /* text-sm */ font-medium: 600; color: #475569; margin-bottom: 0.25rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; background: white; transition: all 0.2s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--secondary-blue); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .form-textarea { min-height: 80px; }
        
        /* Abas dos Formulários de Entrada/Saída */
        .form-tab-btn { flex: 1; padding: 0.75rem 0.5rem; border: none; background: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.2s ease; font-weight: 600; color: #64748b; font-size: 0.875rem; text-align: center; }
        .form-tab-btn.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }

        /* Botões */
        .btn { padding: 0.75rem 1.5rem; font-weight: 600; border-radius: 0.5rem; transition: all 0.2s ease; cursor: pointer; border: none; }
        .btn-primary { background-color: var(--primary-blue); color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-primary:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background-color: #e2e8f0; color: #334155; padding: 0.5rem 1rem; }
        .btn-secondary:hover { background-color: #cbd5e1; }
        .btn-success { background-color: var(--success); color: white; padding: 0.5rem 1rem; }
        .btn-success:hover { background-color: #059669; }
        .btn-danger { background-color: transparent; color: var(--error); padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-danger:hover { background-color: #fee2e2; }
        .btn-sm { padding: 0.3rem 0.8rem; font-size: 0.8rem; } /* Botão pequeno */
        
        /* Alertas */
        .alert { padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; border: 1px solid; display: none; }
        .alert-error { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .alert-success { background: #d1fae5; color: #166534; border-color: #a7f3d0; }
        .alert-warning { background: #fef3c7; color: #92400e; border-color: #fde68a; }
        .alert-info { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        
        /* Tabelas */
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .table th { background: #f9fafb; font-weight: 600; color: #374151; font-size: 0.75rem; text-transform: uppercase; }
        .table tbody tr:hover { background: #f9fafb; }
        .table .form-toggle { height: 1.5rem; width: 1.5rem; cursor: pointer; accent-color: var(--primary-blue); }
        
        /* Badges */
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge-green { background: #d1fae5; color: #059669; }
        .badge-yellow { background: #fef3c7; color: #d97706; }
        .badge-blue { background: #dbeafe; color: #1e40af; } /* Badge Azul para tipo 'inicial' */
        
        /* Loaders */
        .loading-spinner { border: 5px solid #e5e7eb; border-top: 5px solid var(--secondary-blue); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: auto; }
        .loading-spinner-small { border: 3px solid #e5e7eb; border-top: 3px solid var(--secondary-blue); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Gráficos e Listas Dashboard */
        .dashboard-list { max-height: 400px; overflow-y: auto; }
        .chart-container { position: relative; width: 100%; height: 400px; } 
        
        /* Estilos específicos para TV (fontes maiores no dashboard) */
        .dashboard-tv-view { /* Classe pai para visualizações do dashboard */ }
        .dashboard-tv-view h3 { font-size: 1.5rem; /* text-2xl */ margin-bottom: 1rem; }
        .dashboard-tv-view .card-value { font-size: 2.5rem; /* text-4xl */ font-weight: 700; line-height: 1; }
        .dashboard-tv-view .card-label { font-size: 1rem; /* text-base */ color: #64748b; }
        .dashboard-tv-view .materiais-prontos-col h4 { font-size: 1.25rem; font-weight: 600; color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); padding-bottom: 0.5rem; margin-bottom: 0.75rem; }
        .dashboard-tv-view .materiais-prontos-col li { font-size: 1rem; margin-bottom: 0.5rem; line-height: 1.4; }
        .dashboard-tv-view .materiais-prontos-col li strong { font-weight: 600; color: #1e293b; }
        .dashboard-tv-view .materiais-prontos-col li span { font-size: 0.875rem; color: #475569; }

        @media (max-width: 768px) {
            .logo-container { flex-direction: column; text-align: center; gap: 0.75rem; }
            .main-title { font-size: 1.25rem; text-align: center; }
            .logo-img { height: 50px; }
            .sub-header-controls { flex-direction: column; gap: 0.5rem; align-items: stretch; }
            .sub-header-info { text-align: center; }
            .nav-btn { font-size: 0.875rem; padding: 0.75rem 0.5rem; }
            .dashboard-nav-btn { font-size: 0.875rem; padding: 0.5rem; }
        }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeInModal 0.3s ease-out; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 0.75rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideInModal 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: 600; color: #1e293b; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; line-height: 1; padding: 0.5rem; }
        .modal-close:hover { color: #1e293b; }
        .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .modal-footer { border-top: 1px solid #e2e8f0; padding-top: 1rem; margin-top: 1rem; text-align: right; }
        @keyframes fadeInModal { from { background-color: rgba(0,0,0,0); } to { background-color: rgba(0,0,0,0.6); } }
        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-table { font-size: 0.875rem; }
        .modal-table th, .modal-table td { padding: 0.5rem 0.75rem; }
        .lucide-trash-2 { width: 1em; height: 1em; vertical-align: middle; }
    </style>
</head>
<body class="text-slate-700 antialiased">

    <!-- 1. Header Institucional -->
    <header class="header-banner sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="logo-container">
                <!-- [Imagem do Logo Prefeitura de São Luís] -->
                <img src="https://www.saoluis.ma.gov.br/img/logo_mobile.png" alt="Logo Prefeitura de São Luís" class="logo-img" onerror="this.src='https://placehold.co/150x60/ffffff/1e40af?text=SEMCAS'; this.onerror=null;">
                <div class="title-container">
                    <h1 class="main-title">CONTROLE DE ALMOXARIFADO</h1>
                    <p class="sub-title">SEMCAS - Secretaria Municipal da Criança e Assistência Social</p>
                </div>
            </div>
        </div>
    </header>

    <!-- 2. Sub-Header de Controles -->
    <div class="bg-white shadow-sm border-b border-slate-200">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center flex-wrap sub-header-controls">
                <div class="flex items-center space-x-4 sub-header-info">
                    <div class="bg-blue-500 text-white p-3 rounded-lg hidden sm:block">
                         <!-- [Ícone de Almoxarifado] -->
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><path d="M19 16h-3m0 0 3-3 3 3m-3 7v-7"/><path d="M18 5V3"/><path d="M7 5V3"/><path d="M12 5V3"/></svg>
                    </div>
                    <div>
                        <h2 class="font-bold text-lg text-slate-800">Sistema de Almoxarifado</h2>
                        <p class="text-sm text-slate-500">v.6.2 (Firebase + Estoque v2)</p> <!-- Versão Atualizada -->
                    </div>
                </div>
                <div class="flex items-center space-x-4 text-sm">
                    <!-- Status da Conexão com Firebase -->
                    <div id="connectionStatus" class="flex items-center gap-2"></div>
                    <!-- Horário da Última Atualização -->
                    <p id="last-update-time" class="text-slate-500"></p> 
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Sistema de Navegação -->
    <nav class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky z-40 top-[92px] md:top-[88px]">
        <div class="container mx-auto px-4">
            <div class="flex space-x-1 overflow-x-auto main-nav-container">
                <button class="nav-btn active" data-tab="dashboard">📊 Dashboard</button>
                <button class="nav-btn" data-tab="agua">💧 Controle de Água</button>
                <button class="nav-btn" data-tab="gas">🔥 Controle de Gás</button>
                <button class="nav-btn" data-tab="materiais">🚚 Entrega de Materiais</button>
                <button class="nav-btn" data-tab="gestao">⚙️ Gestão de Unidades</button>
                <button class="nav-btn" data-tab="relatorio">📄 Gerar Relatório</button> 
            </div>
        </div>
    </nav>

    <!-- 4. Conteúdo Principal -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Conteúdo do Dashboard -->
        <div id="content-dashboard" class="fade-in">
            <!-- Header do Dashboard com Navegação -->
            <div class="flex justify-between items-start mb-6 flex-wrap gap-4">
                 <div>
                    <h3 class="text-2xl font-bold text-slate-800">Visão Geral do Almoxarifado</h3>
                    <p class="text-sm text-slate-500 mt-1">A página atualiza automaticamente a cada 2 minutos.</p>
                 </div>
                 <!-- Navegação interna do Dashboard -->
                 <div class="flex flex-wrap gap-2" id="dashboard-nav-controls">
                     <button class="dashboard-nav-btn active" data-view="geral">Visão Geral</button>
                     <button class="dashboard-nav-btn" data-view="agua">💧 Água</button>
                     <button class="dashboard-nav-btn" data-view="gas">🔥 Gás</button>
                     <button class="dashboard-nav-btn" data-view="materiais">🚚 Materiais</button>
                 </div>
            </div>
           
            <!-- Container das visualizações do Dashboard -->
            <div class="dashboard-tv-view">
                
                <!-- VISÃO GERAL (NOVA) -->
                <div id="dashboard-view-geral" class="fade-in">
                    <div class="card">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Materiais Prontos para Entrega (Em Separação)</h3>
                        <div id="dashboard-materiais-prontos" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
                            <!-- Colunas (CT, SEDE, CRAS, CREAS, ABRIGO) serão geradas pelo JS -->
                            <div class="text-center p-10 col-span-full" id="loading-materiais-prontos">
                                <div class="loading-spinner-small mx-auto mb-2"></div>
                                <p class="text-sm text-slate-500">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISÃO ÁGUA -->
                <div id="dashboard-view-agua" class="hidden fade-in">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Cards de Resumo Água -->
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Total Pendente (Saldo)</h3>
                            <p id="summary-agua-pendente" class="card-value text-red-600">0</p>
                            <p class="card-label">Galões com as unidades</p>
                        </div>
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Entregues (Últimos 30 dias)</h3>
                            <p id="summary-agua-entregue" class="card-value text-blue-600">0</p>
                            <p class="card-label">Galões cheios</p>
                        </div>
                         <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Recebidos (Últimos 30 dias)</h3>
                            <p id="summary-agua-recebido" class="card-value text-green-600">0</p>
                            <p class="card-label">Galões vazios</p>
                        </div>
                    </div>
                    <!-- Gráfico de Água -->
                    <div class="card mt-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Controle de Água (Últimos 30 dias)</h3>
                        <div class="chart-container">
                            <canvas id="dashboardAguaChart"></canvas>
                        </div>
                        <p class="text-xs text-slate-400 mt-2 text-center">Entregues vs Recebidos</p>
                    </div>
                </div>
                
                <!-- VISÃO GÁS -->
                <div id="dashboard-view-gas" class="hidden fade-in">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Cards de Resumo Gás -->
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Total Pendente (Saldo)</h3>
                            <p id="summary-gas-pendente" class="card-value text-red-600">0</p>
                            <p class="card-label">Botijões com as unidades</p>
                        </div>
                        <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Entregues (Últimos 30 dias)</h3>
                            <p id="summary-gas-entregue" class="card-value text-blue-600">0</p>
                            <p class="card-label">Botijões cheios</p>
                        </div>
                         <div class="card text-center">
                            <h3 class="font-semibold text-slate-800 mb-2">Recebidos (Últimos 30 dias)</h3>
                            <p id="summary-gas-recebido" class="card-value text-green-600">0</p>
                            <p class="card-label">Botijões vazios</p>
                        </div>
                    </div>
                    <!-- Gráfico de Gás -->
                    <div class="card mt-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Controle de Gás (Últimos 30 dias)</h3>
                        <div class="chart-container">
                            <canvas id="dashboardGasChart"></canvas>
                        </div>
                        <p class="text-xs text-slate-400 mt-2 text-center">Entregues vs Recebidos</p>
                    </div>
                </div>
                
                <!-- VISÃO MATERIAIS -->
                <div id="dashboard-view-materiais" class="hidden fade-in">
                    <!-- Lista de Materiais -->
                    <div class="card">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Materiais em Separação</h3>
                        <div id="dashboard-materiais-list" class="space-y-3 dashboard-list">
                             <div class="text-center p-10" id="loading-materiais-dashboard">
                                <div class="loading-spinner-small mx-auto mb-2"></div>
                                <p class="text-sm text-slate-500">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo Controle de Água -->
        <div id="content-agua" class="hidden fade-in">
            <!-- LAYOUT AJUSTADO: 4 Colunas -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                
                <!-- Card: Resumo do Estoque -->
                <div class="lg:col-span-1 card bg-blue-50">
                    <h2 class="text-xl font-bold text-blue-800 mb-4">Estoque de Água</h2>
                    
                    <!-- Form Estoque Inicial (Condicional) -->
                    <div id="form-inicial-agua-container" class="hidden bg-white p-4 rounded-md border border-blue-200 mb-4">
                        <h3 class="text-sm font-semibold mb-2 text-blue-700">Ponta-pé Inicial</h3>
                        <p class="text-xs text-slate-500 mb-3">Informe a quantidade inicial para começar.</p>
                        <form id="form-inicial-agua">
                            <div class="mb-2">
                                <label for="input-inicial-qtd-agua" class="form-label text-xs">Qtd. Inicial</label>
                                <input type="number" id="input-inicial-qtd-agua" class="form-input form-input-sm py-1 px-2 text-sm" min="0" value="0" required>
                            </div>
                            <div class="mb-3">
                                 <label for="input-inicial-responsavel-agua" class="form-label text-xs">Responsável</label>
                                 <input type="text" id="input-inicial-responsavel-agua" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Seu nome" required>
                            </div>
                            <button type="submit" id="btn-submit-inicial-agua" class="btn btn-primary btn-sm w-full">Salvar Inicial</button>
                        </form>
                        <div id="alert-inicial-agua" class="alert mt-3 text-xs p-2"></div>
                    </div>

                    <!-- Botão para abrir form inicial (Condicional) -->
                    <button id="btn-abrir-inicial-agua" class="btn btn-secondary btn-sm w-full mb-4 hidden">Definir Estoque Inicial</button>

                    <!-- Resumo Normal -->
                    <ul id="resumo-estoque-agua" class="space-y-3 text-sm hidden">
                        <li class="flex justify-between items-center">
                            <span class="text-slate-600">Estoque Inicial:</span>
                            <strong id="estoque-agua-inicial" class="text-lg">0</strong>
                        </li>
                        <li class="flex justify-between items-center">
                            <span class="text-slate-600">Total de Entradas:</span>
                            <strong id="estoque-agua-entradas" class="text-lg text-green-600">+0</strong>
                        </li>
                        <li class="flex justify-between items-center">
                            <span class="text-slate-600">Total de Saídas:</span>
                            <strong id="estoque-agua-saidas" class="text-lg text-red-600">-0</strong>
                        </li>
                        <li class="flex justify-between items-center text-lg font-bold border-t pt-2 mt-2 border-blue-200">
                            <span class="text-blue-900">Disponível:</span>
                            <strong id="estoque-agua-atual" class="text-2xl text-blue-900">0</strong>
                        </li>
                    </ul>
                    <div id="loading-estoque-agua" class="text-center py-4">
                        <div class="loading-spinner-small mx-auto"></div>
                    </div>
                </div>

                <!-- Coluna de Lançamento (com abas) -->
                <div class="lg:col-span-1 card">
                    <!-- Abas de Saída/Entrada -->
                    <div class="flex border-b mb-4 -mx-6 px-2">
                        <button class="form-tab-btn active" data-form="saida-agua">💧 Saída (Unidades)</button>
                        <button class="form-tab-btn" data-form="entrada-agua">📥 Entrada (Estoque)</button>
                    </div>

                    <!-- Form 1: Saída -->
                    <form id="form-agua" class="">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Lançar Saída (Água)</h2>
                        <div class="mb-4">
                            <label for="select-unidade-agua" class="form-label">Unidade (Apenas habilitadas)</label>
                            <select id="select-unidade-agua" class="form-select" required></select>
                        </div>
                        <div class="mb-4">
                            <label for="select-tipo-agua" class="form-label">Tipo de Movimentação</label>
                            <select id="select-tipo-agua" class="form-select" required>
                                <option value="entrega">Saída de Galão (Cheio)</option>
                                <option value="retorno">Retorno de Galão (Vazio)</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="input-qtd-agua" class="form-label">Quantidade</label>
                            <input type="number" id="input-qtd-agua" class="form-input" min="1" value="1" required>
                        </div>
                        <div class="mb-4">
                            <label for="input-data-agua" class="form-label">Data</label>
                            <input type="date" id="input-data-agua" class="form-input" required>
                        </div>
                        <div class="mb-4">
                             <label for="input-responsavel-agua" class="form-label">Responsável (Unidade)</label>
                             <input type="text" id="input-responsavel-agua" class="form-input" placeholder="Nome de quem recebeu/entregou" required>
                        </div>
                        <button type="submit" id="btn-submit-agua" class="btn btn-primary w-full">Salvar Saída</button>
                    </form>

                    <!-- Form 2: Entrada -->
                    <form id="form-entrada-agua" class="hidden">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Dar Entrada no Estoque (Água)</h2>
                        <div class="mb-4">
                            <label for="input-qtd-entrada-agua" class="form-label">Quantidade</label>
                            <input type="number" id="input-qtd-entrada-agua" class="form-input" min="1" value="1" required>
                        </div>
                        <div class="mb-4">
                            <label for="input-data-entrada-agua" class="form-label">Data da Entrada</label>
                            <input type="date" id="input-data-entrada-agua" class="form-input" required>
                        </div>
                        <div class="mb-4">
                             <label for="input-responsavel-entrada-agua" class="form-label">Recebido por (Almoxarifado)</label>
                             <input type="text" id="input-responsavel-entrada-agua" class="form-input" placeholder="Nome de quem recebeu" required>
                        </div>
                         <div class="mb-4">
                             <label for="input-nf-entrada-agua" class="form-label">Nota Fiscal (Opcional)</label>
                             <input type="text" id="input-nf-entrada-agua" class="form-input" placeholder="Nº da Nota Fiscal">
                        </div>
                        <button type="submit" id="btn-submit-entrada-agua" class="btn btn-primary w-full">Salvar Entrada</button>
                    </form>

                    <div id="alert-agua" class="alert mt-4"></div>
                </div>
                
                <!-- Coluna de Status e Previsão -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Card Status (Pendentes) -->
                    <div class="card">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Status de Galões (Pendentes nas Unidades)</h2>
                        <p class="text-sm text-slate-500 mb-4">Lista de unidades e saldo de galões. Passe o mouse na linha para ver o último responsável.</p>
                        <div id="alert-agua-lista" class="alert mb-4"></div>
                        <div class="overflow-x-auto">
                            <table class="table w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Unidade</th>
                                        <th>Tipo</th>
                                        <th>Entregues</th>
                                        <th>Recebidos</th>
                                        <th>Pendentes</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="table-status-agua">
                                    <tr><td colspan="6" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Card Previsão -->
                    <div class="card">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Previsão de Consumo (Água)</h2>
                        <p class="text-sm text-slate-500 mb-4">Calcule a média de entregas para prever a necessidade de estoque.</p>
                        <div class="flex flex-wrap gap-4 items-end">
                            <div class="flex-grow">
                                <label for="select-previsao-unidade-agua" class="form-label">Unidade</label>
                                <select id="select-previsao-unidade-agua" class="form-select"></select>
                            </div>
                            <button id="btn-calcular-previsao-agua" class="btn btn-secondary">Calcular</button>
                        </div>
                        <div id="resultado-previsao-agua" class="mt-4 hidden">
                            <h4 class="font-semibold text-slate-700">Resultado da Previsão (<span id="previsao-agua-label"></span>):</h4>
                            <ul class="list-disc list-inside space-y-1 mt-2 text-slate-600">
                                <li id="previsao-agua-media">Consumo Médio Diário: <strong>0.00</strong></li>
                                <li id="previsao-agua-semanal">Previsão Semanal (7 dias): <strong>0</strong></li>
                                <li id="previsao-agua-mensal">Previsão Mensal (30 dias): <strong>0</strong></li>
                            </ul>
                            <p id="previsao-agua-erro" class="text-sm text-red-600 mt-2"></p>
                        </div>
                    </div>

                    <!-- NOVO Card: Histórico de Entradas -->
                     <div class="card">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Histórico de Entradas no Estoque (Água)</h2>
                        <div id="alert-historico-agua" class="alert mb-4"></div>
                        <div class="overflow-x-auto max-h-96">
                            <table class="table w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Qtd.</th>
                                        <th>Responsável</th>
                                        <th>NF</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="table-historico-agua">
                                    <tr><td colspan="6" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Conteúdo Controle de Gás -->
        <div id="content-gas" class="hidden fade-in">
             <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                
                <!-- Card: Resumo do Estoque Gás -->
                <div class="lg:col-span-1 card bg-orange-50">
                    <h2 class="text-xl font-bold text-orange-800 mb-4">Estoque de Gás</h2>
                     
                    <!-- Form Estoque Inicial (Condicional) -->
                    <div id="form-inicial-gas-container" class="hidden bg-white p-4 rounded-md border border-orange-200 mb-4">
                        <h3 class="text-sm font-semibold mb-2 text-orange-700">Ponta-pé Inicial</h3>
                        <p class="text-xs text-slate-500 mb-3">Informe a quantidade inicial para começar.</p>
                        <form id="form-inicial-gas">
                            <div class="mb-2">
                                <label for="input-inicial-qtd-gas" class="form-label text-xs">Qtd. Inicial</label>
                                <input type="number" id="input-inicial-qtd-gas" class="form-input form-input-sm py-1 px-2 text-sm" min="0" value="0" required>
                            </div>
                            <div class="mb-3">
                                 <label for="input-inicial-responsavel-gas" class="form-label text-xs">Responsável</label>
                                 <input type="text" id="input-inicial-responsavel-gas" class="form-input form-input-sm py-1 px-2 text-sm" placeholder="Seu nome" required>
                            </div>
                            <button type="submit" id="btn-submit-inicial-gas" class="btn btn-primary btn-sm w-full">Salvar Inicial</button>
                        </form>
                         <div id="alert-inicial-gas" class="alert mt-3 text-xs p-2"></div>
                    </div>

                    <!-- Botão para abrir form inicial (Condicional) -->
                    <button id="btn-abrir-inicial-gas" class="btn btn-secondary btn-sm w-full mb-4 hidden">Definir Estoque Inicial</button>
                     
                    <!-- Resumo Normal -->
                    <ul id="resumo-estoque-gas" class="space-y-3 text-sm hidden">
                        <li class="flex justify-between items-center">
                            <span class="text-slate-600">Estoque Inicial:</span>
                            <strong id="estoque-gas-inicial" class="text-lg">0</strong>
                        </li>
                        <li class="flex justify-between items-center">
                            <span class="text-slate-600">Total de Entradas:</span>
                            <strong id="estoque-gas-entradas" class="text-lg text-green-600">+0</strong>
                        </li>
                        <li class="flex justify-between items-center">
                            <span class="text-slate-600">Total de Saídas:</span>
                            <strong id="estoque-gas-saidas" class="text-lg text-red-600">-0</strong>
                        </li>
                        <li class="flex justify-between items-center text-lg font-bold border-t pt-2 mt-2 border-orange-200">
                            <span class="text-orange-900">Disponível:</span>
                            <strong id="estoque-gas-atual" class="text-2xl text-orange-900">0</strong>
                        </li>
                    </ul>
                    <div id="loading-estoque-gas" class="text-center py-4">
                        <div class="loading-spinner-small mx-auto"></div>
                    </div>
                </div>

                <!-- Coluna de Lançamento (com abas) -->
                <div class="lg:col-span-1 card">
                    <!-- Abas de Saída/Entrada -->
                    <div class="flex border-b mb-4 -mx-6 px-2">
                        <button class="form-tab-btn active" data-form="saida-gas">🔥 Saída (Unidades)</button>
                        <button class="form-tab-btn" data-form="entrada-gas">📥 Entrada (Estoque)</button>
                    </div>

                    <!-- Form 1: Saída -->
                    <form id="form-gas" class="">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Lançar Saída (Gás)</h2>
                        <div class="mb-4">
                            <label for="select-unidade-gas" class="form-label">Unidade (Apenas habilitadas)</label>
                            <select id="select-unidade-gas" class="form-select" required></select>
                        </div>
                        <div class="mb-4">
                            <label for="select-tipo-gas" class="form-label">Tipo de Movimentação</label>
                            <select id="select-tipo-gas" class="form-select" required>
                                <option value="entrega">Saída de Botijão (Cheio)</option>
                                <option value="retorno">Retorno de Botijão (Vazio)</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="input-qtd-gas" class="form-label">Quantidade</label>
                            <input type="number" id="input-qtd-gas" class="form-input" min="1" value="1" required>
                        </div>
                         <div class="mb-4">
                            <label for="input-data-gas" class="form-label">Data</label>
                            <input type="date" id="input-data-gas" class="form-input" required>
                        </div>
                         <div class="mb-4">
                             <label for="input-responsavel-gas" class="form-label">Responsável (Unidade)</label>
                             <input type="text" id="input-responsavel-gas" class="form-input" placeholder="Nome de quem recebeu/entregou" required>
                        </div>
                        <button type="submit" id="btn-submit-gas" class="btn btn-primary w-full">Salvar Saída</button>
                    </form>

                    <!-- Form 2: Entrada -->
                    <form id="form-entrada-gas" class="hidden">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Dar Entrada no Estoque (Gás)</h2>
                        <div class="mb-4">
                            <label for="input-qtd-entrada-gas" class="form-label">Quantidade</label>
                            <input type="number" id="input-qtd-entrada-gas" class="form-input" min="1" value="1" required>
                        </div>
                        <div class="mb-4">
                            <label for="input-data-entrada-gas" class="form-label">Data da Entrada</label>
                            <input type="date" id="input-data-entrada-gas" class="form-input" required>
                        </div>
                        <div class="mb-4">
                             <label for="input-responsavel-entrada-gas" class="form-label">Recebido por (Almoxarifado)</label>
                             <input type="text" id="input-responsavel-entrada-gas" class="form-input" placeholder="Nome de quem recebeu" required>
                        </div>
                         <div class="mb-4">
                             <label for="input-nf-entrada-gas" class="form-label">Nota Fiscal (Opcional)</label>
                             <input type="text" id="input-nf-entrada-gas" class="form-input" placeholder="Nº da Nota Fiscal">
                        </div>
                        <button type="submit" id="btn-submit-entrada-gas" class="btn btn-primary w-full">Salvar Entrada</button>
                    </form>

                    <div id="alert-gas" class="alert mt-4"></div>
                </div>
                
                <!-- Coluna de Status e Previsão -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Card Status Gás -->
                    <div class="card">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Status de Botijões (Pendentes nas Unidades)</h2>
                        <p class="text-sm text-slate-500 mb-4">Lista de unidades e saldo de botijões. Passe o mouse na linha para ver o último responsável.</p>
                        <div id="alert-gas-lista" class="alert mb-4"></div>
                        <div class="overflow-x-auto">
                            <table class="table w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Unidade</th>
                                        <th>Tipo</th>
                                        <th>Entregues</th>
                                        <th>Recebidos</th>
                                        <th>Pendentes</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="table-status-gas">
                                    <tr><td colspan="6" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Card Previsão Gás -->
                    <div class="card">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Previsão de Consumo (Gás)</h2>
                        <p class="text-sm text-slate-500 mb-4">Calcule a média de entregas para prever a necessidade de estoque.</p>
                        <div class="flex flex-wrap gap-4 items-end">
                            <div class="flex-grow">
                                <label for="select-previsao-unidade-gas" class="form-label">Unidade</label>
                                <select id="select-previsao-unidade-gas" class="form-select"></select>
                            </div>
                            <button id="btn-calcular-previsao-gas" class="btn btn-secondary">Calcular</button>
                        </div>
                        <div id="resultado-previsao-gas" class="mt-4 hidden">
                            <h4 class="font-semibold text-slate-700">Resultado da Previsão (<span id="previsao-gas-label"></span>):</h4>
                            <ul class="list-disc list-inside space-y-1 mt-2 text-slate-600">
                                <li id="previsao-gas-media">Consumo Médio Diário: <strong>0.00</strong></li>
                                <li id="previsao-gas-semanal">Previsão Semanal (7 dias): <strong>0</strong></li>
                                <li id="previsao-gas-mensal">Previsão Mensal (30 dias): <strong>0</strong></li>
                            </ul>
                            <p id="previsao-gas-erro" class="text-sm text-red-600 mt-2"></p>
                        </div>
                    </div>

                    <!-- NOVO Card: Histórico de Entradas Gás -->
                     <div class="card">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Histórico de Entradas no Estoque (Gás)</h2>
                        <div id="alert-historico-gas" class="alert mb-4"></div>
                        <div class="overflow-x-auto max-h-96">
                            <table class="table w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Qtd.</th>
                                        <th>Responsável</th>
                                        <th>NF</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="table-historico-gas">
                                    <tr><td colspan="6" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Conteúdo Entrega de Materiais -->
        <div id="content-materiais" class="hidden fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Coluna de Lançamento -->
                <div class="lg:col-span-1 card">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Registrar Separação de Material</h2>
                    <form id="form-materiais">
                        <div class="mb-4">
                            <label for="select-unidade-materiais" class="form-label">Unidade (Apenas habilitadas)</label>
                            <select id="select-unidade-materiais" class="form-select" required></select>
                        </div>
                        <div class="mb-4">
                            <label for="select-tipo-materiais" class="form-label">Tipo de Material</label>
                            <select id="select-tipo-materiais" class="form-select" required>
                                <option value="alimento">Alimento</option>
                                <option value="expediente">Expediente</option>
                                <option value="limpeza">Limpeza</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="input-data-separacao" class="form-label">Data da Separação</label>
                            <input type="date" id="input-data-separacao" class="form-input" required>
                        </div>
                        <div class="mb-4">
                             <label for="textarea-itens-materiais" class="form-label">Itens Separados (Opcional)</label>
                             <textarea id="textarea-itens-materiais" class="form-textarea" placeholder="Ex: 10x Arroz 5kg, 5x Resma A4, 2x Água Sanitária 1L..."></textarea>
                        </div>
                         <div class="mb-4">
                             <label for="input-responsavel-materiais" class="form-label">Responsável (Separação)</label>
                             <input type="text" id="input-responsavel-materiais" class="form-input" placeholder="Nome de quem separou" required>
                        </div>
                        <button type="submit" id="btn-submit-materiais" class="btn btn-primary w-full">Registrar Separação</button>
                    </form>
                    <div id="alert-materiais" class="alert mt-4"></div>
                </div>
                
                <!-- Coluna de Status -->
                <div class="lg:col-span-2 card">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Materiais em Separação / Entregues</h2>
                    <p class="text-sm text-slate-500 mb-4">Lista de materiais separados. Clique em "Entregue" para confirmar a entrega.</p>
                    <div id="alert-materiais-lista" class="alert mb-4"></div>
                    <div class="overflow-x-auto">
                        <table class="table w-full text-sm">
                            <thead>
                                <tr>
                                    <th>Unidade</th>
                                    <th>Tipo</th>
                                    <th>Data Separação</th>
                                    <th>Status</th>
                                    <th class="text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="table-status-materiais">
                               <tr><td colspan="5" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo Gestão de Unidades -->
        <div id="content-gestao" class="hidden fade-in">
            <div class="card max-w-4xl mx-auto">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Gestão de Unidades de Atendimento</h2>
                <div id="alert-gestao" class="alert mb-4"></div>

                <!-- Seção de Adicionar Novas Unidades -->
                <div class="mb-8 p-4 border border-slate-200 rounded-lg bg-slate-50">
                     <h3 class="font-semibold text-slate-700 mb-2">Adicionar Novas Unidades</h3>
                     <p class="text-sm text-slate-500 mb-3">Cole aqui a lista de unidades (uma por linha) no formato: <strong>Tipo [TAB] Nome da Unidade</strong>. Exemplo:</p>
                     <pre class="text-xs bg-white p-2 rounded border border-slate-300 mb-3">CRAS	Anjo da Guarda<br>CREAS	Centro</pre>
                     <textarea id="textarea-bulk-unidades" class="form-textarea mb-3" rows="5" placeholder="Cole os dados aqui..."></textarea>
                     <button id="btn-bulk-add-unidades" class="btn btn-primary">Adicionar Unidades</button>
                </div>

                <!-- Tabela de Gestão Existente -->
                <h3 class="font-semibold text-slate-700 mb-2">Habilitar Serviços por Unidade</h3>
                <p class="text-sm text-slate-500 mb-4">Marque as caixas para habilitar o recebimento de Água, Gás ou Materiais. As alterações são salvas automaticamente.</p>
                <div class="overflow-x-auto">
                    <table class="table w-full text-sm">
                        <thead>
                            <tr>
                                <th>Unidade</th>
                                <th>Tipo</th>
                                <th class="text-center">💧 Água</th>
                                <th class="text-center">🔥 Gás</th>
                                <th class="text-center">🚚 Materiais</th>
                            </tr>
                        </thead>
                        <tbody id="table-gestao-unidades">
                             <tr><td colspan="5" class="text-center py-10"><div class="loading-spinner-small mx-auto"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Conteúdo Gerar Relatório (NOVO) -->
        <div id="content-relatorio" class="hidden fade-in">
            <div class="card max-w-2xl mx-auto">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Gerar Relatório em PDF</h2>
                <p class="text-sm text-slate-500 mb-6">Selecione o tipo de relatório e o período desejado. O relatório será gerado e baixado automaticamente.</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="relatorio-tipo" class="form-label">Tipo de Relatório</label>
                        <select id="relatorio-tipo" class="form-select">
                            <option value="agua">💧 Fornecimento de Água</option>
                            <option value="gas">🔥 Fornecimento de Gás</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="relatorio-data-inicio" class="form-label">Data Início</label>
                            <input type="date" id="relatorio-data-inicio" class="form-input" required>
                        </div>
                        <div>
                            <label for="relatorio-data-fim" class="form-label">Data Fim</label>
                            <input type="date" id="relatorio-data-fim" class="form-input" required>
                        </div>
                    </div>
                    <button id="btn-gerar-pdf" class="btn btn-primary w-full">Gerar Relatório PDF</button>
                </div>
                <div id="alert-relatorio" class="alert mt-4"></div>
            </div>
        </div>


    </main>

    <!-- 5. Rodapé -->
    <footer class="text-center mt-12 mb-6 text-sm text-slate-500">
        <p>Painel de Controle de Almoxarifado - SEMCAS (v.6.2)</p>
    </footer>
    

     <!-- Modal de Confirmação de Exclusão -->
    <div id="confirm-delete-modal" class="modal">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h2 class="modal-title text-red-600">Confirmar Exclusão</h2>
          <button class="modal-close" onclick="document.getElementById('confirm-delete-modal').style.display='none'">&times;</button>
        </div>
        <div class="modal-body">
            <p>Tem certeza que deseja remover este lançamento? Esta ação não pode ser desfeita.</p>
            <p id="delete-details" class="text-sm text-slate-600 mt-2"></p>
        </div>
        <div class="modal-footer space-x-2">
          <button id="btn-cancel-delete" class="btn-secondary">Cancelar</button>
          <button id="btn-confirm-delete" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Confirmar Exclusão</button>
        </div>
      </div>
    </div>

    <!-- Modal de Configuração Inicial REMOVIDO -->

    <!-- Script Principal -->
    <script type="module">
        // --- IMPORTS DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, Timestamp, serverTimestamp, setLogLevel, setDoc, getDocs, where, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        
        // Configuração fallback do Firebase
        const userFallbackConfig = { 
            apiKey: "AIzaSyD7VCxaHo8veaHnM8RwY60EX_DEh3hOVHk", 
            authDomain: "controle-almoxarifado-semcas.firebaseapp.com", 
            projectId: "controle-almoxarifado-semcas", 
            storageBucket: "controle-almoxarifado-semcas.firebasestorage.app", 
            messagingSenderId: "916615427315", 
            appId: "1:916615427315:web:6823897ed065c50d413386" 
        };
        
        // Pega as variáveis globais do ambiente (Canvas) ou usa o fallback
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(userFallbackConfig);
        const firebaseConfig = JSON.parse(firebaseConfigString);
        
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const appId = rawAppId.replace(/[\/.]/g, '-'); // Limpa o AppId
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db, userId;
        let isAuthReady = false;
        
        // Coleções de Saída (Movimentação)
        let unidadesCollection, aguaCollection, gasCollection, materiaisCollection;
        // Coleções de Entrada (Estoque)
        let estoqueAguaCollection, estoqueGasCollection;

        // Arrays de dados locais
        let fb_unidades = [], fb_agua_movimentacoes = [], fb_gas_movimentacoes = [], fb_materiais = [];
        let fb_estoque_agua = [], fb_estoque_gas = [];
        let estoqueInicialDefinido = { agua: false, gas: false }; // Controla se o inicial já foi carregado/definido
        
        let visaoAtiva = 'dashboard'; 
        let dashboardAguaChartInstance, dashboardGasChartInstance;
        let dashboardRefreshInterval = null;
        let deleteInfo = { id: null, type: null, collectionRef: null };

        // --- Referências de Elementos (DOM) ---
        let navButtons, contentPanes, connectionStatusEl, lastUpdateTimeEl;
        // Dashboard
        let dashboardNavControls, dashboardViewPanes;
        let summaryAguaPendente, summaryAguaEntregue, summaryAguaRecebido;
        let summaryGasPendente, summaryGasEntregue, summaryGasRecebido;
        let dashboardMateriaisProntosContainer, loadingMateriaisProntos;
        let dashboardMateriaisListContainer, loadingMateriaisDashboard;
        // Água
        let formAgua, selectUnidadeAgua, selectTipoAgua, inputQtdAgua, inputDataAgua, inputResponsavelAgua, btnSubmitAgua, alertAgua, tableStatusAgua, alertAguaLista;
        let selectPrevisaoUnidadeAgua, btnCalcularPrevisaoAgua, resultadoPrevisaoAgua, previsaoAguaLabel, previsaoAguaMedia, previsaoAguaSemanal, previsaoAguaMensal, previsaoAguaErro;
        // Gás
        let formGas, selectUnidadeGas, selectTipoGas, inputQtdGas, inputDataGas, inputResponsavelGas, btnSubmitGas, alertGas, tableStatusGas, alertGasLista;
        let selectPrevisaoUnidadeGas, btnCalcularPrevisaoGas, resultadoPrevisaoGas, previsaoGasLabel, previsaoGasMedia, previsaoGasSemanal, previsaoGasMensal, previsaoGasErro;
        // Materiais
        let formMateriais, selectUnidadeMateriais, selectTipoMateriais, inputDataSeparacao, textareaItensMateriais, inputResponsavelMateriais, btnSubmitMateriais, alertMateriais, tableStatusMateriais, alertMateriaisLista;
        // Gestão
        let tableGestaoUnidades, alertGestao, textareaBulkUnidades, btnBulkAddUnidades;
        // Relatório PDF
        let relatorioTipo, relatorioDataInicio, relatorioDataFim, btnGerarPdf, alertRelatorio;
        // Modal Delete
        let confirmDeleteModal, btnCancelDelete, btnConfirmDelete, deleteDetailsEl;
        
        // Elementos de Estoque (Água)
        let estoqueAguaInicialEl, estoqueAguaEntradasEl, estoqueAguaSaidasEl, estoqueAguaAtualEl, loadingEstoqueAguaEl, resumoEstoqueAguaEl;
        let formEntradaAgua, inputQtdEntradaAgua, inputDataEntradaAgua, inputResponsavelEntradaAgua, inputNfEntradaAgua, btnSubmitEntradaAgua;
        let formInicialAguaContainer, formInicialAgua, inputInicialQtdAgua, inputInicialResponsavelAgua, btnSubmitInicialAgua, alertInicialAgua, btnAbrirInicialAgua; // Novo form inicial
        let tableHistoricoAgua, alertHistoricoAgua; // Novo histórico
        
        // Elementos de Estoque (Gás)
        let estoqueGasInicialEl, estoqueGasEntradasEl, estoqueGasSaidasEl, estoqueGasAtualEl, loadingEstoqueGasEl, resumoEstoqueGasEl;
        let formEntradaGas, inputQtdEntradaGas, inputDataEntradaGas, inputResponsavelEntradaGas, inputNfEntradaGas, btnSubmitEntradaGas;
        let formInicialGasContainer, formInicialGas, inputInicialQtdGas, inputInicialResponsavelGas, btnSubmitInicialGas, alertInicialGas, btnAbrirInicialGas; // Novo form inicial
        let tableHistoricoGas, alertHistoricoGas; // Novo histórico


        // --- FUNÇÕES DE UTILIDADE ---

        /**
         * Exibe um alerta temporário na tela.
         * @param {string} elementId - ID do elemento de alerta.
         * @param {string} message - Mensagem a ser exibida.
         * @param {string} type - Tipo do alerta (error, success, warning, info).
         * @param {number} duration - Duração em milissegundos.
         */
        function showAlert(elementId, message, type = 'info', duration = 5000) {
            const el = document.getElementById(elementId);
            if (!el) { console.warn(`Elemento de alerta não encontrado: ${elementId}`); return; }
            el.className = `alert alert-${type}`; 
            el.textContent = message;
            el.style.display = 'block';
            if (el.timeoutId) clearTimeout(el.timeoutId);
            el.timeoutId = setTimeout(() => {
                el.style.display = 'none';
                el.timeoutId = null;
            }, duration);
        }

        /**
         * Retorna a data de hoje formatada como 'YYYY-MM-DD'.
         */
        function getTodayDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        /**
         * Converte uma string 'YYYY-MM-DD' para um Timestamp do Firebase.
         */
        function dateToTimestamp(dateString) {
             if (!dateString) return null;
            try {
                // Adiciona T00:00:00 para evitar problemas de fuso horário
                const date = new Date(dateString + 'T00:00:00'); 
                if (isNaN(date.getTime())) return null; 
                return Timestamp.fromDate(date);
            } catch (e) { console.error("Erro ao converter data:", dateString, e); return null; }
        }

        /**
         * Formata um Timestamp do Firebase para 'DD/MM/YYYY'.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp || typeof timestamp.toDate !== 'function') return 'N/A';
            try {
                const date = timestamp.toDate();
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                if (yyyy < 2000) return 'Data Inválida'; 
                return `${dd}/${mm}/${yyyy}`;
            } catch (e) { console.error("Erro ao formatar timestamp:", timestamp, e); return 'Erro Data'; }
        }

        /**
         * Normaliza uma string (minúsculas, sem acentos).
         */
        function normalizeString(str) {
            if (!str) return '';
            return String(str).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        /**
         * Capitaliza a primeira letra de cada palavra em uma string.
         */
        function capitalizeString(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
        }

        // --- INICIALIZAÇÃO E AUTENTICAÇÃO FIREBASE ---
        
        /**
         * Inicializa o Firebase, configura autenticação e define os caminhos das coleções.
         */
        async function initFirebase() {
             try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Habilitar para ver logs detalhados do Firebase
                
                connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-yellow-400 rounded-full animate-pulse"></span> <span>Autenticando...</span>`;

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        userId = user.uid;
                        console.log("Autenticado com UID:", userId, "Anônimo:", user.isAnonymous);
                        connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-green-500 rounded-full"></span> <span class="text-green-700">Conectado</span>`;
                        
                        // Define os caminhos das coleções usando o appId do ambiente
                        const basePath = `artifacts/${appId}/public/data`;
                        unidadesCollection = collection(db, `${basePath}/unidades`);
                        aguaCollection = collection(db, `${basePath}/controleAgua`);
                        gasCollection = collection(db, `${basePath}/controleGas`);
                        materiaisCollection = collection(db, `${basePath}/controleMateriais`);
                        estoqueAguaCollection = collection(db, `${basePath}/estoqueAgua`);
                        estoqueGasCollection = collection(db, `${basePath}/estoqueGas`);
                        
                        console.log("Caminho base das coleções:", basePath);
                        
                        // Inicia os listeners para dados em tempo real
                        initFirestoreListeners();
                        
                    } else {
                        isAuthReady = false;
                        userId = null; 
                        console.log("Usuário deslogado.");
                        connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-red-500 rounded-full"></span> <span class="text-red-700">Desconectado</span>`;
                        clearAlmoxarifadoData(); // Limpa dados da tela
                    }
                    updateLastUpdateTime(); 
                });

                // Tenta autenticar com o token do ambiente ou cai para anônimo
                if (initialAuthToken) {
                    console.log("Tentando login com Custom Token...");
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Nenhum Custom Token encontrado. Tentando login anônimo...");
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                connectionStatusEl.innerHTML = `<span class="h-3 w-3 bg-red-500 rounded-full"></span> <span class="text-red-700">Erro Firebase</span>`;
                showAlert('alert-agua', `Erro crítico na conexão com Firebase: ${error.message}. Recarregue a página.`, 'error', 60000);
            }
        }

        // --- LÓGICA DO FIRESTORE (LISTENERS) ---
        
        /**
         * Inicia os listeners (onSnapshot) para todas as coleções de dados.
         */
        function initFirestoreListeners() {
            if (!isAuthReady || !unidadesCollection) { 
                console.warn("Firestore listeners não iniciados: Auth não pronto ou coleção inválida."); 
                return; 
            }
            console.log("Iniciando listeners do Firestore...");

            // Listener para Unidades
            onSnapshot(query(unidadesCollection), (snapshot) => { 
                fb_unidades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));
                // Atualiza todos os <select> de unidades na aplicação
                populateUnidadeSelects(selectUnidadeAgua, 'atendeAgua');
                populateUnidadeSelects(selectUnidadeGas, 'atendeGas');
                populateUnidadeSelects(selectUnidadeMateriais, 'atendeMateriais');
                populateUnidadeSelects(selectPrevisaoUnidadeAgua, 'atendeAgua', true); 
                populateUnidadeSelects(selectPrevisaoUnidadeGas, 'atendeGas', true); 
                renderGestaoUnidades(); // Atualiza tabela de gestão
                renderAguaStatus(); // Recalcula status de água
                renderGasStatus(); // Recalcula status de gás
                console.log("Unidades atualizadas:", fb_unidades.length);
            }, (error) => { console.error("Erro no listener de unidades:", error); showAlert('alert-gestao', `Erro ao carregar unidades: ${error.message}`, 'error'); });

            // Listener para Saídas de Água
            onSnapshot(query(aguaCollection), (snapshot) => {
                fb_agua_movimentacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAguaStatus(); 
                renderDashboardAguaChart(); 
                renderDashboardAguaSummary();
                renderEstoqueAgua(); // Recalcula estoque
                console.log("Mov. Água (Saídas) atualizadas:", fb_agua_movimentacoes.length);
            }, (error) => { console.error("Erro no listener de água:", error); showAlert('alert-agua-lista', `Erro ao carregar dados de água: ${error.message}`, 'error'); });

            // Listener para Saídas de Gás
            onSnapshot(query(gasCollection), (snapshot) => {
                fb_gas_movimentacoes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGasStatus(); 
                renderDashboardGasChart(); 
                renderDashboardGasSummary();
                renderEstoqueGas(); // Recalcula estoque
                console.log("Mov. Gás (Saídas) atualizadas:", fb_gas_movimentacoes.length);
            }, (error) => { console.error("Erro no listener de gás:", error); showAlert('alert-gas-lista', `Erro ao carregar dados de gás: ${error.message}`, 'error'); });

            // Listener para Materiais
            onSnapshot(query(materiaisCollection), (snapshot) => {
                fb_materiais = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMateriaisStatus(); 
                renderDashboardMateriaisList();
                renderDashboardMateriaisProntos(); 
                console.log("Materiais atualizados:", fb_materiais.length);
            }, (error) => { console.error("Erro no listener de materiais:", error); showAlert('alert-materiais-lista', `Erro ao carregar materiais: ${error.message}`, 'error'); });
        
            // --- LISTENERS DE ESTOQUE (ENTRADAS) ---
            
            // Listener para Entradas de Estoque de Água
            onSnapshot(query(estoqueAguaCollection), (snapshot) => {
                fb_estoque_agua = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Verifica se existe alguma entrada do tipo 'inicial'
                estoqueInicialDefinido.agua = fb_estoque_agua.some(e => e.tipo === 'inicial');
                renderEstoqueAgua(); // Recalcula e atualiza UI
                renderHistoricoAgua(); // Atualiza histórico
                console.log("Estoque Água (Entradas) atualizado:", fb_estoque_agua.length, "Inicial definido:", estoqueInicialDefinido.agua);
            }, (error) => { console.error("Erro no listener de estoque água:", error); });

            // Listener para Entradas de Estoque de Gás
            onSnapshot(query(estoqueGasCollection), (snapshot) => {
                fb_estoque_gas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Verifica se existe alguma entrada do tipo 'inicial'
                estoqueInicialDefinido.gas = fb_estoque_gas.some(e => e.tipo === 'inicial');
                renderEstoqueGas(); // Recalcula e atualiza UI
                renderHistoricoGas(); // Atualiza histórico
                console.log("Estoque Gás (Entradas) atualizado:", fb_estoque_gas.length, "Inicial definido:", estoqueInicialDefinido.gas);
            }, (error) => { console.error("Erro no listener de estoque gás:", error); });
        }
        
        /**
         * Limpa todos os dados da interface em caso de desconexão.
         */
        function clearAlmoxarifadoData() {
            fb_unidades = []; fb_agua_movimentacoes = []; fb_gas_movimentacoes = []; fb_materiais = [];
            fb_estoque_agua = []; fb_estoque_gas = []; 
            estoqueInicialDefinido = { agua: false, gas: false };

            [selectUnidadeAgua, selectUnidadeGas, selectUnidadeMateriais, selectPrevisaoUnidadeAgua, selectPrevisaoUnidadeGas].forEach(sel => { if(sel) sel.innerHTML = '<option value="">Desconectado</option>'; });
            [tableStatusAgua, tableStatusGas, tableStatusMateriais, tableGestaoUnidades, tableHistoricoAgua, tableHistoricoGas].forEach(tbody => { if(tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Desconectado do Firebase</td></tr>'; });
            [dashboardMateriaisListContainer, dashboardMateriaisProntosContainer].forEach(el => { if(el) el.innerHTML = '<p class="text-center py-4 text-red-500">Desconectado</p>'; });
            [dashboardAguaChartInstance, dashboardGasChartInstance].forEach(chartInstance => { if (chartInstance) { chartInstance.data.datasets.forEach(ds => ds.data = []); chartInstance.update(); } });
            
            // Limpa cards de estoque
            [estoqueAguaInicialEl, estoqueAguaEntradasEl, estoqueAguaSaidasEl, estoqueAguaAtualEl, estoqueGasInicialEl, estoqueGasEntradasEl, estoqueGasSaidasEl, estoqueGasAtualEl].forEach(el => { if(el) el.textContent = '0'; });
            [resumoEstoqueAguaEl, resumoEstoqueGasEl].forEach(el => { if(el) el.classList.add('hidden'); });
            [loadingEstoqueAguaEl, loadingEstoqueGasEl].forEach(el => { if(el) el.style.display = 'block'; });
            [btnAbrirInicialAgua, btnAbrirInicialGas].forEach(btn => { if(btn) btn.classList.remove('hidden'); }); // Mostra botão inicial
            [formInicialAguaContainer, formInicialGasContainer].forEach(form => { if(form) form.classList.add('hidden'); }); // Esconde form inicial
            
            console.log("Dados do Almoxarifado limpos devido à desconexão.");
        }

        /**
         * Atualiza o horário da última atualização no sub-header.
         */
        function updateLastUpdateTime() {
             if (!lastUpdateTimeEl) return;
            const now = new Date();
            const formattedDate = now.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
            lastUpdateTimeEl.textContent = `Atualizado: ${formattedDate}`;
        }

        /**
         * Popula um elemento <select> com as unidades, agrupadas por tipo.
         * @param {HTMLElement} selectEl - O elemento <select> a ser populado.
         * @param {string} serviceField - O campo de serviço (ex: 'atendeAgua') para filtrar.
         * @param {boolean} includeAll - Se deve incluir a opção "Todas as Unidades".
         */
        function populateUnidadeSelects(selectEl, serviceField, includeAll = false) {
            if (!selectEl) return;
            
            // Filtra unidades que atendem ao serviço (ou todas, se 'atende*' for true ou indefinido)
            const unidadesFiltradas = fb_unidades.filter(u => serviceField ? (u[serviceField] ?? true) : true);
            
            if (unidadesFiltradas.length === 0) { 
                selectEl.innerHTML = '<option value="">Nenhuma unidade habilitada</option>'; 
                return; 
            }
            
            // Agrupa por tipo (CRAS, CREAS, etc.)
            const grupos = unidadesFiltradas.reduce((acc, unidade) => { 
                const tipo = unidade.tipo || 'Sem Tipo'; 
                if (!acc[tipo]) acc[tipo] = []; 
                acc[tipo].push(unidade); 
                return acc; 
            }, {});
            const tiposOrdenados = Object.keys(grupos).sort();
            
            let html = includeAll ? '<option value="todas">Todas as Unidades</option>' : '<option value="">Selecione uma unidade...</option>';
            
            // Cria os <optgroup>
            tiposOrdenados.forEach(tipo => {
                html += `<optgroup label="${tipo.toUpperCase()}">`;
                grupos[tipo].sort((a,b) => a.nome.localeCompare(b.nome)).forEach(unidade => { 
                    // O valor do select armazena ID, Nome e Tipo separados por pipe
                    const optionValue = includeAll ? unidade.id : `${unidade.id}|${unidade.nome}|${unidade.tipo}`;
                    html += `<option value="${optionValue}">${unidade.nome}</option>`; 
                });
                html += `</optgroup>`;
            });
            selectEl.innerHTML = html;
        }

        // --- LÓGICA DE CONTROLE DE ÁGUA (SAÍDA) ---
        
        /**
         * Manipula o submit do formulário de SAÍDA de água.
         */
        async function handleAguaSubmit(e) {
             e.preventDefault();
            if (!isAuthReady) { showAlert('alert-agua', 'Erro: Não autenticado.', 'error'); return; }
            
            const selectValue = selectUnidadeAgua.value; 
            if (!selectValue) { showAlert('alert-agua', 'Selecione uma unidade.', 'warning'); return; }
            
            const [unidadeId, unidadeNome, tipoUnidade] = selectValue.split('|');
            const tipo = selectTipoAgua.value;
            const quantidade = parseInt(inputQtdAgua.value, 10);
            const data = dateToTimestamp(inputDataAgua.value);
            const responsavel = capitalizeString(inputResponsavelAgua.value.trim()); 

            if (!unidadeId || !tipo || !quantidade || quantidade <= 0 || !data || !responsavel) {
                showAlert('alert-agua', 'Dados inválidos. Verifique todos os campos (incluindo Responsável).', 'warning'); return;
            }

            // Validação de Estoque
            if (!estoqueInicialDefinido.agua) {
                 showAlert('alert-agua', 'Defina o Estoque Inicial de Água antes de lançar saídas.', 'warning'); return;
            }
            if (tipo === 'entrega') {
                const estoqueAtual = parseInt(estoqueAguaAtualEl.textContent) || 0;
                if (quantidade > estoqueAtual) {
                    showAlert('alert-agua', `Erro: Estoque insuficiente. Disponível: ${estoqueAtual}`, 'error'); return;
                }
            }
            
            btnSubmitAgua.disabled = true; btnSubmitAgua.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            
            try {
                // Adiciona o documento na coleção de saídas de água
                await addDoc(aguaCollection, { 
                    unidadeId, 
                    unidadeNome, 
                    tipoUnidade, 
                    tipo, // 'entrega' ou 'retorno'
                    quantidade, 
                    data, 
                    responsavel, 
                    registradoEm: serverTimestamp() 
                });
                showAlert('alert-agua', `Lançamento de ${tipo} de água salvo!`, 'success');
                formAgua.reset(); 
                inputDataAgua.value = getTodayDateString(); 
            } catch (error) { 
                console.error("Erro salvar água:", error); 
                showAlert('alert-agua', `Erro: ${error.message}`, 'error');
            } finally { 
                btnSubmitAgua.disabled = false; 
                btnSubmitAgua.textContent = 'Salvar Saída'; 
            }
        }

        /**
         * Renderiza a tabela de status de galões pendentes por unidade.
         */
        function renderAguaStatus() {
             if (!tableStatusAgua) return;
             
             // Cria um mapa com todas as unidades
             const statusMap = new Map();
             fb_unidades.forEach(u => { statusMap.set(u.id, { id: u.id, nome: u.nome, tipo: u.tipo, entregues: 0, recebidos: 0, ultimosLancamentos: [] }); });

             // Ordena as movimentações pela data de registro (mais recente primeiro)
             const movsOrdenadas = [...fb_agua_movimentacoes].sort((a, b) => (b.registradoEm?.toMillis() || 0) - (a.registradoEm?.toMillis() || 0));

             // Processa as movimentações para calcular saldos
             movsOrdenadas.forEach(m => {
                 if (statusMap.has(m.unidadeId)) {
                     const unidadeStatus = statusMap.get(m.unidadeId);
                     if (m.tipo === 'entrega') unidadeStatus.entregues += m.quantidade;
                     else if (m.tipo === 'retorno') unidadeStatus.recebidos += m.quantidade;
                     
                     // Guarda os 2 últimos lançamentos para o tooltip e botão de exclusão
                     if (unidadeStatus.ultimosLancamentos.length < 2) { 
                         unidadeStatus.ultimosLancamentos.push({id: m.id, resp: m.responsavel, data: formatTimestamp(m.data), tipo: m.tipo});
                     }
                 }
             });

             // Converte o mapa em array, calcula pendentes, filtra e ordena
             const statusArray = Array.from(statusMap.values())
                 .map(s => ({ ...s, pendentes: s.entregues - s.recebidos }))
                 .filter(s => s.entregues > 0 || s.pendentes !== 0) // Só mostra unidades com movimentação
                 .sort((a, b) => b.pendentes - a.pendentes || a.nome.localeCompare(b.nome)); // Ordena por mais pendentes

            if (statusArray.length === 0) { 
                tableStatusAgua.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Nenhuma movimentação registrada.</td></tr>'; 
                return; 
            }
                
            tableStatusAgua.innerHTML = statusArray.map(s => {
                const tooltipText = s.ultimosLancamentos.map(l => `${l.tipo === 'entrega' ? 'E': 'R'}: ${l.resp} (${l.data})`).join(' | ');
                const ultimoId = s.ultimosLancamentos[0]?.id; // Pega o ID do último lançamento
                return `
                <tr title="${tooltipText || 'Sem detalhes de responsável'}">
                    <td class="font-medium">${s.nome}</td>
                    <td>${s.tipo || 'N/A'}</td>
                    <td class="text-center">${s.entregues}</td>
                    <td class="text-center">${s.recebidos}</td>
                    <td class="text-center font-bold ${s.pendentes > 0 ? 'text-red-600' : (s.pendentes < 0 ? 'text-blue-600' : 'text-green-600')}">${s.pendentes}</td>
                    <td class="text-center">
                        ${ultimoId ? `<button class="btn-danger btn-remove" data-id="${ultimoId}" data-type="agua" title="Remover último lançamento desta unidade"><i data-lucide="trash-2"></i></button>` : '-'}
                    </td>
                </tr>
            `}).join('');
             lucide.createIcons(); // Recria ícones do Lucide
        }
        
        // --- LÓGICA DE CONTROLE DE GÁS (SAÍDA) ---
        
        /**
         * Manipula o submit do formulário de SAÍDA de gás.
         */
        async function handleGasSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) { showAlert('alert-gas', 'Erro: Não autenticado.', 'error'); return; }
            
            const selectValue = selectUnidadeGas.value; 
            if (!selectValue) { showAlert('alert-gas', 'Selecione uma unidade.', 'warning'); return; }
            
            const [unidadeId, unidadeNome, tipoUnidade] = selectValue.split('|');
            const tipo = selectTipoGas.value;
            const quantidade = parseInt(inputQtdGas.value, 10);
            const data = dateToTimestamp(inputDataGas.value);
            const responsavel = capitalizeString(inputResponsavelGas.value.trim()); 

             if (!unidadeId || !tipo || !quantidade || quantidade <= 0 || !data || !responsavel) { 
                showAlert('alert-gas', 'Dados inválidos. Verifique todos os campos (incluindo Responsável).', 'warning'); return;
            }

            // Validação de Estoque
            if (!estoqueInicialDefinido.gas) {
                 showAlert('alert-gas', 'Defina o Estoque Inicial de Gás antes de lançar saídas.', 'warning'); return;
            }
            if (tipo === 'entrega') {
                const estoqueAtual = parseInt(estoqueGasAtualEl.textContent) || 0;
                if (quantidade > estoqueAtual) {
                    showAlert('alert-gas', `Erro: Estoque insuficiente. Disponível: ${estoqueAtual}`, 'error'); return;
                }
            }

            btnSubmitGas.disabled = true; btnSubmitGas.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            
            try {
                // Adiciona o documento na coleção de saídas de gás
                await addDoc(gasCollection, { 
                    unidadeId, 
                    unidadeNome, 
                    tipoUnidade, 
                    tipo, // 'entrega' ou 'retorno'
                    quantidade, 
                    data, 
                    responsavel, 
                    registradoEm: serverTimestamp() 
                });
                showAlert('alert-gas', `Lançamento de ${tipo} de gás salvo!`, 'success');
                formGas.reset(); 
                inputDataGas.value = getTodayDateString(); 
            } catch (error) { 
                console.error("Erro salvar gás:", error); 
                showAlert('alert-gas', `Erro: ${error.message}`, 'error');
            } finally { 
                btnSubmitGas.disabled = false; 
                btnSubmitGas.textContent = 'Salvar Saída'; 
            }
        }

        /**
         * Renderiza a tabela de status de botijões pendentes por unidade.
         */
        function renderGasStatus() {
            if (!tableStatusGas) return;
            
             // Lógica idêntica ao renderAguaStatus, mas para Gás
             const statusMap = new Map();
             fb_unidades.forEach(u => { statusMap.set(u.id, { id: u.id, nome: u.nome, tipo: u.tipo, entregues: 0, recebidos: 0, ultimosLancamentos: [] }); });

             const movsOrdenadas = [...fb_gas_movimentacoes].sort((a, b) => (b.registradoEm?.toMillis() || 0) - (a.registradoEm?.toMillis() || 0));

             movsOrdenadas.forEach(m => {
                 if (statusMap.has(m.unidadeId)) {
                     const unidadeStatus = statusMap.get(m.unidadeId);
                     if (m.tipo === 'entrega') unidadeStatus.entregues += m.quantidade;
                     else if (m.tipo === 'retorno') unidadeStatus.recebidos += m.quantidade;
                     if (unidadeStatus.ultimosLancamentos.length < 2) { 
                         unidadeStatus.ultimosLancamentos.push({id: m.id, resp: m.responsavel, data: formatTimestamp(m.data), tipo: m.tipo});
                     }
                 }
             });

             const statusArray = Array.from(statusMap.values())
                 .map(s => ({ ...s, pendentes: s.entregues - s.recebidos }))
                 .filter(s => s.entregues > 0 || s.pendentes !== 0) 
                 .sort((a, b) => b.pendentes - a.pendentes || a.nome.localeCompare(b.nome));

            if (statusArray.length === 0) { 
                tableStatusGas.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Nenhuma movimentação registrada.</td></tr>'; 
                return; 
            }
                
             tableStatusGas.innerHTML = statusArray.map(s => {
                const tooltipText = s.ultimosLancamentos.map(l => `${l.tipo === 'entrega' ? 'E': 'R'}: ${l.resp} (${l.data})`).join(' | ');
                const ultimoId = s.ultimosLancamentos[0]?.id;
                return `
                <tr title="${tooltipText || 'Sem detalhes de responsável'}">
                    <td class="font-medium">${s.nome}</td>
                    <td>${s.tipo || 'N/A'}</td>
                    <td class="text-center">${s.entregues}</td>
                    <td class="text-center">${s.recebidos}</td>
                    <td class="text-center font-bold ${s.pendentes > 0 ? 'text-red-600' : (s.pendentes < 0 ? 'text-blue-600' : 'text-green-600')}">${s.pendentes}</td>
                     <td class="text-center">
                        ${ultimoId ? `<button class="btn-danger btn-remove" data-id="${ultimoId}" data-type="gas" title="Remover último lançamento"><i data-lucide="trash-2"></i></button>` : '-'}
                    </td>
                </tr>
            `}).join('');
             lucide.createIcons();
        }

        // --- LÓGICA DE PREVISÃO (ÁGUA E GÁS) ---
        
        /**
         * Calcula a previsão de consumo para Água ou Gás.
         * @param {string} tipo - 'agua' ou 'gas'.
         */
        function handleCalcularPrevisao(tipo) {
            const [movimentacoes, select, resultadoEl, labelEl, mediaEl, semanalEl, mensalEl, erroEl] = 
                tipo === 'agua' 
                ? [fb_agua_movimentacoes, selectPrevisaoUnidadeAgua, resultadoPrevisaoAgua, previsaoAguaLabel, previsaoAguaMedia, previsaoAguaSemanal, previsaoAguaMensal, previsaoAguaErro]
                : [fb_gas_movimentacoes, selectPrevisaoUnidadeGas, resultadoPrevisaoGas, previsaoGasLabel, previsaoGasMedia, previsaoGasSemanal, previsaoGasMensal, previsaoGasErro];
            
            if (!movimentacoes || !select || !resultadoEl) return;
            
            const unidadeId = select.value;
            const unidadeNome = select.options[select.selectedIndex].text;
            labelEl.textContent = unidadeNome;
            
            // Filtra apenas movimentações de 'entrega' com data válida
            let movsFiltradas = movimentacoes.filter(m => m.tipo === 'entrega' && m.data);
            if (unidadeId !== 'todas') {
                movsFiltradas = movsFiltradas.filter(m => m.unidadeId === unidadeId);
            }

            erroEl.textContent = '';
            resultadoEl.style.display = 'block';

            if (movsFiltradas.length < 2) { 
                // Precisa de pelo menos 2 pontos de dados para calcular um intervalo
                erroEl.textContent = 'Dados insuficientes para calcular (necessário no mínimo 2 entregas).';
                mediaEl.innerHTML = 'Consumo Médio Diário: <strong>N/A</strong>';
                semanalEl.innerHTML = 'Previsão Semanal (7 dias): <strong>N/A</strong>';
                mensalEl.innerHTML = 'Previsão Mensal (30 dias): <strong>N/A</strong>';
                return;
            }

            // Ordena pela data
            movsFiltradas.sort((a, b) => a.data.toMillis() - b.data.toMillis());

            const primeiraData = movsFiltradas[0].data.toDate();
            const ultimaData = movsFiltradas[movsFiltradas.length - 1].data.toDate();
            
            // Calcula o número de dias entre a primeira e a última entrega
            const diffTime = Math.abs(ultimaData.getTime() - primeiraData.getTime());
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 para incluir o dia inicial

            const totalQuantidade = movsFiltradas.reduce((sum, m) => sum + m.quantidade, 0);

            if (diffDays <= 0) {
                 erroEl.textContent = 'Não foi possível calcular o intervalo de dias (entregas no mesmo dia).';
                 return;
            }

            const mediaDiaria = totalQuantidade / diffDays;
            const previsaoSemanal = Math.ceil(mediaDiaria * 7);
            const previsaoMensal = Math.ceil(mediaDiaria * 30);

            mediaEl.innerHTML = `Consumo Médio Diário: <strong>${mediaDiaria.toFixed(2)}</strong>`;
            semanalEl.innerHTML = `Previsão Semanal (7 dias): <strong>${previsaoSemanal}</strong>`;
            mensalEl.innerHTML = `Previsão Mensal (30 dias): <strong>${previsaoMensal}</strong>`;
        }

        // --- LÓGICA DE CONTROLE DE MATERIAIS ---
        
        /**
         * Manipula o submit do formulário de registro de SEPARAÇÃO de materiais.
         */
        async function handleMateriaisSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) { showAlert('alert-materiais', 'Erro: Não autenticado.', 'error'); return; }
            
            const selectValue = selectUnidadeMateriais.value; 
            if (!selectValue) { showAlert('alert-materiais', 'Selecione uma unidade.', 'warning'); return; }
            
            const [unidadeId, unidadeNome, tipoUnidade] = selectValue.split('|');
            const tipoMaterial = selectTipoMateriais.value;
            const dataSeparacao = dateToTimestamp(inputDataSeparacao.value);
            const itens = textareaItensMateriais.value.trim(); 
            const responsavelSeparacao = capitalizeString(inputResponsavelMateriais.value.trim()); 

             if (!unidadeId || !tipoMaterial || !dataSeparacao || !responsavelSeparacao) {
                showAlert('alert-materiais', 'Dados inválidos. Verifique unidade, tipo, data e Responsável (Separação).', 'warning'); return;
            }

            btnSubmitMateriais.disabled = true; btnSubmitMateriais.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            
            try {
                // Adiciona o documento na coleção de materiais
                await addDoc(materiaisCollection, { 
                    unidadeId, 
                    unidadeNome, 
                    tipoUnidade, 
                    tipoMaterial, 
                    dataSeparacao, 
                    itens, 
                    status: 'separacao', // Status inicial
                    dataEntrega: null, 
                    responsavelSeparacao, 
                    responsavelEntrega: null, 
                    registradoEm: serverTimestamp() 
                });
                showAlert('alert-materiais', 'Separação registrada!', 'success');
                formMateriais.reset(); 
                inputDataSeparacao.value = getTodayDateString();
            } catch (error) { 
                console.error("Erro salvar separação:", error); 
                showAlert('alert-materiais', `Erro: ${error.message}`, 'error');
            } finally { 
                btnSubmitMateriais.disabled = false; 
                btnSubmitMateriais.textContent = 'Registrar Separação'; 
            }
        }

        /**
         * Renderiza a tabela de status de materiais (em separação e entregues).
         */
        function renderMateriaisStatus() {
             if (!tableStatusMateriais) return;
            
            // Ordena por status (separação primeiro) e depois por data (mais recente primeiro)
            const materiaisOrdenados = [...fb_materiais].sort((a,b) => { 
                const statusOrder = { 'separacao': 1, 'entregue': 2 }; 
                const statusCompare = (statusOrder[a.status] || 9) - (statusOrder[b.status] || 9);
                if (statusCompare !== 0) return statusCompare;
                const dateA = a.dataSeparacao?.toMillis() || 0; 
                const dateB = b.dataSeparacao?.toMillis() || 0; 
                return dateB - dateA;
            });

            if (materiaisOrdenados.length === 0) { 
                tableStatusMateriais.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-500">Nenhuma separação registrada.</td></tr>'; 
                return; 
            }
            
            tableStatusMateriais.innerHTML = materiaisOrdenados.map(m => {
                const isPendente = m.status === 'separacao';
                const statusClass = isPendente ? 'badge-yellow' : 'badge-green';
                const statusText = isPendente ? 'Em Separação' : 'Entregue';
                const dataEntregaText = m.dataEntrega ? ` (${formatTimestamp(m.dataEntrega)})` : '';
                const tooltipText = `Separado por: ${m.responsavelSeparacao || 'N/A'}${m.responsavelEntrega ? ' | Entregue por: '+m.responsavelEntrega : ''}`;

                // Cria uma linha para o item principal e uma linha opcional para os "itens"
                return `
                    <tr class="align-top ${isPendente ? '' : 'opacity-70'}" title="${tooltipText}">
                        <td class="font-medium">${m.unidadeNome || 'Unidade Desc.'}</td>
                        <td class="capitalize">${m.tipoMaterial || 'N/D'}</td>
                        <td>${formatTimestamp(m.dataSeparacao)}</td>
                        <td><span class="badge ${statusClass}">${statusText}${dataEntregaText}</span></td>
                        <td class="text-right space-x-1">
                            ${isPendente ? `<button class="btn-success btn-entregue text-xs py-1 px-2" data-id="${m.id}">Entregue</button>` : ''}
                            <button class="btn-danger btn-remove" data-id="${m.id}" data-type="materiais" title="Remover este registro"><i data-lucide="trash-2"></i></button>
                        </td>
                    </tr>
                    ${m.itens ? `
                    <tr class="${isPendente ? 'bg-slate-50' : 'bg-gray-50'} border-b-2 border-slate-200 ${isPendente ? '' : 'opacity-70'}">
                        <td colspan="5" class="py-2 px-6 text-sm text-slate-600 whitespace-pre-wrap"><strong>Itens:</strong> ${m.itens}</td>
                    </tr>
                    ` : ''}
                `;
            }).join('');
            lucide.createIcons();
        }

        /**
         * Manipula o clique no botão "Entregue" da tabela de materiais.
         */
        async function handleMarcarEntregue(e) {
            const button = e.target.closest('button.btn-entregue[data-id]');
            if (!button) return;
            
            const materialId = button.dataset.id;
            if (!isAuthReady || !materialId) return;

            // Pede o nome do responsável pela entrega
            const responsavelEntrega = prompt("Nome do responsável pela entrega:");
            if (!responsavelEntrega) {
                 showAlert('alert-materiais-lista', 'Nome do responsável é obrigatório para marcar como entregue.', 'warning');
                 return; 
            }

            button.disabled = true; button.innerHTML = '<div class="loading-spinner-small mx-auto" style="width: 16px; height: 16px; border-width: 2px;"></div>';
            
            try {
                // Atualiza o documento no Firebase
                const docRef = doc(materiaisCollection, materialId);
                await updateDoc(docRef, { 
                    status: 'entregue', 
                    dataEntrega: serverTimestamp(), 
                    responsavelEntrega: capitalizeString(responsavelEntrega) 
                });
                showAlert('alert-materiais-lista', 'Material marcado como entregue!', 'success', 3000);
            } catch (error) { 
                console.error("Erro marcar entregue:", error); 
                showAlert('alert-materiais-lista', `Erro: ${error.message}`, 'error'); 
                button.disabled = false; 
                button.textContent = 'Entregue'; 
            } 
        }
        
        // --- LÓGICA DE GESTÃO DE UNIDADES ---
        
        /**
         * Renderiza a tabela de gestão de unidades com os toggles de serviço.
         */
        function renderGestaoUnidades() {
            if (!tableGestaoUnidades) return;
            if (fb_unidades.length === 0) { 
                tableGestaoUnidades.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-500">Nenhuma unidade cadastrada. Adicione abaixo.</td></tr>'; 
                return; 
            }
            
            tableGestaoUnidades.innerHTML = fb_unidades.map(unidade => `
                <tr>
                    <td class="font-medium">${unidade.nome}</td><td>${unidade.tipo || 'N/A'}</td>
                    <!-- Os toggles refletem o estado no Firebase, com fallback para 'true' se indefinido -->
                    <td class="text-center"><input type="checkbox" class="form-toggle gestao-toggle" data-id="${unidade.id}" data-field="atendeAgua" ${(unidade.atendeAgua ?? true) ? 'checked' : ''}></td>
                    <td class="text-center"><input type="checkbox" class="form-toggle gestao-toggle" data-id="${unidade.id}" data-field="atendeGas" ${(unidade.atendeGas ?? true) ? 'checked' : ''}></td>
                    <td class="text-center"><input type="checkbox" class="form-toggle gestao-toggle" data-id="${unidade.id}" data-field="atendeMateriais" ${(unidade.atendeMateriais ?? true) ? 'checked' : ''}></td>
                </tr>`).join('');
        }

        /**
         * Manipula a mudança de um toggle na tabela de gestão (salva automaticamente).
         */
        async function handleGestaoToggle(e) {
            if (!e.target.classList.contains('gestao-toggle')) return;
            
            const checkbox = e.target; 
            const id = checkbox.dataset.id; 
            const field = checkbox.dataset.field; 
            const value = checkbox.checked;
            
            if (!isAuthReady || !id || !field) return; 
            
            checkbox.disabled = true; // Desabilita enquanto salva
            
            try {
                // Atualiza o campo específico (ex: 'atendeAgua') no documento da unidade
                const docRef = doc(unidadesCollection, id); 
                await updateDoc(docRef, { [field]: value });
                
                // Atualiza o dado localmente para evitar atraso da UI
                const localUnidade = fb_unidades.find(u => u.id === id); 
                if (localUnidade) localUnidade[field] = value;
                
                showAlert('alert-gestao', 'Status atualizado!', 'success', 2000);
            } catch (error) { 
                console.error("Erro atualizar unidade:", error); 
                showAlert('alert-gestao', `Erro: ${error.message}`, 'error'); 
                checkbox.checked = !value; // Reverte a mudança em caso de erro
            } finally { 
                checkbox.disabled = false; 
            }
        }

        /**
         * Adiciona múltiplas unidades em lote a partir do textarea.
         */
        async function handleBulkAddUnidades() {
             if (!isAuthReady || !textareaBulkUnidades) return;
             
             const text = textareaBulkUnidades.value.trim();
             if (!text) { showAlert('alert-gestao', 'A área de texto está vazia.', 'warning'); return; }

             const lines = text.split('\n');
             const unidadesParaAdd = [];
             const erros = [];

             lines.forEach((line, index) => {
                 const parts = line.split('\t'); // Assume separador TAB
                 if (parts.length === 2) {
                     const tipo = parts[0].trim().toUpperCase(); 
                     const nome = capitalizeString(parts[1].trim()); 
                     if (tipo && nome) {
                         // Verifica se a unidade (nome e tipo) já existe
                         const existe = fb_unidades.some(u => normalizeString(u.nome) === normalizeString(nome) && normalizeString(u.tipo) === normalizeString(tipo));
                         if (!existe) {
                             // Adiciona à lista para adicionar (com serviços habilitados por padrão)
                             unidadesParaAdd.push({ nome, tipo, atendeAgua: true, atendeGas: true, atendeMateriais: true });
                         } else {
                             console.log(`Unidade já existe (ignorada): ${tipo} - ${nome}`);
                         }
                     } else { erros.push(`Linha ${index + 1}: Tipo ou Nome vazio.`); }
                 } else if (line.trim()) { 
                     erros.push(`Linha ${index + 1}: Formato inválido (use TIPO [TAB] NOME).`);
                 }
             });

             if (unidadesParaAdd.length === 0) {
                 showAlert('alert-gestao', 'Nenhuma unidade nova para adicionar (ou todas já existem/formato inválido).', 'info');
                 if(erros.length > 0) console.warn("Erros na importação:", erros);
                 return;
             }

             btnBulkAddUnidades.disabled = true; btnBulkAddUnidades.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
             let adicionadasCount = 0;
             
             try {
                 // Adiciona cada nova unidade
                 for (const unidade of unidadesParaAdd) {
                     await addDoc(unidadesCollection, unidade);
                     adicionadasCount++;
                 }
                 showAlert('alert-gestao', `${adicionadasCount} unidade(s) adicionada(s) com sucesso!`, 'success');
                 textareaBulkUnidades.value = ''; 
                 
                 if(erros.length > 0) {
                      showAlert('alert-gestao', `Algumas linhas foram ignoradas por erros de formato ou por já existirem. Verifique o console (F12) para detalhes.`, 'warning', 8000);
                      console.warn("Erros/Avisos na importação:", erros);
                 }
             } catch (error) {
                 console.error("Erro ao adicionar unidades em lote:", error);
                 showAlert('alert-gestao', `Erro ao adicionar unidades: ${error.message}. ${adicionadasCount} foram adicionadas antes do erro.`, 'error');
             } finally {
                 btnBulkAddUnidades.disabled = false; btnBulkAddUnidades.textContent = 'Adicionar Unidades';
             }
        }

        // --- LÓGICA DO DASHBOARD ---
        
        /**
         * Alterna a visualização interna do dashboard (Geral, Água, Gás, Materiais).
         */
        function switchDashboardView(viewName) {
            // Atualiza botões
            document.querySelectorAll('#dashboard-nav-controls .dashboard-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });
            // Mostra/Esconde painéis
            document.querySelectorAll('.dashboard-tv-view > div[id^="dashboard-view-"]').forEach(pane => {
                 pane.classList.toggle('hidden', pane.id !== `dashboard-view-${viewName}`);
            });
            
            // Renderiza o conteúdo específico da aba selecionada
            if(viewName === 'agua') renderDashboardAguaChart();
            if(viewName === 'gas') renderDashboardGasChart();
            if(viewName === 'geral') renderDashboardMateriaisProntos();
            if(viewName === 'materiais') renderDashboardMateriaisList();
        }

        /**
         * Filtra um array de movimentações para incluir apenas os últimos 30 dias.
         */
        function filterLast30Days(movimentacoes) {
            const today = new Date(); 
            today.setHours(23, 59, 59, 999); 
            const thirtyDaysAgo = new Date(today); 
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            thirtyDaysAgo.setHours(0, 0, 0, 0); 
            
            const thirtyDaysAgoTimestamp = thirtyDaysAgo.getTime();
            const todayTimestamp = today.getTime();

            return movimentacoes.filter(m => {
                if (!m.data || typeof m.data.toDate !== 'function') return false;
                const mTimestamp = m.data.toMillis();
                return mTimestamp >= thirtyDaysAgoTimestamp && mTimestamp <= todayTimestamp;
            });
        }

        /**
         * Prepara os dados (labels e datasets) para os gráficos dos últimos 30 dias.
         */
        function getChartDataLast30Days(movimentacoes) {
            const labels = []; const entregasData = []; const retornosData = []; 
            const dataMap = new Map(); 
            const today = new Date(); today.setHours(0, 0, 0, 0);
            
            // Cria os labels e o mapa para os últimos 30 dias
            for (let i = 29; i >= 0; i--) { 
                const d = new Date(today); 
                d.setDate(d.getDate() - i); 
                const dateKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; 
                const dateLabel = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); 
                labels.push(dateLabel); 
                dataMap.set(dateKey, { entregas: 0, retornos: 0 }); 
            }
            
            const movs30Dias = filterLast30Days(movimentacoes);

            // Preenche o mapa com os dados das movimentações
            movs30Dias.forEach(m => { 
                const mDate = m.data.toDate(); 
                mDate.setHours(0,0,0,0); 
                const dateKey = `${mDate.getFullYear()}-${String(mDate.getMonth() + 1).padStart(2, '0')}-${String(mDate.getDate()).padStart(2, '0')}`; 
                if (dataMap.has(dateKey)) { 
                    const dayData = dataMap.get(dateKey); 
                    if (m.tipo === 'entrega') dayData.entregas += m.quantidade; 
                    else if (m.tipo === 'retorno') dayData.retornos += m.quantidade; 
                } 
            });
            
            // Converte o mapa em arrays para o gráfico
            dataMap.forEach(value => { 
                entregasData.push(value.entregas); 
                retornosData.push(value.retornos); 
            });
            
            return { 
                labels, 
                datasets: [ 
                    { label: 'Entregues', data: entregasData, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, tension: 0.1 }, 
                    { label: 'Recebidos', data: retornosData, backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1, tension: 0.1 } 
                ] 
            };
        }

        /**
         * Renderiza (ou atualiza) o gráfico de Água.
         */
        function renderDashboardAguaChart() {
            const ctx = document.getElementById('dashboardAguaChart')?.getContext('2d'); if (!ctx) return; 
            const data = getChartDataLast30Days(fb_agua_movimentacoes); 
            if (dashboardAguaChartInstance) { 
                dashboardAguaChartInstance.data = data; 
                dashboardAguaChartInstance.update(); 
            } else { 
                dashboardAguaChartInstance = new Chart(ctx, { type: 'line', data: data, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { position: 'top' } } } }); 
            }
        }
        
        /**
         * Renderiza (ou atualiza) o gráfico de Gás.
         */
        function renderDashboardGasChart() {
            const ctx = document.getElementById('dashboardGasChart')?.getContext('2d'); if (!ctx) return; 
            const data = getChartDataLast30Days(fb_gas_movimentacoes); 
            if (dashboardGasChartInstance) { 
                dashboardGasChartInstance.data = data; 
                dashboardGasChartInstance.update(); 
            } else { 
                dashboardGasChartInstance = new Chart(ctx, { type: 'line', data: data, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { position: 'top' } } } }); 
            }
        }
        
        /**
         * Renderiza os cards de resumo (KPIs) de Água.
         */
        function renderDashboardAguaSummary() {
            if (!summaryAguaPendente) return; 
            
            // Saldo total (histórico)
            const totalEntregueGeral = fb_agua_movimentacoes.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const totalRecebidoGeral = fb_agua_movimentacoes.filter(m => m.tipo === 'retorno').reduce((sum, m) => sum + m.quantidade, 0);
            summaryAguaPendente.textContent = totalEntregueGeral - totalRecebidoGeral;

            // Últimos 30 dias
            const movs30Dias = filterLast30Days(fb_agua_movimentacoes);
            const totalEntregue30d = movs30Dias.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const totalRecebido30d = movs30Dias.filter(m => m.tipo === 'retorno').reduce((sum, m) => sum + m.quantidade, 0);
            
            summaryAguaEntregue.textContent = totalEntregue30d;
            summaryAguaRecebido.textContent = totalRecebido30d;
        }

        /**
         * Renderiza os cards de resumo (KPIs) de Gás.
         */
        function renderDashboardGasSummary() {
             if (!summaryGasPendente) return;
            
            // Saldo total (histórico)
            const totalEntregueGeral = fb_gas_movimentacoes.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const totalRecebidoGeral = fb_gas_movimentacoes.filter(m => m.tipo === 'retorno').reduce((sum, m) => sum + m.quantidade, 0);
            summaryGasPendente.textContent = totalEntregueGeral - totalRecebidoGeral;

            // Últimos 30 dias
            const movs30Dias = filterLast30Days(fb_gas_movimentacoes);
            const totalEntregue30d = movs30Dias.filter(m => m.tipo === 'entrega').reduce((sum, m) => sum + m.quantidade, 0);
            const totalRecebido30d = movs30Dias.filter(m => m.tipo === 'retorno').reduce((sum, m) => sum + m.quantidade, 0);
            
            summaryGasEntregue.textContent = totalEntregue30d;
            summaryGasRecebido.textContent = totalRecebido30d;
        }

        /**
         * Renderiza a lista de materiais 'Em Separação' (Visão Materiais).
         */
        function renderDashboardMateriaisList() {
             if (!dashboardMateriaisListContainer || !loadingMateriaisDashboard) return; 
             loadingMateriaisDashboard.style.display = 'none'; 
            
            const pendentes = fb_materiais.filter(m => m.status === 'separacao').sort((a,b) => (a.dataSeparacao?.toMillis() || 0) - (b.dataSeparacao?.toMillis() || 0)); 
            
            if (pendentes.length === 0) { 
                dashboardMateriaisListContainer.innerHTML = '<p class="text-sm text-slate-500 text-center py-4">Nenhum material em separação.</p>'; 
                return; 
            }
            dashboardMateriaisListContainer.innerHTML = pendentes.map(m => ` 
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200"> 
                    <div class="flex justify-between items-center gap-2"> 
                        <span class="font-medium text-slate-700 text-sm truncate" title="${m.unidadeNome || ''}">${m.unidadeNome || 'Unidade Desc.'}</span> 
                        <span class="badge badge-yellow flex-shrink-0">${formatTimestamp(m.dataSeparacao)}</span> 
                    </div> 
                    <p class="text-xs text-slate-600 capitalize mt-1">${m.tipoMaterial || 'N/D'}</p> 
                    ${m.itens ? `<p class="text-xs text-gray-500 mt-1 truncate" title="${m.itens}">Itens: ${m.itens}</p>` : ''} 
                </div> `
            ).join('');
        }
        
        /**
         * Renderiza a 'Visão Geral' (TV) com materiais prontos agrupados por Tipo de Unidade.
         */
        function renderDashboardMateriaisProntos() {
            if (!dashboardMateriaisProntosContainer || !loadingMateriaisProntos) return;
            loadingMateriaisProntos.style.display = 'none';

            const pendentes = fb_materiais.filter(m => m.status === 'separacao');
            if (pendentes.length === 0) {
                dashboardMateriaisProntosContainer.innerHTML = '<p class="text-sm text-slate-500 text-center py-4 col-span-full">Nenhum material em separação.</p>';
                return;
            }

            // Agrupa por Tipo de Unidade (CRAS, CREAS, etc.)
            const gruposTipoUnidade = pendentes.reduce((acc, m) => {
                const tipoUnidade = m.tipoUnidade || 'OUTROS';
                if (!acc[tipoUnidade]) acc[tipoUnidade] = {};
                
                // Agrupa por Nome da Unidade
                const unidadeNome = m.unidadeNome || 'Desconhecida';
                if (!acc[tipoUnidade][unidadeNome]) {
                    acc[tipoUnidade][unidadeNome] = new Set(); // Usa Set para evitar tipos duplicados
                }
                acc[tipoUnidade][unidadeNome].add(m.tipoMaterial || 'N/D'); // Adiciona o tipo de material
                
                return acc;
            }, {});

            // Define a ordem das colunas
            const ordemColunas = ['CT', 'SEDE', 'CRAS', 'CREAS', 'ABRIGO'];
            Object.keys(gruposTipoUnidade).forEach(tipo => {
                if (!ordemColunas.includes(tipo)) ordemColunas.push(tipo); // Adiciona tipos não previstos
            });

            let html = '';
            let colunasRenderizadas = 0;
            
            // Cria as colunas
            ordemColunas.forEach(tipoUnidade => {
                if (gruposTipoUnidade[tipoUnidade]) {
                    colunasRenderizadas++;
                    html += `<div class="materiais-prontos-col card bg-slate-50/50"><h4>${tipoUnidade}</h4><ul class="space-y-3">`;
                    
                    const unidadesOrdenadas = Object.keys(gruposTipoUnidade[tipoUnidade]).sort();

                    // Lista as unidades dentro da coluna
                    unidadesOrdenadas.forEach(unidadeNome => {
                        const tiposMateriais = Array.from(gruposTipoUnidade[tipoUnidade][unidadeNome]).join(', ');
                        html += `
                            <li>
                                <strong>${unidadeNome}</strong><br>
                                <span class="capitalize">(${tiposMateriais})</span>
                            </li>`;
                    });
                    
                    html += `</ul></div>`;
                }
            });

            if (colunasRenderizadas === 0) {
                 dashboardMateriaisProntosContainer.innerHTML = '<p class="text-sm text-slate-500 text-center py-4 col-span-full">Nenhum material em separação.</p>';
            } else {
                dashboardMateriaisProntosContainer.innerHTML = html;
            }
        }
        
        /**
         * Inicia o intervalo de auto-refresh do dashboard (a cada 2 minutos).
         */
        function startDashboardRefresh() {
            stopDashboardRefresh(); // Garante que não haja intervalos duplicados
            console.log("Iniciando auto-refresh do Dashboard (2 min)");
            dashboardRefreshInterval = setInterval(() => {
                if (visaoAtiva !== 'dashboard') { 
                    stopDashboardRefresh(); // Para se o usuário sair do dashboard
                    return;
                }
                console.log("Atualizando dados do Dashboard (auto-refresh)...");
                renderDashboardAguaChart();
                renderDashboardGasChart();
                renderDashboardAguaSummary();
                renderDashboardGasSummary();
                renderDashboardMateriaisList();
                renderDashboardMateriaisProntos();
                updateLastUpdateTime(); 
            }, 120000); // 120000 ms = 2 minutos
        }

        /**
         * Para o intervalo de auto-refresh.
         */
        function stopDashboardRefresh() {
            if (dashboardRefreshInterval) {
                console.log("Parando auto-refresh do Dashboard");
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }
        }

        // --- LÓGICA DE RELATÓRIO PDF ---
        
        /**
         * Gera e baixa um relatório em PDF usando jsPDF e jsPDF-AutoTable.
         */
        function handleGerarPdf() {
            // Verifica se as bibliotecas jsPDF estão carregadas
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof window.jspdf.AutoTable === 'undefined') {
                showAlert('alert-relatorio', 'Erro: Bibliotecas PDF não carregadas. Tente recarregar a página.', 'error');
                console.error("jsPDF ou jsPDF.AutoTable não encontrados no window.jspdf:", window.jspdf);
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const autoTable = window.jspdf.AutoTable;

            const tipo = relatorioTipo.value;
            const dataInicioStr = relatorioDataInicio.value;
            const dataFimStr = relatorioDataFim.value;

            if (!dataInicioStr || !dataFimStr) {
                showAlert('alert-relatorio', 'Selecione a data de início e fim.', 'warning');
                return;
            }

            // Converte datas para milissegundos
            const dataInicio = dateToTimestamp(dataInicioStr).toMillis();
            const dataFim = dateToTimestamp(dataFimStr).toMillis() + (24 * 60 * 60 * 1000 - 1); // Inclui o dia final inteiro

            const movimentacoes = (tipo === 'agua' ? fb_agua_movimentacoes : fb_gas_movimentacoes);
            const tipoLabel = (tipo === 'agua' ? 'Água' : 'Gás');
            
            // Filtra movimentações de 'entrega' dentro do período
            const movsFiltradas = movimentacoes.filter(m => {
                const mData = m.data?.toMillis();
                return m.tipo === 'entrega' && mData >= dataInicio && mData <= dataFim;
            });

            if (movsFiltradas.length === 0) {
                showAlert('alert-relatorio', 'Nenhum dado de entrega encontrado para este período.', 'info');
                return;
            }

            btnGerarPdf.disabled = true; btnGerarPdf.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            
            try {
                const doc = new jsPDF();
                
                // Agrupa dados por Unidade
                const abastecimentoMap = new Map();
                movsFiltradas.forEach(m => {
                    const nome = m.unidadeNome || 'Desconhecida';
                    const atual = abastecimentoMap.get(nome) || 0;
                    abastecimentoMap.set(nome, atual + m.quantidade);
                });
                const abastecimentoData = Array.from(abastecimentoMap.entries())
                                              .sort((a,b) => b[1] - a[1]) // Ordena por quantidade (maior primeiro)
                                              .map(entry => [entry[0], entry[1]]);
                
                // Agrupa dados por Responsável
                const responsavelMap = new Map();
                movsFiltradas.forEach(m => {
                    const nome = m.responsavel || 'Não identificado';
                    const atual = responsavelMap.get(nome) || 0;
                    responsavelMap.set(nome, atual + m.quantidade);
                });
                const responsavelData = Array.from(responsavelMap.entries())
                                            .sort((a,b) => b[1] - a[1]) // Ordena por quantidade (maior primeiro)
                                            .map(entry => [entry[0], entry[1]]);

                // Cabeçalho do PDF
                doc.setFontSize(16);
                doc.text(`Relatório de Fornecimento - ${tipoLabel}`, 14, 20);
                doc.setFontSize(10);
                doc.text(`Período: ${formatTimestamp(Timestamp.fromMillis(dataInicio))} a ${formatTimestamp(Timestamp.fromMillis(dataFim))}`, 14, 26);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 32);

                // Tabela por Unidade
                autoTable(doc, {
                    startY: 40,
                    head: [['Relatório de Entregas por Unidade']],
                    body: [[]],
                    theme: 'plain',
                    styles: { fontSize: 12, fontStyle: 'bold' }
                });
                autoTable(doc, {
                    head: [['Unidade', 'Quantidade Fornecida']],
                    body: abastecimentoData,
                    theme: 'striped',
                    headStyles: { fillColor: [22, 160, 133] } // Verde
                });
                
                // Tabela por Responsável
                autoTable(doc, {
                    startY: doc.lastAutoTable.finalY + 15,
                    head: [['Relatório de Recebimento por Responsável']],
                    body: [[]],
                    theme: 'plain',
                    styles: { fontSize: 12, fontStyle: 'bold' }
                });
                autoTable(doc, {
                    head: [['Responsável', 'Quantidade Recebida']],
                    body: responsavelData,
                    theme: 'striped',
                    headStyles: { fillColor: [41, 128, 185] } // Azul
                });

                // Salva o arquivo
                doc.save(`Relatorio_${tipoLabel}_${dataInicioStr}_a_${dataFimStr}.pdf`);
                showAlert('alert-relatorio', 'Relatório PDF gerado com sucesso!', 'success');

            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                showAlert('alert-relatorio', `Erro ao gerar PDF: ${error.message}`, 'error');
            } finally {
                btnGerarPdf.disabled = false; btnGerarPdf.textContent = 'Gerar Relatório PDF';
            }
        }
        
        // --- LÓGICA DE EXCLUSÃO ---
        
        /**
         * Abre o modal de confirmação de exclusão.
         * @param {string} id - ID do documento a ser excluído.
         * @param {string} type - Tipo do documento (ex: 'agua', 'gas', 'entrada-agua').
         */
        function openConfirmDeleteModal(id, type) {
            if (!id || !type) return;
            
            let collectionRef = null;
            let detailsText = `ID: ${id.substring(0,6)}...`;
            let alertElementId = 'alert-gestao'; // Padrão
            
            // Define qual coleção e qual alerta usar com base no tipo
            if (type === 'agua') { 
                collectionRef = aguaCollection; 
                detailsText = `Saída de Água ${detailsText}`; 
                alertElementId = 'alert-agua-lista';
            } else if (type === 'gas') { 
                collectionRef = gasCollection; 
                detailsText = `Saída de Gás ${detailsText}`; 
                alertElementId = 'alert-gas-lista';
            } else if (type === 'materiais') { 
                collectionRef = materiaisCollection; 
                detailsText = `Registro de Material ${detailsText}`; 
                alertElementId = 'alert-materiais-lista';
            } else if (type === 'entrada-agua') { 
                collectionRef = estoqueAguaCollection; 
                detailsText = `Entrada de Estoque (Água) ${detailsText}`; 
                alertElementId = 'alert-historico-agua'; // Usa o alerta do histórico
            } else if (type === 'entrada-gas') { 
                collectionRef = estoqueGasCollection; 
                detailsText = `Entrada de Estoque (Gás) ${detailsText}`; 
                alertElementId = 'alert-historico-gas'; // Usa o alerta do histórico
            } else { 
                console.error("Tipo inválido para exclusão:", type); return; 
            }

            // Armazena as informações para a exclusão
            deleteInfo = { id, type, collectionRef, alertElementId };
            deleteDetailsEl.textContent = `Detalhes: ${detailsText}`;
            confirmDeleteModal.style.display = 'block';
        }
        
        /**
         * Executa a exclusão após confirmação no modal.
         */
        async function executeDelete() {
            if (!isAuthReady || !deleteInfo.id || !deleteInfo.collectionRef) {
                 showAlert(deleteInfo.alertElementId || 'alert-gestao', 'Erro: Não autenticado ou informação de exclusão inválida.', 'error');
                 return;
            }

            btnConfirmDelete.disabled = true; btnConfirmDelete.innerHTML = '<div class="loading-spinner-small mx-auto" style="width:18px; height:18px;"></div>';
            btnCancelDelete.disabled = true;

            try {
                // Não é permitido excluir 'entrada-inicial' por este modal simples,
                // pois isso quebraria a lógica de estoque. 
                // Apenas entradas normais e saídas podem ser removidas.
                if (deleteInfo.type === 'entrada-agua' || deleteInfo.type === 'entrada-gas') {
                    const docSnap = await getDoc(doc(deleteInfo.collectionRef, deleteInfo.id));
                    if (docSnap.exists() && docSnap.data().tipo === 'inicial') {
                        showAlert(deleteInfo.alertElementId, 'Não é possível remover o lançamento de Estoque Inicial por aqui.', 'error');
                        throw new Error("Tentativa de exclusão de estoque inicial.");
                    }
                }
                
                // Exclui o documento
                const docRef = doc(deleteInfo.collectionRef, deleteInfo.id);
                await deleteDoc(docRef);
                showAlert(deleteInfo.alertElementId || 'alert-gestao', 'Lançamento removido com sucesso!', 'success');
            } catch (error) {
                console.error(`Erro ao remover ${deleteInfo.type}:`, error);
                if (error.message !== "Tentativa de exclusão de estoque inicial.") {
                    showAlert(deleteInfo.alertElementId || 'alert-gestao', `Erro ao remover: ${error.message}`, 'error');
                }
            } finally {
                // Limpa e fecha o modal
                confirmDeleteModal.style.display = 'none';
                btnConfirmDelete.disabled = false; btnConfirmDelete.textContent = 'Confirmar Exclusão';
                btnCancelDelete.disabled = false;
                deleteInfo = { id: null, type: null, collectionRef: null, alertElementId: null };
            }
        }

        // --- LÓGICA DE CONTROLE DE ESTOQUE (ENTRADA) ---

        /**
         * Manipula o submit do formulário de ESTOQUE INICIAL (água ou gás).
         */
        async function handleInicialEstoqueSubmit(e) {
            e.preventDefault();
            const tipoEstoque = e.target.id.includes('agua') ? 'agua' : 'gas';
            
            const inputQtd = document.getElementById(`input-inicial-qtd-${tipoEstoque}`).value;
            const inputResp = document.getElementById(`input-inicial-responsavel-${tipoEstoque}`).value;
            const btnSubmit = document.getElementById(`btn-submit-inicial-${tipoEstoque}`);
            const alertElId = `alert-inicial-${tipoEstoque}`;
            
            const quantidade = parseInt(inputQtd, 10);
            const responsavel = capitalizeString(inputResp.trim());
            
            if (isNaN(quantidade) || quantidade < 0 || !responsavel) {
                showAlert(alertElId, "Preencha a quantidade e o responsável.", 'warning'); 
                return;
            }

            // Checa novamente se já não existe uma entrada inicial (evita duplicidade)
            const estoqueAtual = (tipoEstoque === 'agua') ? fb_estoque_agua : fb_estoque_gas;
            if (estoqueAtual.some(e => e.tipo === 'inicial')) {
                 showAlert(alertElId, "O estoque inicial já foi definido.", 'info'); 
                 document.getElementById(`form-inicial-${tipoEstoque}-container`).classList.add('hidden');
                 document.getElementById(`btn-abrir-inicial-${tipoEstoque}`).classList.add('hidden');
                 document.getElementById(`resumo-estoque-${tipoEstoque}`).classList.remove('hidden');
                 return;
            }

            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            
            const collectionRef = (tipoEstoque === 'agua') ? estoqueAguaCollection : estoqueGasCollection;
            
            try {
                // Adiciona um documento do tipo 'inicial'
                await addDoc(collectionRef, {
                    tipo: 'inicial', 
                    quantidade: quantidade,
                    data: serverTimestamp(), // Usa a data do servidor
                    responsavel: responsavel,
                    notaFiscal: 'INICIAL',
                    registradoEm: serverTimestamp()
                });
                
                showAlert(alertElId, "Estoque inicial salvo!", 'success', 2000);
                 // Esconde o form e o botão, onSnapshot fará o resto
                 document.getElementById(`form-inicial-${tipoEstoque}-container`).classList.add('hidden');
                 document.getElementById(`btn-abrir-inicial-${tipoEstoque}`).classList.add('hidden');

            } catch (error) {
                console.error("Erro ao salvar estoque inicial:", error);
                showAlert(alertElId, `Erro ao salvar: ${error.message}`, 'error');
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Salvar Inicial';
            }
        }

        /**
         * Alterna entre os formulários de Saída (Unidades) e Entrada (Estoque).
         */
        function switchEstoqueForm(formName) {
            if (formName === 'saida-agua') {
                document.querySelector('.form-tab-btn[data-form="saida-agua"]').classList.add('active');
                document.querySelector('.form-tab-btn[data-form="entrada-agua"]').classList.remove('active');
                formAgua.classList.remove('hidden');
                formEntradaAgua.classList.add('hidden');
            } else if (formName === 'entrada-agua') {
                document.querySelector('.form-tab-btn[data-form="saida-agua"]').classList.remove('active');
                document.querySelector('.form-tab-btn[data-form="entrada-agua"]').classList.add('active');
                formAgua.classList.add('hidden');
                formEntradaAgua.classList.remove('hidden');
            } else if (formName === 'saida-gas') {
                document.querySelector('.form-tab-btn[data-form="saida-gas"]').classList.add('active');
                document.querySelector('.form-tab-btn[data-form="entrada-gas"]').classList.remove('active');
                formGas.classList.remove('hidden');
                formEntradaGas.classList.add('hidden');
            } else if (formName === 'entrada-gas') {
                document.querySelector('.form-tab-btn[data-form="saida-gas"]').classList.remove('active');
                document.querySelector('.form-tab-btn[data-form="entrada-gas"]').classList.add('active');
                formGas.classList.add('hidden');
                formEntradaGas.classList.remove('hidden');
            }
        }

        /**
         * Manipula o submit do formulário de ENTRADA de estoque (água ou gás).
         */
        async function handleEntradaEstoqueSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) { showAlert('alert-agua', 'Erro: Não autenticado.', 'error'); return; }

            const tipoEstoque = e.target.id.includes('agua') ? 'agua' : 'gas';
            const alertElementId = `alert-${tipoEstoque}`; // Reutiliza o alerta principal da aba
            
            const inputQtd = document.getElementById(`input-qtd-entrada-${tipoEstoque}`).value;
            const inputData = document.getElementById(`input-data-entrada-${tipoEstoque}`).value;
            const inputResp = document.getElementById(`input-responsavel-entrada-${tipoEstoque}`).value;
            const inputNf = document.getElementById(`input-nf-entrada-${tipoEstoque}`).value;
            const btnSubmit = document.getElementById(`btn-submit-entrada-${tipoEstoque}`);
            const form = document.getElementById(`form-entrada-${tipoEstoque}`);
            
            const quantidade = parseInt(inputQtd, 10);
            const data = dateToTimestamp(inputData);
            const responsavel = capitalizeString(inputResp.trim());
            const notaFiscal = inputNf.trim() || 'N/A';

            if (!quantidade || quantidade <= 0 || !data || !responsavel) {
                showAlert(alertElementId, 'Dados inválidos. Verifique quantidade, data e responsável.', 'warning'); return;
            }

             // Validação de Estoque Inicial
            if (!estoqueInicialDefinido[tipoEstoque]) {
                 showAlert(alertElementId, `Defina o Estoque Inicial de ${tipoEstoque === 'agua' ? 'Água' : 'Gás'} antes de lançar entradas.`, 'warning'); return;
            }

            btnSubmit.disabled = true; btnSubmit.innerHTML = '<div class="loading-spinner-small mx-auto"></div>';
            
            const collectionRef = (tipoEstoque === 'agua') ? estoqueAguaCollection : estoqueGasCollection;
            
            try {
                // Adiciona um documento do tipo 'entrada'
                await addDoc(collectionRef, {
                    tipo: 'entrada',
                    quantidade: quantidade,
                    data: data,
                    responsavel: responsavel,
                    notaFiscal: notaFiscal,
                    registradoEm: serverTimestamp()
                });
                showAlert(alertElementId, 'Entrada no estoque salva!', 'success');
                form.reset();
                document.getElementById(`input-data-entrada-${tipoEstoque}`).value = getTodayDateString();
            } catch (error) {
                console.error("Erro salvar entrada estoque:", error);
                showAlert(alertElementId, `Erro: ${error.message}`, 'error');
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Salvar Entrada';
            }
        }

        /**
         * Renderiza o card de Resumo de Estoque de Água.
         */
        function renderEstoqueAgua() {
            if (!estoqueAguaAtualEl) return;
            
            if (loadingEstoqueAguaEl) loadingEstoqueAguaEl.style.display = 'none';

            // Controla visibilidade do botão/form inicial vs resumo
            if (estoqueInicialDefinido.agua) {
                btnAbrirInicialAgua.classList.add('hidden');
                formInicialAguaContainer.classList.add('hidden');
                resumoEstoqueAguaEl.classList.remove('hidden');
            } else {
                btnAbrirInicialAgua.classList.remove('hidden');
                resumoEstoqueAguaEl.classList.add('hidden');
                // Não esconde o form se ele já estiver aberto pelo usuário
            }
            
            // Calcula totais com base nos dados locais (atualizados pelos listeners)
            const estoqueInicial = fb_estoque_agua
                .filter(e => e.tipo === 'inicial')
                .reduce((sum, e) => sum + e.quantidade, 0);

            const totalEntradas = fb_estoque_agua
                .filter(e => e.tipo === 'entrada')
                .reduce((sum, e) => sum + e.quantidade, 0);

            const totalSaidas = fb_agua_movimentacoes // Pega das saídas (outra coleção)
                .filter(m => m.tipo === 'entrega')
                .reduce((sum, m) => sum + m.quantidade, 0);

            const estoqueAtual = estoqueInicial + totalEntradas - totalSaidas;

            // Atualiza a UI
            estoqueAguaInicialEl.textContent = estoqueInicial;
            estoqueAguaEntradasEl.textContent = `+${totalEntradas}`;
            estoqueAguaSaidasEl.textContent = `-${totalSaidas}`;
            estoqueAguaAtualEl.textContent = estoqueAtual;
        }

        /**
         * Renderiza o card de Resumo de Estoque de Gás.
         */
        function renderEstoqueGas() {
             if (!estoqueGasAtualEl) return;

            if (loadingEstoqueGasEl) loadingEstoqueGasEl.style.display = 'none';

             // Controla visibilidade
            if (estoqueInicialDefinido.gas) {
                btnAbrirInicialGas.classList.add('hidden');
                formInicialGasContainer.classList.add('hidden');
                resumoEstoqueGasEl.classList.remove('hidden');
            } else {
                btnAbrirInicialGas.classList.remove('hidden');
                resumoEstoqueGasEl.classList.add('hidden');
            }
            
            // Calcula totais
            const estoqueInicial = fb_estoque_gas
                .filter(e => e.tipo === 'inicial')
                .reduce((sum, e) => sum + e.quantidade, 0);

            const totalEntradas = fb_estoque_gas
                .filter(e => e.tipo === 'entrada')
                .reduce((sum, e) => sum + e.quantidade, 0);

            const totalSaidas = fb_gas_movimentacoes // Pega das saídas (outra coleção)
                .filter(m => m.tipo === 'entrega')
                .reduce((sum, m) => sum + m.quantidade, 0);

            const estoqueAtual = estoqueInicial + totalEntradas - totalSaidas;

            // Atualiza UI
            estoqueGasInicialEl.textContent = estoqueInicial;
            estoqueGasEntradasEl.textContent = `+${totalEntradas}`;
            estoqueGasSaidasEl.textContent = `-${totalSaidas}`;
            estoqueGasAtualEl.textContent = estoqueAtual;
        }

        // --- NOVO: Renderiza Histórico de Entradas ---
        
        /**
         * Renderiza a tabela com o histórico de entradas no estoque de Água.
         */
        function renderHistoricoAgua() {
            if (!tableHistoricoAgua) return;

            const historicoOrdenado = [...fb_estoque_agua].sort((a, b) => (b.data?.toMillis() || 0) - (a.data?.toMillis() || 0));

             if (historicoOrdenado.length === 0) { 
                tableHistoricoAgua.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Nenhuma entrada registrada.</td></tr>'; 
                return; 
             }
            
            tableHistoricoAgua.innerHTML = historicoOrdenado.map(e => {
                const tipoClass = e.tipo === 'inicial' ? 'badge-blue' : 'badge-green';
                const tipoText = e.tipo === 'inicial' ? 'Inicial' : 'Entrada';
                return `
                <tr>
                    <td>${formatTimestamp(e.data)}</td>
                    <td><span class="badge ${tipoClass}">${tipoText}</span></td>
                    <td class="text-center font-medium">${e.quantidade}</td>
                    <td>${e.responsavel || 'N/A'}</td>
                    <td>${e.notaFiscal || 'N/A'}</td>
                    <td class="text-center">
                        <button class="btn-danger btn-remove" data-id="${e.id}" data-type="entrada-agua" title="Remover esta entrada"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `}).join('');
            lucide.createIcons();
        }

        /**
         * Renderiza a tabela com o histórico de entradas no estoque de Gás.
         */
        function renderHistoricoGas() {
             if (!tableHistoricoGas) return;

            const historicoOrdenado = [...fb_estoque_gas].sort((a, b) => (b.data?.toMillis() || 0) - (a.data?.toMillis() || 0));

             if (historicoOrdenado.length === 0) { 
                tableHistoricoGas.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-500">Nenhuma entrada registrada.</td></tr>'; 
                return; 
             }
            
            tableHistoricoGas.innerHTML = historicoOrdenado.map(e => {
                const tipoClass = e.tipo === 'inicial' ? 'badge-blue' : 'badge-green';
                const tipoText = e.tipo === 'inicial' ? 'Inicial' : 'Entrada';
                return `
                <tr>
                    <td>${formatTimestamp(e.data)}</td>
                    <td><span class="badge ${tipoClass}">${tipoText}</span></td>
                    <td class="text-center font-medium">${e.quantidade}</td>
                    <td>${e.responsavel || 'N/A'}</td>
                    <td>${e.notaFiscal || 'N/A'}</td>
                    <td class="text-center">
                        <button class="btn-danger btn-remove" data-id="${e.id}" data-type="entrada-gas" title="Remover esta entrada"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `}).join('');
            lucide.createIcons();
        }


        // --- CONTROLE DE ABAS E INICIALIZAÇÃO ---
        
        /**
         * Alterna a aba principal da aplicação (Dashboard, Água, Gás, etc.).
         */
        function switchTab(tabName) {
            // Atualiza botões de navegação
            navButtons.forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.nav-btn[data-tab="${tabName}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Mostra/Esconde painéis de conteúdo
            contentPanes.forEach(pane => pane.classList.add('hidden'));
            const activePane = document.getElementById(`content-${tabName}`);
            if(activePane) activePane.classList.remove('hidden');
            
            visaoAtiva = tabName; // Armazena a visão ativa

            // Ações específicas ao trocar de aba
            if (tabName === 'dashboard') {
                switchDashboardView('geral'); // Vai para a sub-aba 'geral'
                startDashboardRefresh(); // Inicia o auto-refresh
            } else {
                stopDashboardRefresh(); // Para o auto-refresh se sair do dashboard
            }
            
            // Garante que os dados corretos sejam renderizados ao entrar nas abas
            if (tabName === 'gestao') { renderGestaoUnidades(); }
            if (tabName === 'agua') { switchEstoqueForm('saida-agua'); renderEstoqueAgua(); renderHistoricoAgua(); }
            if (tabName === 'gas') { switchEstoqueForm('saida-gas'); renderEstoqueGas(); renderHistoricoGas(); }

            // Recria os ícones do Lucide (necessário para conteúdo carregado dinamicamente)
            setTimeout(() => {
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }, 50); 
        }

        /**
         * Função principal de inicialização da aplicação (DOM Ready).
         */
        function initApp() {
            // Mapeia todos os elementos do DOM para variáveis
            navButtons = document.querySelectorAll('.nav-btn'); 
            contentPanes = document.querySelectorAll('main > div[id^="content-"]'); 
            connectionStatusEl = document.getElementById('connectionStatus'); 
            lastUpdateTimeEl = document.getElementById('last-update-time');
            
            // Dashboard
            dashboardNavControls = document.getElementById('dashboard-nav-controls');
            summaryAguaPendente = document.getElementById('summary-agua-pendente');
            summaryAguaEntregue = document.getElementById('summary-agua-entregue');
            summaryAguaRecebido = document.getElementById('summary-agua-recebido');
            summaryGasPendente = document.getElementById('summary-gas-pendente');
            summaryGasEntregue = document.getElementById('summary-gas-entregue');
            summaryGasRecebido = document.getElementById('summary-gas-recebido');
            dashboardMateriaisProntosContainer = document.getElementById('dashboard-materiais-prontos');
            loadingMateriaisProntos = document.getElementById('loading-materiais-prontos');
            dashboardMateriaisListContainer = document.getElementById('dashboard-materiais-list');
            loadingMateriaisDashboard = document.getElementById('loading-materiais-dashboard');

            // Água (Saída)
            formAgua = document.getElementById('form-agua'); 
            selectUnidadeAgua = document.getElementById('select-unidade-agua'); 
            selectTipoAgua = document.getElementById('select-tipo-agua'); 
            inputQtdAgua = document.getElementById('input-qtd-agua'); 
            inputDataAgua = document.getElementById('input-data-agua'); 
            inputResponsavelAgua = document.getElementById('input-responsavel-agua'); 
            btnSubmitAgua = document.getElementById('btn-submit-agua'); 
            alertAgua = document.getElementById('alert-agua'); 
            tableStatusAgua = document.getElementById('table-status-agua'); 
            alertAguaLista = document.getElementById('alert-agua-lista');
            // Água (Previsão)
            selectPrevisaoUnidadeAgua = document.getElementById('select-previsao-unidade-agua'); 
            btnCalcularPrevisaoAgua = document.getElementById('btn-calcular-previsao-agua'); 
            resultadoPrevisaoAgua = document.getElementById('resultado-previsao-agua'); 
            previsaoAguaLabel = document.getElementById('previsao-agua-label'); 
            previsaoAguaMedia = document.getElementById('previsao-agua-media'); 
            previsaoAguaSemanal = document.getElementById('previsao-agua-semanal'); 
            previsaoAguaMensal = document.getElementById('previsao-agua-mensal'); 
            previsaoAguaErro = document.getElementById('previsao-agua-erro');
            
            // Gás (Saída)
            formGas = document.getElementById('form-gas'); 
            selectUnidadeGas = document.getElementById('select-unidade-gas'); 
            selectTipoGas = document.getElementById('select-tipo-gas'); 
            inputQtdGas = document.getElementById('input-qtd-gas'); 
            inputDataGas = document.getElementById('input-data-gas'); 
            inputResponsavelGas = document.getElementById('input-responsavel-gas'); 
            btnSubmitGas = document.getElementById('btn-submit-gas'); 
            alertGas = document.getElementById('alert-gas'); 
            tableStatusGas = document.getElementById('table-status-gas'); 
            alertGasLista = document.getElementById('alert-gas-lista');
            // Gás (Previsão)
            selectPrevisaoUnidadeGas = document.getElementById('select-previsao-unidade-gas'); 
            btnCalcularPrevisaoGas = document.getElementById('btn-calcular-previsao-gas'); 
            resultadoPrevisaoGas = document.getElementById('resultado-previsao-gas'); 
            previsaoGasLabel = document.getElementById('previsao-gas-label'); 
            previsaoGasMedia = document.getElementById('previsao-gas-media'); 
            previsaoGasSemanal = document.getElementById('previsao-gas-semanal'); 
            previsaoGasMensal = document.getElementById('previsao-gas-mensal'); 
            previsaoGasErro = document.getElementById('previsao-gas-erro');

            // Materiais
            formMateriais = document.getElementById('form-materiais'); 
            selectUnidadeMateriais = document.getElementById('select-unidade-materiais'); 
            selectTipoMateriais = document.getElementById('select-tipo-materiais'); 
            inputDataSeparacao = document.getElementById('input-data-separacao'); 
            textareaItensMateriais = document.getElementById('textarea-itens-materiais'); 
            inputResponsavelMateriais = document.getElementById('input-responsavel-materiais'); 
            btnSubmitMateriais = document.getElementById('btn-submit-materiais'); 
            alertMateriais = document.getElementById('alert-materiais'); 
            tableStatusMateriais = document.getElementById('table-status-materiais'); 
            alertMateriaisLista = document.getElementById('alert-materiais-lista');
            
            // Gestão
            tableGestaoUnidades = document.getElementById('table-gestao-unidades'); 
            alertGestao = document.getElementById('alert-gestao'); 
            textareaBulkUnidades = document.getElementById('textarea-bulk-unidades'); 
            btnBulkAddUnidades = document.getElementById('btn-bulk-add-unidades');
            
            // Relatório
            relatorioTipo = document.getElementById('relatorio-tipo'); 
            relatorioDataInicio = document.getElementById('relatorio-data-inicio'); 
            relatorioDataFim = document.getElementById('relatorio-data-fim'); 
            btnGerarPdf = document.getElementById('btn-gerar-pdf'); 
            alertRelatorio = document.getElementById('alert-relatorio');

            // Modal Delete
            confirmDeleteModal = document.getElementById('confirm-delete-modal'); 
            btnCancelDelete = document.getElementById('btn-cancel-delete'); 
            btnConfirmDelete = document.getElementById('btn-confirm-delete'); 
            deleteDetailsEl = document.getElementById('delete-details');
            
            // Estoque Água
            estoqueAguaInicialEl = document.getElementById('estoque-agua-inicial');
            estoqueAguaEntradasEl = document.getElementById('estoque-agua-entradas');
            estoqueAguaSaidasEl = document.getElementById('estoque-agua-saidas');
            estoqueAguaAtualEl = document.getElementById('estoque-agua-atual');
            loadingEstoqueAguaEl = document.getElementById('loading-estoque-agua');
            resumoEstoqueAguaEl = document.getElementById('resumo-estoque-agua');
            formEntradaAgua = document.getElementById('form-entrada-agua');
            inputDataEntradaAgua = document.getElementById('input-data-entrada-agua');
            btnSubmitEntradaAgua = document.getElementById('btn-submit-entrada-agua');
            formInicialAguaContainer = document.getElementById('form-inicial-agua-container');
            formInicialAgua = document.getElementById('form-inicial-agua');
            inputInicialQtdAgua = document.getElementById('input-inicial-qtd-agua');
            inputInicialResponsavelAgua = document.getElementById('input-inicial-responsavel-agua');
            btnSubmitInicialAgua = document.getElementById('btn-submit-inicial-agua');
            alertInicialAgua = document.getElementById('alert-inicial-agua');
            btnAbrirInicialAgua = document.getElementById('btn-abrir-inicial-agua');
            tableHistoricoAgua = document.getElementById('table-historico-agua');
            alertHistoricoAgua = document.getElementById('alert-historico-agua');
            
            // Estoque Gás
            estoqueGasInicialEl = document.getElementById('estoque-gas-inicial');
            estoqueGasEntradasEl = document.getElementById('estoque-gas-entradas');
            estoqueGasSaidasEl = document.getElementById('estoque-gas-saidas');
            estoqueGasAtualEl = document.getElementById('estoque-gas-atual');
            loadingEstoqueGasEl = document.getElementById('loading-estoque-gas');
            resumoEstoqueGasEl = document.getElementById('resumo-estoque-gas');
            formEntradaGas = document.getElementById('form-entrada-gas');
            inputDataEntradaGas = document.getElementById('input-data-entrada-gas');
            btnSubmitEntradaGas = document.getElementById('btn-submit-entrada-gas');
            formInicialGasContainer = document.getElementById('form-inicial-gas-container');
            formInicialGas = document.getElementById('form-inicial-gas');
            inputInicialQtdGas = document.getElementById('input-inicial-qtd-gas');
            inputInicialResponsavelGas = document.getElementById('input-inicial-responsavel-gas');
            btnSubmitInicialGas = document.getElementById('btn-submit-inicial-gas');
            alertInicialGas = document.getElementById('alert-inicial-gas');
            btnAbrirInicialGas = document.getElementById('btn-abrir-inicial-gas');
            tableHistoricoGas = document.getElementById('table-historico-gas');
            alertHistoricoGas = document.getElementById('alert-historico-gas');


            // Define valores iniciais (datas de hoje)
            const todayStr = getTodayDateString();
            if(inputDataAgua) inputDataAgua.value = todayStr; 
            if(inputDataGas) inputDataGas.value = todayStr; 
            if(inputDataSeparacao) inputDataSeparacao.value = todayStr;
            if(relatorioDataInicio) relatorioDataInicio.value = todayStr;
            if(relatorioDataFim) relatorioDataFim.value = todayStr;
            if(inputDataEntradaAgua) inputDataEntradaAgua.value = todayStr; 
            if(inputDataEntradaGas) inputDataEntradaGas.value = todayStr; 


            // --- Adiciona os Event Listeners ---

            // Navegação principal
            navButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
            
            // Navegação interna do Dashboard
            if (dashboardNavControls) dashboardNavControls.addEventListener('click', (e) => {
                const button = e.target.closest('button.dashboard-nav-btn[data-view]');
                if (button) switchDashboardView(button.dataset.view);
            });
            
            // Forms de Saída
            if (formAgua) formAgua.addEventListener('submit', handleAguaSubmit); 
            if (formGas) formGas.addEventListener('submit', handleGasSubmit); 
            if (formMateriais) formMateriais.addEventListener('submit', handleMateriaisSubmit); 
            
            // Listener unificado na <main> para botões de ação nas tabelas (Remover, Entregue)
            document.querySelector('main').addEventListener('click', (e) => {
                 const removeButton = e.target.closest('button.btn-remove[data-id]');
                 const entregueButton = e.target.closest('button.btn-entregue[data-id]');
                 
                 if (removeButton) {
                     // Abre modal de exclusão
                     openConfirmDeleteModal(removeButton.dataset.id, removeButton.dataset.type);
                 } else if (entregueButton) {
                      // Marca material como entregue
                      handleMarcarEntregue(e);
                 }
            });
            
            // Gestão de Unidades
            if (document.getElementById('content-gestao')) {
                document.getElementById('content-gestao').addEventListener('change', handleGestaoToggle);
            }
            if (btnBulkAddUnidades) btnBulkAddUnidades.addEventListener('click', handleBulkAddUnidades);
            
            // Listeners de Previsão
            if(btnCalcularPrevisaoAgua) btnCalcularPrevisaoAgua.addEventListener('click', () => handleCalcularPrevisao('agua'));
            if(btnCalcularPrevisaoGas) btnCalcularPrevisaoGas.addEventListener('click', () => handleCalcularPrevisao('gas'));

            // Listener Relatório PDF
            if (btnGerarPdf) btnGerarPdf.addEventListener('click', handleGerarPdf);

            // Listeners Modal Exclusão
            if (btnCancelDelete) btnCancelDelete.addEventListener('click', () => confirmDeleteModal.style.display = 'none');
            if (btnConfirmDelete) btnConfirmDelete.addEventListener('click', executeDelete);

            // Listeners Abas de Estoque (Entrada/Saída)
            document.querySelectorAll('.form-tab-btn[data-form="saida-agua"]').forEach(btn => btn.addEventListener('click', () => switchEstoqueForm('saida-agua')));
            document.querySelectorAll('.form-tab-btn[data-form="entrada-agua"]').forEach(btn => btn.addEventListener('click', () => switchEstoqueForm('entrada-agua')));
            document.querySelectorAll('.form-tab-btn[data-form="saida-gas"]').forEach(btn => btn.addEventListener('click', () => switchEstoqueForm('saida-gas')));
            document.querySelectorAll('.form-tab-btn[data-form="entrada-gas"]').forEach(btn => btn.addEventListener('click', () => switchEstoqueForm('entrada-gas')));

            // Listeners Forms de Entrada de Estoque
            if (formEntradaAgua) formEntradaAgua.addEventListener('submit', handleEntradaEstoqueSubmit);
            if (formEntradaGas) formEntradaGas.addEventListener('submit', handleEntradaEstoqueSubmit);
            
            // Listeners Forms Iniciais de Estoque
            if (btnAbrirInicialAgua) btnAbrirInicialAgua.addEventListener('click', () => { formInicialAguaContainer.classList.remove('hidden'); btnAbrirInicialAgua.classList.add('hidden'); });
            if (btnAbrirInicialGas) btnAbrirInicialGas.addEventListener('click', () => { formInicialGasContainer.classList.remove('hidden'); btnAbrirInicialGas.classList.add('hidden'); });
            if (formInicialAgua) formInicialAgua.addEventListener('submit', handleInicialEstoqueSubmit);
            if (formInicialGas) formInicialGas.addEventListener('submit', handleInicialEstoqueSubmit);


            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- INICIALIZAÇÃO GERAL ---
        document.addEventListener('DOMContentLoaded', () => { 
            initApp(); // Mapeia o DOM e adiciona listeners
            initFirebase(); // Conecta ao Firebase e inicia listeners de dados
            switchTab('dashboard'); // Começa no dashboard
        });
    </script>
</body>
</html>
